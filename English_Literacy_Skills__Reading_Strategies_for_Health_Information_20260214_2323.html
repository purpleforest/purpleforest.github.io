<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Literacy Skills: Reading Strategies for Health Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> English Literacy Skills: Reading Strategies for Health Information</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Good morning, Maria. Today we are going to focus on improving your literacy skills.","cn":"早上好，玛丽亚。今天我们将重点提高你的读写能力。"},{"en":"Specifically, we will look at reading strategies for health articles.","cn":"具体来说，我们要看看阅读健康文章的策略。"},{"en":"That sounds great, Mr. Evans. I often find medical terms difficult.","cn":"听起来不错，埃文斯先生。我经常觉得医学术语很难。"},{"en":"First, let's review some related vocabularies found in these texts.","cn":"首先，让我们复习一下这些文本中出现的一些相关词汇。"},{"en":"You need to maintain an active lifestyle and ensure good nutrition.","cn":"你需要保持积极的生活方式并确保良好的营养。"},{"en":"Also, yearly physicals and dental checkups are crucial for early detection of problems.","cn":"此外，年度体检和牙科检查对于问题的早期发现至关重要。"},{"en":"I understand. Doctors also ask about heredity to know my family history.","cn":"我明白了。医生也会询问遗传情况以了解我的家族病史。"},{"en":"Exactly. Now, when you read, you must identify the author's purpose.","cn":"没错。现在，当你阅读时，你必须识别作者的意图。"},{"en":"Are they trying to inform you, instruct you, or perhaps persuade you?","cn":"他们是试图告知你、指导你，还是试图说服你？"},{"en":"Sometimes they might write to warn about dangers or to sell a product.","cn":"有时他们写作可能是为了警告危险或推销产品。"},{"en":"How do I distinguish between the topic and the main idea?","cn":"我该如何区分主题和主要观点？"},{"en":"The topic is just a few words, like 'Newcomer Health'.","cn":"主题只有几个词，比如“新移民健康”。"},{"en":"The main idea is the specific point, such as 'Health deteriorates after moving to Canada'.","cn":"主要观点是具体的论点，例如“移居加拿大后健康状况恶化”。"},{"en":"If I want to find specific details quickly, what should I do?","cn":"如果我想快速找到具体细节，我该怎么做？"},{"en":"You should use scanning. Move your eyes quickly and look for keywords.","cn":"你应该使用扫读。快速移动你的眼睛并寻找关键词。"},{"en":"Don't read every word; focus on nouns, verbs, and numbers.","cn":"不要逐字阅读；把重点放在名词、动词和数字上。"},{"en":"What if I encounter a word I don't know?","cn":"如果我遇到不认识的单词怎么办？"},{"en":"Use context clues to make an educated guess.","cn":"利用上下文线索进行有根据的猜测。"},{"en":"Look for direct definitions or examples following words like 'such as'.","cn":"寻找直接定义或跟在像“such as”这样的词后面的例子。"},{"en":"Finally, be careful to separate fact from opinion.","cn":"最后，要注意区分事实和观点。"},{"en":"A fact can be verified with data, while an opinion is a personal belief.","cn":"事实可以用数据验证，而观点是个人的信仰。"},{"en":"Thank you, I will look for signal words to help me decide.","cn":"谢谢，我会寻找信号词来帮助我做决定。"}];
        const knowledgePoints = [{"cat":"Vocabulary","point":"Literacy skills","exTrans":"读写能力","ipa":""},{"cat":"Vocabulary","point":"Active lifestyle","exTrans":"积极的生活方式","ipa":""},{"cat":"Vocabulary","point":"Early detection","exTrans":"早期发现","ipa":""},{"cat":"Vocabulary","point":"Good nutrition","exTrans":"良好的营养","ipa":""},{"cat":"Vocabulary","point":"Heredity","exTrans":"遗传","ipa":""},{"cat":"Vocabulary","point":"Medical screenings","exTrans":"医疗筛查","ipa":""},{"cat":"Vocabulary","point":"Yearly physicals","exTrans":"年度体检","ipa":""},{"cat":"Concept","point":"Author's purpose","exTrans":"作者意图","ipa":""},{"cat":"Vocabulary","point":"To inform","exTrans":"告知","ipa":""},{"cat":"Vocabulary","point":"To instruct","exTrans":"指导","ipa":""},{"cat":"Vocabulary","point":"To persuade","exTrans":"说服","ipa":""},{"cat":"Vocabulary","point":"To warn","exTrans":"警告","ipa":""},{"cat":"Vocabulary","point":"To sell","exTrans":"推销","ipa":""},{"cat":"Concept","point":"Main idea","exTrans":"主要观点","ipa":""},{"cat":"Technique","point":"Scanning","exTrans":"扫读","ipa":""},{"cat":"Vocabulary","point":"Specific details","exTrans":"具体细节","ipa":""},{"cat":"Vocabulary","point":"Context clues","exTrans":"上下文线索","ipa":""},{"cat":"Phrase","point":"Educated guess","exTrans":"有根据的猜测","ipa":""},{"cat":"Concept","point":"Direct definition","exTrans":"直接定义","ipa":""},{"cat":"Vocabulary","point":"Typography","exTrans":"排版/字体排印","ipa":""},{"cat":"Vocabulary","point":"Bold text","exTrans":"粗体文本","ipa":""},{"cat":"Text Feature","point":"Table of Contents","exTrans":"目录","ipa":""},{"cat":"Text Feature","point":"Bullet points","exTrans":"要点/符号列表","ipa":""},{"cat":"Text Feature","point":"Captions","exTrans":"说明文字","ipa":""},{"cat":"Concept","point":"Fact vs. Opinion","exTrans":"事实与观点","ipa":""},{"cat":"Vocabulary","point":"Verifiable","exTrans":"可验证的","ipa":""},{"cat":"Vocabulary","point":"Subjective","exTrans":"主观的","ipa":""},{"cat":"Concept","point":"Signal words","exTrans":"信号词","ipa":""},{"cat":"Vocabulary","point":"Reliable source","exTrans":"可靠来源","ipa":""},{"cat":"Vocabulary","point":"Credibility","exTrans":"可信度","ipa":""}];
        const cultureData = [{"en":"In Canada, 'health literacy' is considered a vital skill. It involves the ability to access, understand, evaluate, and communicate information to promote, maintain, and improve health. Canadian healthcare providers often encourage patients to ask questions and take an active role in their own care. Understanding the difference between fact-based medical advice and opinions found online is crucial for navigating the Canadian healthcare system efficiently.","cn":"在加拿大，“健康素养”被视为一项至关重要的技能。它涉及获取、理解、评估和交流信息的能力，以此来促进、维持和改善健康。加拿大的医疗服务提供者通常鼓励患者提问，并在自己的医疗护理中发挥积极作用。了解基于事实的医疗建议与网络上的观点之间的区别，对于有效利用加拿大医疗体系至关重要。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"Literacy skills (n.) /ˈlɪtərəsi skɪlz/","back":"读写能力"},{"front":"Active lifestyle (n.) /ˈæktɪv ˈlaɪfˌstaɪl/","back":"积极的生活方式"},{"front":"Early detection (n.) /ˈɜrli dɪˈtɛkʃən/","back":"早期发现"},{"front":"Good nutrition (n.) /gʊd nuˈtrɪʃən/","back":"良好的营养"},{"front":"Heredity (n.) /həˈrɛdɪti/","back":"遗传"},{"front":"Medical screenings (n.) /ˈmɛdɪkəl ˈskrinɪŋz/","back":"医疗筛查"},{"front":"Yearly physicals (n.) /ˈjɪrli ˈfɪzɪkəlz/","back":"年度体检"},{"front":"Author's purpose (n.) /ˈɔθərz ˈpɜrpəs/","back":"作者意图"},{"front":"To inform (v.) /tu ɪnˈfɔrm/","back":"告知"},{"front":"To instruct (v.) /tu ɪnˈstrʌkt/","back":"指导"},{"front":"To persuade (v.) /tu pərˈsweɪd/","back":"说服"},{"front":"To warn (v.) /tu wɔrn/","back":"警告"},{"front":"To sell (v.) /tu sɛl/","back":"推销"},{"front":"Main idea (n.) /meɪn aɪˈdiə/","back":"主要观点"},{"front":"Scanning (n.) /ˈskænɪŋ/","back":"扫读"},{"front":"Specific details (n.) /spəˈsɪfɪk dɪˈteɪlz/","back":"具体细节"},{"front":"Context clues (n.) /ˈkɑntɛkst kluz/","back":"上下文线索"},{"front":"Educated guess (n.) /ˈɛʤəˌkeɪtəd gɛs/","back":"有根据的猜测"},{"front":"Direct definition (n.) /dəˈrɛkt ˌdɛfəˈnɪʃən/","back":"直接定义"},{"front":"Typography (n.) /taɪˈpɑgrəfi/","back":"排版/字体排印"},{"front":"Bold text (n.) /boʊld tɛkst/","back":"粗体文本"},{"front":"Table of Contents (n.) /ˈteɪbəl ʌv ˈkɑntɛnts/","back":"目录"},{"front":"Bullet points (n.) /ˈbʊlət pɔɪnts/","back":"要点/符号列表"},{"front":"Captions (n.) /ˈkæpʃənz/","back":"说明文字"},{"front":"Fact vs. Opinion (phr.) /fækt ˈvɜrsəs əˈpɪnjən/","back":"事实与观点"},{"front":"Verifiable (adj.) /ˈvɛrəˌfaɪəbəl/","back":"可验证的"},{"front":"Subjective (adj.) /səbˈʤɛktɪv/","back":"主观的"},{"front":"Signal words (n.) /ˈsɪgnəl wɜrdz/","back":"信号词"},{"front":"Reliable source (n.) /rɪˈlaɪəbəl sɔrs/","back":"可靠来源"},{"front":"Credibility (n.) /ˌkrɛdəˈbɪlɪti/","back":"可信度"}],"group_2":[{"front":"读写能力","back":"Literacy skills (n.) /ˈlɪtərəsi skɪlz/"},{"front":"积极的生活方式","back":"Active lifestyle (n.) /ˈæktɪv ˈlaɪfˌstaɪl/"},{"front":"早期发现","back":"Early detection (n.) /ˈɜrli dɪˈtɛkʃən/"},{"front":"良好的营养","back":"Good nutrition (n.) /gʊd nuˈtrɪʃən/"},{"front":"遗传","back":"Heredity (n.) /həˈrɛdɪti/"},{"front":"医疗筛查","back":"Medical screenings (n.) /ˈmɛdɪkəl ˈskrinɪŋz/"},{"front":"年度体检","back":"Yearly physicals (n.) /ˈjɪrli ˈfɪzɪkəlz/"},{"front":"作者意图","back":"Author's purpose (n.) /ˈɔθərz ˈpɜrpəs/"},{"front":"告知","back":"To inform (v.) /tu ɪnˈfɔrm/"},{"front":"指导","back":"To instruct (v.) /tu ɪnˈstrʌkt/"},{"front":"说服","back":"To persuade (v.) /tu pərˈsweɪd/"},{"front":"警告","back":"To warn (v.) /tu wɔrn/"},{"front":"推销","back":"To sell (v.) /tu sɛl/"},{"front":"主要观点","back":"Main idea (n.) /meɪn aɪˈdiə/"},{"front":"扫读","back":"Scanning (n.) /ˈskænɪŋ/"},{"front":"具体细节","back":"Specific details (n.) /spəˈsɪfɪk dɪˈteɪlz/"},{"front":"上下文线索","back":"Context clues (n.) /ˈkɑntɛkst kluz/"},{"front":"有根据的猜测","back":"Educated guess (n.) /ˈɛʤəˌkeɪtəd gɛs/"},{"front":"直接定义","back":"Direct definition (n.) /dəˈrɛkt ˌdɛfəˈnɪʃən/"},{"front":"排版/字体排印","back":"Typography (n.) /taɪˈpɑgrəfi/"},{"front":"粗体文本","back":"Bold text (n.) /boʊld tɛkst/"},{"front":"目录","back":"Table of Contents (n.) /ˈteɪbəl ʌv ˈkɑntɛnts/"},{"front":"要点/符号列表","back":"Bullet points (n.) /ˈbʊlət pɔɪnts/"},{"front":"说明文字","back":"Captions (n.) /ˈkæpʃənz/"},{"front":"事实与观点","back":"Fact vs. Opinion (phr.) /fækt ˈvɜrsəs əˈpɪnjən/"},{"front":"可验证的","back":"Verifiable (adj.) /ˈvɛrəˌfaɪəbəl/"},{"front":"主观的","back":"Subjective (adj.) /səbˈʤɛktɪv/"},{"front":"信号词","back":"Signal words (n.) /ˈsɪgnəl wɜrdz/"},{"front":"可靠来源","back":"Reliable source (n.) /rɪˈlaɪəbəl sɔrs/"},{"front":"可信度","back":"Credibility (n.) /ˌkrɛdəˈbɪlɪti/"}],"group_3":[{"front":"Improving your literacy skills helps you understand complex documents.","back":"提高你的读写能力有助于你理解复杂的文件。"},{"front":"Hiking and swimming are part of an active lifestyle.","back":"徒步旅行和游泳是积极生活方式的一部分。"},{"front":"Early detection of the disease increased his chances of recovery.","back":"疾病的早期发现增加了他康复的几率。"},{"front":"Eating vegetables ensures good nutrition for growing children.","back":"吃蔬菜能保证成长中的儿童获得良好的营养。"},{"front":"Eye color is determined by heredity.","back":"眼睛的颜色是由遗传决定的。"},{"front":"Regular medical screenings can catch health issues early.","back":"定期的医疗筛查可以及早发现健康问题。"},{"front":"She schedules yearly physicals to monitor her blood pressure.","back":"她安排年度体检来监测她的血压。"},{"front":"Identifying the author's purpose helps you judge if the text is biased.","back":"识别作者的意图有助于你判断文章是否有偏见。"},{"front":"The brochure was written to inform tourists about local laws.","back":"这本小册子是为了告知游客当地的法律。"},{"front":"The manual is designed to instruct users on how to assemble the table.","back":"本手册旨在指导用户如何组装桌子。"},{"front":"The politician tried to persuade the voters to support him.","back":"这位政治家试图说服选民支持他。"},{"front":"The sign serves to warn drivers of the sharp turn ahead.","back":"该标志用于警告司机前方有急转弯。"},{"front":"The commercial's goal is to sell the new smartphone.","back":"这则广告的目标是推销新款智能手机。"},{"front":"The main idea of the paragraph is that exercise reduces stress.","back":"这段话的主要观点是运动可以减轻压力。"},{"front":"I am scanning the train schedule to find the departure time.","back":"我正在扫读列车时刻表以查找发车时间。"},{"front":"Please pay attention to the specific details in the contract.","back":"请注意合同中的具体细节。"},{"front":"You can guess the meaning of 'frigid' by using context clues like 'snow' and 'ice'.","back":"你可以利用像“雪”和“冰”这样的上下文线索来猜测“frigid”（寒冷）的意思。"},{"front":"Based on the clouds, my educated guess is that it will rain soon.","back":"根据云层情况，我有根据地猜测很快就会下雨。"},{"front":"The textbook provided a direct definition of the scientific term.","back":"教科书提供了该科学术语的直接定义。"},{"front":"The article uses bold typography to highlight key terms.","back":"这篇文章使用粗体排版来突出关键术语。"},{"front":"Pay attention to the bold text because it contains important information.","back":"注意粗体文本，因为它包含重要信息。"},{"front":"Check the Table of Contents to see which chapter covers grammar.","back":"查看目录，看看哪一章涵盖了语法。"},{"front":"Use bullet points to make the list easier to read.","back":"使用符号列表使列表更易于阅读。"},{"front":"The captions under the photos explain who the people are.","back":"照片下方的说明文字解释了这些人是谁。"},{"front":"Critical thinking requires distinguishing between fact vs. opinion.","back":"批判性思维需要区分事实与观点。"},{"front":"The height of the mountain is a verifiable fact.","back":"这座山的高度是一个可验证的事实。"},{"front":"Taste is subjective; what I like, you might hate.","back":"口味是主观的；我喜欢的，你可能讨厌。"},{"front":"Words like 'however' and 'therefore' are signal words that show the structure of an argument.","back":"像“however”和“therefore”这样的词是显示论证结构的信号词。"},{"front":"Always check if the health advice comes from a reliable source.","back":"务必检查健康建议是否来自可靠来源。"},{"front":"The typos in the article damaged the author's credibility.","back":"文章中的拼写错误损害了作者的可信度。"}],"group_4":[{"front":"提高你的读写能力有助于你理解复杂的文件。","back":"Improving your literacy skills helps you understand complex documents."},{"front":"徒步旅行和游泳是积极生活方式的一部分。","back":"Hiking and swimming are part of an active lifestyle."},{"front":"疾病的早期发现增加了他康复的几率。","back":"Early detection of the disease increased his chances of recovery."},{"front":"吃蔬菜能保证成长中的儿童获得良好的营养。","back":"Eating vegetables ensures good nutrition for growing children."},{"front":"眼睛的颜色是由遗传决定的。","back":"Eye color is determined by heredity."},{"front":"定期的医疗筛查可以及早发现健康问题。","back":"Regular medical screenings can catch health issues early."},{"front":"她安排年度体检来监测她的血压。","back":"She schedules yearly physicals to monitor her blood pressure."},{"front":"识别作者的意图有助于你判断文章是否有偏见。","back":"Identifying the author's purpose helps you judge if the text is biased."},{"front":"这本小册子是为了告知游客当地的法律。","back":"The brochure was written to inform tourists about local laws."},{"front":"本手册旨在指导用户如何组装桌子。","back":"The manual is designed to instruct users on how to assemble the table."},{"front":"这位政治家试图说服选民支持他。","back":"The politician tried to persuade the voters to support him."},{"front":"该标志用于警告司机前方有急转弯。","back":"The sign serves to warn drivers of the sharp turn ahead."},{"front":"这则广告的目标是推销新款智能手机。","back":"The commercial's goal is to sell the new smartphone."},{"front":"这段话的主要观点是运动可以减轻压力。","back":"The main idea of the paragraph is that exercise reduces stress."},{"front":"我正在扫读列车时刻表以查找发车时间。","back":"I am scanning the train schedule to find the departure time."},{"front":"请注意合同中的具体细节。","back":"Please pay attention to the specific details in the contract."},{"front":"你可以利用像“雪”和“冰”这样的上下文线索来猜测“frigid”（寒冷）的意思。","back":"You can guess the meaning of 'frigid' by using context clues like 'snow' and 'ice'."},{"front":"根据云层情况，我有根据地猜测很快就会下雨。","back":"Based on the clouds, my educated guess is that it will rain soon."},{"front":"教科书提供了该科学术语的直接定义。","back":"The textbook provided a direct definition of the scientific term."},{"front":"这篇文章使用粗体排版来突出关键术语。","back":"The article uses bold typography to highlight key terms."},{"front":"注意粗体文本，因为它包含重要信息。","back":"Pay attention to the bold text because it contains important information."},{"front":"查看目录，看看哪一章涵盖了语法。","back":"Check the Table of Contents to see which chapter covers grammar."},{"front":"使用符号列表使列表更易于阅读。","back":"Use bullet points to make the list easier to read."},{"front":"照片下方的说明文字解释了这些人是谁。","back":"The captions under the photos explain who the people are."},{"front":"批判性思维需要区分事实与观点。","back":"Critical thinking requires distinguishing between fact vs. opinion."},{"front":"这座山的高度是一个可验证的事实。","back":"The height of the mountain is a verifiable fact."},{"front":"口味是主观的；我喜欢的，你可能讨厌。","back":"Taste is subjective; what I like, you might hate."},{"front":"像“however”和“therefore”这样的词是显示论证结构的信号词。","back":"Words like 'however' and 'therefore' are signal words that show the structure of an argument."},{"front":"务必检查健康建议是否来自可靠来源。","back":"Always check if the health advice comes from a reliable source."},{"front":"文章中的拼写错误损害了作者的可信度。","back":"The typos in the article damaged the author's credibility."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What is the main topic of the conversation?","options":["A. How to become a doctor","B. Reading strategies for health information","C. The history of Canadian healthcare"],"ans":"B. Reading strategies for health information"},{"type":"tf","q":"An active lifestyle means sitting around and relaxing.","options":["True","False"],"ans":"False"},{"type":"fill","q":"To find specific details quickly without reading every word, you should use ______.","options":[],"ans":"scanning"},{"type":"mc","q":"Which of the following is NOT mentioned as an author's purpose?","options":["A. To inform","B. To confuse","C. To persuade"],"ans":"B. To confuse"},{"type":"dict","q":"Listen and write the missing word: 'Yearly ______ are checkups with a doctor every year.'","options":[],"ans":"physicals","srcText":"physicals"},{"type":"mc","q":"According to the dialogue, what is a 'fact'?","options":["A. A personal belief","B. Something that can be verified","C. A judgment adjective"],"ans":"B. Something that can be verified"},{"type":"tf","q":"Heredity refers to characteristics you get from your friends.","options":["True","False"],"ans":"False"},{"type":"fill","q":"If you don't know a word, you should use ______ clues to guess the meaning.","options":[],"ans":"context"},{"type":"mc","q":"What is the difference between a Topic and a Main Idea?","options":["A. The topic is longer than the main idea.","B. The topic is the specific point; the main idea is general.","C. The topic is what reading is generally about; the main idea is the specific point."],"ans":"C. The topic is what reading is generally about; the main idea is the specific point."},{"type":"dict","q":"Listen and write the missing phrase: 'Sugar contributes to ______.'","options":[],"ans":"obesity","srcText":"obesity"}]; 
        let vocabQuestions = [{"type":"mc","q":"Which term describes the ability to read, understand, and use information?","options":["A. Heredity","B. Literacy skills","C. Typography"],"ans":"B. Literacy skills"},{"type":"fill","q":"Hiking and playing sports are examples of an ______ ______.","options":[],"ans":"active lifestyle"},{"type":"mc","q":"What is the benefit of 'early detection'?","options":["A. Finding a problem before it becomes big","B. Ignoring a problem until it disappears","C. Visiting the dentist once every ten years"],"ans":"A. Finding a problem before it becomes big"},{"type":"fill","q":"Eating fruits and vegetables is essential for ______ ______.","options":[],"ans":"good nutrition"},{"type":"mc","q":"Which word refers to characteristics passed down from your family?","options":["A. Subjective","B. Heredity","C. Captions"],"ans":"B. Heredity"},{"type":"fill","q":"Tests to look for health problems are called ______ ______.","options":[],"ans":"medical screenings"},{"type":"mc","q":"What is a checkup with a doctor that happens every year?","options":["A. Yearly physicals","B. Daily routine","C. Urgent care"],"ans":"A. Yearly physicals"},{"type":"fill","q":"Understanding the ______ ______ helps you know why the text exists.","options":[],"ans":"author's purpose"},{"type":"mc","q":"If an author writes to provide factual information, their purpose is ______.","options":["A. To warn","B. To sell","C. To inform"],"ans":"C. To inform"},{"type":"fill","q":"A manual explaining how to fix a car is written ______ ______.","options":[],"ans":"to instruct"},{"type":"mc","q":"If a writer wants to convince you to adopt a belief, they are trying ______.","options":["A. To persuade","B. To scan","C. To instruct"],"ans":"A. To persuade"},{"type":"fill","q":"A sign saying 'Danger: High Voltage' is written ______ ______.","options":[],"ans":"to warn"},{"type":"mc","q":"Advertisements are primarily written ______.","options":["A. To sell","B. To instruct","C. To warn"],"ans":"A. To sell"},{"type":"fill","q":"The specific point the writer wants to make is called the ______ ______.","options":[],"ans":"main idea"},{"type":"mc","q":"What reading technique involves moving your eyes quickly to find specific info?","options":["A. Scanning","B. Critical thinking","C. Typography"],"ans":"A. Scanning"},{"type":"fill","q":"When scanning, you are looking for ______ ______ like dates or names.","options":[],"ans":"specific details"},{"type":"mc","q":"Using surrounding words to guess a meaning involves using ______.","options":["A. Context clues","B. Bullet points","C. Heredity"],"ans":"A. Context clues"},{"type":"fill","q":"Making a logical guess based on evidence is called an ______ ______.","options":[],"ans":"educated guess"},{"type":"mc","q":"When a text explains a word using 'which means', it is providing a ______.","options":["A. Direct definition","B. Hidden meaning","C. Personal opinion"],"ans":"A. Direct definition"},{"type":"fill","q":"The style and appearance of text (like bold or italics) is called ______.","options":[],"ans":"typography"},{"type":"mc","q":"Darker, heavy text used to highlight key terms is called ______.","options":["A. Bold text","B. Invisible ink","C. Standard font"],"ans":"A. Bold text"},{"type":"fill","q":"The list of chapters at the beginning of a book is the ______ ______ ______.","options":[],"ans":"Table of Contents"},{"type":"mc","q":"Which text feature is used to break down lists for easier reading?","options":["A. Captions","B. Bullet points","C. Opinions"],"ans":"B. Bullet points"},{"type":"fill","q":"The text under a picture explaining what is happening is a ______.","options":[],"ans":"caption"},{"type":"mc","q":"Distinguishing between something verifiable and a belief is separating ______.","options":["A. Fact vs. Opinion","B. Topic vs. Main Idea","C. Bold vs. Italics"],"ans":"A. Fact vs. Opinion"},{"type":"fill","q":"If something can be proven with data, it is ______.","options":[],"ans":"verifiable"},{"type":"mc","q":"An opinion is ______, meaning it varies from person to person.","options":["A. Verifiable","B. Subjective","C. Factual"],"ans":"B. Subjective"},{"type":"fill","q":"Words like 'believe', 'think', or 'prove' are called ______ ______.","options":[],"ans":"signal words"},{"type":"mc","q":"A source of information that can be trusted is a ______.","options":["A. Reliable source","B. Subjective opinion","C. Scanning tool"],"ans":"A. Reliable source"},{"type":"fill","q":"If information is accurate and trustworthy, the author has high ______.","options":[],"ans":"credibility"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = (dialogueData[index].en || '').trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${(k.point || '').replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${(q.srcText || '').replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>