<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Mastery: Stress Management & Writing Skills</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> English Mastery: Stress Management & Writing Skills</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Are you feeling stressed about the new project?","cn":"你对新项目感到有压力吗？"},{"en":"Yes, I am very anxious and find it difficult to concentrate.","cn":"是的，我非常焦虑，发现很难集中注意力。"},{"en":"When I am tense, I often oversleep in the mornings.","cn":"当我紧绷的时候，我早上经常睡过头。"},{"en":"You need to find healthy ways to relax and cope with the pressure.","cn":"你需要找到健康的方式来放松并应对压力。"},{"en":"Deep breathing exercises can help reduce your nervousness.","cn":"深呼吸练习可以帮助减轻你的紧张感。"},{"en":"I try to exercise regularly to maintain my physical health.","cn":"我尽量规律地锻炼以保持身体健康。"},{"en":"Unmanaged stress can definitely lead to severe illnesses.","cn":"未加控制的压力绝对会导致严重的疾病。"},{"en":"Yesterday, I had a bad reaction when the schedule changed.","cn":"昨天，当日程改变时我产生了糟糕的反应。"},{"en":"I started to lose my temper and criticized my coworker.","cn":"我开始发脾气并批评了我的同事。"},{"en":"Now I feel a lot of regret about my unprofessional behavior.","cn":"现在我对我不专业的行为感到非常遗憾。"},{"en":"You should write an informal email to him to apologize.","cn":"你应该给他写一封非正式电子邮件来道歉。"},{"en":"Make sure the subject line clearly states your intention.","cn":"确保主题行清楚地说明你的意图。"},{"en":"Start with a friendly greeting and a polite opening.","cn":"以友好的问候和礼貌的开场白开始。"},{"en":"Keep a casual tone throughout the body of the message.","cn":"在信息的正文中始终保持随意的语气。"},{"en":"Use short paragraphs to significantly improve the readability.","cn":"使用短段落来显著提高可读性。"},{"en":"Add clear transitions so your ideas connect smoothly.","cn":"添加清晰的过渡，使你的想法连接顺畅。"},{"en":"A simple sentence is great for stating a direct fact.","cn":"简单句非常适合陈述直接的事实。"},{"en":"You can use a compound sentence to link related concepts.","cn":"你可以使用并列句来连接相关的概念。"},{"en":"A complex sentence helps to explain your detailed thoughts.","cn":"复合句有助于解释你详细的想法。"},{"en":"Always remember to check your capitalization rules.","cn":"永远记得检查你的大写规则。"},{"en":"Accurate punctuation is essential for clear communication.","cn":"准确的标点符号对于清晰的沟通至关重要。"},{"en":"Use an apostrophe correctly to show possession.","cn":"正确使用撇号来表示所有格。"},{"en":"Avoid using an exclamation mark if the topic is serious.","cn":"如果话题很严肃，避免使用感叹号。"},{"en":"You can wrap up the email with a smooth concluding sentence.","cn":"你可以用一个流畅的总结句来圆满结束这封邮件。"},{"en":"Finally, sign off warmly to show you are sincere.","cn":"最后，热情地写上结束语以显示你的真诚。"}];
        const knowledgePoints = [{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Phrase","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Idiom","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Vocabulary","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Concept","ipa":""},{"cat":"Phrase","ipa":""},{"cat":"Phrase","ipa":""}];
        const cultureData = [{"en":"In modern Western workplaces, acknowledging stress and taking steps to manage mental health is encouraged. If stress leads to unprofessional behavior, such as losing one's temper, a prompt and sincere apology is expected to maintain healthy working relationships. Informal emails are standard for communication among colleagues. While they use a casual tone, they still follow strict rules for paragraph structure, clear transitions, and accurate punctuation to ensure professionalism and readability.","cn":"在现代西方职场中，鼓励员工正视压力并采取措施管理心理健康。如果压力导致了不专业的行为（如发脾气），员工通常需要迅速真诚地道歉以维护健康的职场关系。非正式电子邮件是同事间沟通的标准方式。虽然它们使用随意的语气，但仍需遵循段落结构、清晰过渡和准确标点符号的严格规则，以确保专业性和可读性。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"stressed (adj.) /strɛst/","back":"感到有压力的"},{"front":"anxious (adj.) /ˈæŋkʃəs/","back":"焦虑的"},{"front":"concentrate (v.) /ˈkɑːnsəntreɪt/","back":"集中注意力"},{"front":"tense (adj.) /tɛns/","back":"紧张的；紧绷的"},{"front":"oversleep (v.) /ˌoʊvərˈsliːp/","back":"睡过头"},{"front":"relax (v.) /rɪˈlæks/","back":"放松"},{"front":"cope with (phr. v.) /koʊp wɪð/","back":"应对；处理"},{"front":"breathing (n.) /ˈbriːðɪŋ/","back":"呼吸"},{"front":"nervousness (n.) /ˈnɜːrvəsnəs/","back":"紧张"},{"front":"regularly (adv.) /ˈrɛɡjələrli/","back":"规律地"},{"front":"illness (n.) /ˈɪlnəs/","back":"疾病"},{"front":"reaction (n.) /riˈækʃən/","back":"反应"},{"front":"lose one's temper (idiom) /luːz wʌnz ˈtɛmpər/","back":"发脾气"},{"front":"criticize (v.) /ˈkrɪtɪsaɪz/","back":"批评"},{"front":"regret (n./v.) /rɪˈɡrɛt/","back":"后悔；遗憾"},{"front":"informal email (n.) /ɪnˈfɔːrməl ˈiːmeɪl/","back":"非正式电子邮件"},{"front":"subject line (n.) /ˈsʌbdʒɪkt laɪn/","back":"主题行"},{"front":"greeting (n.) /ˈɡriːtɪŋ/","back":"问候"},{"front":"opening (n.) /ˈoʊpənɪŋ/","back":"开场白"},{"front":"casual tone (n.) /ˈkæʒuəl toʊn/","back":"随意的语气"},{"front":"body (n.) /ˈbɑːdi/","back":"正文"},{"front":"readability (n.) /ˌriːdəˈbɪləti/","back":"可读性"},{"front":"transition (n.) /trænˈzɪʃən/","back":"过渡"},{"front":"simple sentence (n.) /ˈsɪmpəl ˈsɛntəns/","back":"简单句"},{"front":"compound sentence (n.) /ˈkɑːmpaʊnd ˈsɛntəns/","back":"并列句"},{"front":"complex sentence (n.) /kəmˈplɛks ˈsɛntəns/","back":"复合句"},{"front":"capitalization (n.) /ˌkæpɪtəlaɪˈzeɪʃən/","back":"大写"},{"front":"punctuation (n.) /ˌpʌŋktʃuˈeɪʃən/","back":"标点符号"},{"front":"apostrophe (n.) /əˈpɑːstrəfi/","back":"撇号"},{"front":"possession (n.) /pəˈzɛʃən/","back":"所有格；拥有"},{"front":"exclamation mark (n.) /ˌɛkskləˈmeɪʃən mɑːrk/","back":"感叹号"},{"front":"wrap up (phr. v.) /ræp ʌp/","back":"圆满结束；总结"},{"front":"sign off (phr. v.) /saɪn ɔːf/","back":"结束语；签名离开"}],"group_2":[{"front":"感到有压力的","back":"stressed (adj.) /strɛst/"},{"front":"焦虑的","back":"anxious (adj.) /ˈæŋkʃəs/"},{"front":"集中注意力","back":"concentrate (v.) /ˈkɑːnsəntreɪt/"},{"front":"紧张的；紧绷的","back":"tense (adj.) /tɛns/"},{"front":"睡过头","back":"oversleep (v.) /ˌoʊvərˈsliːp/"},{"front":"放松","back":"relax (v.) /rɪˈlæks/"},{"front":"应对；处理","back":"cope with (phr. v.) /koʊp wɪð/"},{"front":"呼吸","back":"breathing (n.) /ˈbriːðɪŋ/"},{"front":"紧张","back":"nervousness (n.) /ˈnɜːrvəsnəs/"},{"front":"规律地","back":"regularly (adv.) /ˈrɛɡjələrli/"},{"front":"疾病","back":"illness (n.) /ˈɪlnəs/"},{"front":"反应","back":"reaction (n.) /riˈækʃən/"},{"front":"发脾气","back":"lose one's temper (idiom) /luːz wʌnz ˈtɛmpər/"},{"front":"批评","back":"criticize (v.) /ˈkrɪtɪsaɪz/"},{"front":"后悔；遗憾","back":"regret (n./v.) /rɪˈɡrɛt/"},{"front":"非正式电子邮件","back":"informal email (n.) /ɪnˈfɔːrməl ˈiːmeɪl/"},{"front":"主题行","back":"subject line (n.) /ˈsʌbdʒɪkt laɪn/"},{"front":"问候","back":"greeting (n.) /ˈɡriːtɪŋ/"},{"front":"开场白","back":"opening (n.) /ˈoʊpənɪŋ/"},{"front":"随意的语气","back":"casual tone (n.) /ˈkæʒuəl toʊn/"},{"front":"正文","back":"body (n.) /ˈbɑːdi/"},{"front":"可读性","back":"readability (n.) /ˌriːdəˈbɪləti/"},{"front":"过渡","back":"transition (n.) /trænˈzɪʃən/"},{"front":"简单句","back":"simple sentence (n.) /ˈsɪmpəl ˈsɛntəns/"},{"front":"并列句","back":"compound sentence (n.) /ˈkɑːmpaʊnd ˈsɛntəns/"},{"front":"复合句","back":"complex sentence (n.) /kəmˈplɛks ˈsɛntəns/"},{"front":"大写","back":"capitalization (n.) /ˌkæpɪtəlaɪˈzeɪʃən/"},{"front":"标点符号","back":"punctuation (n.) /ˌpʌŋktʃuˈeɪʃən/"},{"front":"撇号","back":"apostrophe (n.) /əˈpɑːstrəfi/"},{"front":"所有格；拥有","back":"possession (n.) /pəˈzɛʃən/"},{"front":"感叹号","back":"exclamation mark (n.) /ˌɛkskləˈmeɪʃən mɑːrk/"},{"front":"圆满结束；总结","back":"wrap up (phr. v.) /ræp ʌp/"},{"front":"结束语；签名离开","back":"sign off (phr. v.) /saɪn ɔːf/"}],"group_3":[{"front":"She is stressed about her upcoming final exams.","back":"她对即将到来的期末考试感到有压力。"},{"front":"He felt anxious while waiting for the test results.","back":"在等待测试结果时，他感到很焦虑。"},{"front":"It is hard to concentrate on reading when the TV is loud.","back":"电视声音很大时很难集中注意力看书。"},{"front":"His neck muscles were tense after driving for six hours.","back":"开了六个小时车后，他的颈部肌肉很紧绷。"},{"front":"Set an alarm so you do not oversleep tomorrow morning.","back":"定个闹钟，这样你明早才不会睡过头。"},{"front":"Listening to classical music helps me relax after work.","back":"听古典音乐帮助我在下班后放松。"},{"front":"She learned effective strategies to cope with customer complaints.","back":"她学到了应对客户投诉的有效策略。"},{"front":"His breathing was heavy after running the marathon.","back":"跑完马拉松后他的呼吸很沉重。"},{"front":"Her nervousness disappeared once she stepped onto the stage.","back":"她一走上舞台，紧张感就消失了。"},{"front":"The software should be updated regularly for better security.","back":"该软件应规律地更新以获得更好的安全性。"},{"front":"He missed a week of school due to a sudden illness.","back":"由于突发疾病，他缺了一周的课。"},{"front":"Her initial reaction to the surprise party was pure joy.","back":"她对惊喜派对的最初反应是纯粹的喜悦。"},{"front":"A good manager knows how to guide the team without losing his temper.","back":"一个好经理知道如何引导团队而不发脾气。"},{"front":"It is better to offer solutions rather than just criticize the plan.","back":"与其仅仅批评计划，不如提供解决方案。"},{"front":"I regret not learning how to play the piano when I was younger.","back":"我后悔年轻时没有学习弹钢琴。"},{"front":"She sent an informal email to invite her friends for dinner.","back":"她发了一封非正式电子邮件邀请朋友们共进晚餐。"},{"front":"A descriptive subject line ensures the recipient opens the email quickly.","back":"描述性的主题行能确保收件人迅速打开邮件。"},{"front":"Always include a polite greeting before stating your main request.","back":"在陈述主要请求之前，务必包含礼貌的问候。"},{"front":"The speaker's opening immediately captured the audience's attention.","back":"演讲者的开场白立刻吸引了观众的注意力。"},{"front":"A casual tone is appropriate when messaging your close colleagues.","back":"给亲密的同事发信息时，使用随意的语气是合适的。"},{"front":"The body of your essay must contain strong supporting evidence.","back":"你文章的正文必须包含强有力的支持证据。"},{"front":"Using simple words and bullet points enhances the document's readability.","back":"使用简单的词汇和要点可以提高文档的可读性。"},{"front":"The transition between the first and second chapter was seamless.","back":"第一章和第二章之间的过渡天衣无缝。"},{"front":"A simple sentence conveys one clear idea without confusing the reader.","back":"简单句传达一个清晰的想法，不会让读者感到困惑。"},{"front":"He wanted to go to the park, but it started raining is a compound sentence.","back":"‘他想去公园，但是开始下雨了’是一个并列句。"},{"front":"Because she studied hard, she passed the exam is an example of a complex sentence.","back":"‘因为她努力学习，所以她通过了考试’是复合句的一个例子。"},{"front":"Check the capitalization of the city names in your final draft.","back":"在你的最终草稿中检查城市名称的大写。"},{"front":"Bad punctuation can completely change the meaning of a sentence.","back":"糟糕的标点符号会彻底改变一个句子的意思。"},{"front":"Do not forget the apostrophe when you write words like 'can't'.","back":"写‘can't’这样的词时不要忘记撇号。"},{"front":"Adding an 's' to the end of a noun indicates possession.","back":"在名词末尾加上‘s’表示所有格。"},{"front":"An exclamation mark is used to express strong emotion or surprise.","back":"感叹号用于表达强烈的情感或惊讶。"},{"front":"Let's wrap up the meeting so everyone can go to lunch.","back":"让我们圆满结束会议，以便大家去吃午餐。"},{"front":"He chose to sign off his letter with the words 'Best regards'.","back":"他选择用‘诚挚的问候’作为他信件的结束语。"}],"group_4":[{"front":"她对即将到来的期末考试感到有压力。","back":"She is stressed about her upcoming final exams."},{"front":"在等待测试结果时，他感到很焦虑。","back":"He felt anxious while waiting for the test results."},{"front":"电视声音很大时很难集中注意力看书。","back":"It is hard to concentrate on reading when the TV is loud."},{"front":"开了六个小时车后，他的颈部肌肉很紧绷。","back":"His neck muscles were tense after driving for six hours."},{"front":"定个闹钟，这样你明早才不会睡过头。","back":"Set an alarm so you do not oversleep tomorrow morning."},{"front":"听古典音乐帮助我在下班后放松。","back":"Listening to classical music helps me relax after work."},{"front":"她学到了应对客户投诉的有效策略。","back":"She learned effective strategies to cope with customer complaints."},{"front":"跑完马拉松后他的呼吸很沉重。","back":"His breathing was heavy after running the marathon."},{"front":"她一走上舞台，紧张感就消失了。","back":"Her nervousness disappeared once she stepped onto the stage."},{"front":"该软件应规律地更新以获得更好的安全性。","back":"The software should be updated regularly for better security."},{"front":"由于突发疾病，他缺了一周的课。","back":"He missed a week of school due to a sudden illness."},{"front":"她对惊喜派对的最初反应是纯粹的喜悦。","back":"Her initial reaction to the surprise party was pure joy."},{"front":"一个好经理知道如何引导团队而不发脾气。","back":"A good manager knows how to guide the team without losing his temper."},{"front":"与其仅仅批评计划，不如提供解决方案。","back":"It is better to offer solutions rather than just criticize the plan."},{"front":"我后悔年轻时没有学习弹钢琴。","back":"I regret not learning how to play the piano when I was younger."},{"front":"她发了一封非正式电子邮件邀请朋友们共进晚餐。","back":"She sent an informal email to invite her friends for dinner."},{"front":"描述性的主题行能确保收件人迅速打开邮件。","back":"A descriptive subject line ensures the recipient opens the email quickly."},{"front":"在陈述主要请求之前，务必包含礼貌的问候。","back":"Always include a polite greeting before stating your main request."},{"front":"演讲者的开场白立刻吸引了观众的注意力。","back":"The speaker's opening immediately captured the audience's attention."},{"front":"给亲密的同事发信息时，使用随意的语气是合适的。","back":"A casual tone is appropriate when messaging your close colleagues."},{"front":"你文章的正文必须包含强有力的支持证据。","back":"The body of your essay must contain strong supporting evidence."},{"front":"使用简单的词汇和要点可以提高文档的可读性。","back":"Using simple words and bullet points enhances the document's readability."},{"front":"第一章和第二章之间的过渡天衣无缝。","back":"The transition between the first and second chapter was seamless."},{"front":"简单句传达一个清晰的想法，不会让读者感到困惑。","back":"A simple sentence conveys one clear idea without confusing the reader."},{"front":"‘他想去公园，但是开始下雨了’是一个并列句。","back":"He wanted to go to the park, but it started raining is a compound sentence."},{"front":"‘因为她努力学习，所以她通过了考试’是复合句的一个例子。","back":"Because she studied hard, she passed the exam is an example of a complex sentence."},{"front":"在你的最终草稿中检查城市名称的大写。","back":"Check the capitalization of the city names in your final draft."},{"front":"糟糕的标点符号会彻底改变一个句子的意思。","back":"Bad punctuation can completely change the meaning of a sentence."},{"front":"写‘can't’这样的词时不要忘记撇号。","back":"Do not forget the apostrophe when you write words like 'can't'."},{"front":"在名词末尾加上‘s’表示所有格。","back":"Adding an 's' to the end of a noun indicates possession."},{"front":"感叹号用于表达强烈的情感或惊讶。","back":"An exclamation mark is used to express strong emotion or surprise."},{"front":"让我们圆满结束会议，以便大家去吃午餐。","back":"Let's wrap up the meeting so everyone can go to lunch."},{"front":"他选择用‘诚挚的问候’作为他信件的结束语。","back":"He chose to sign off his letter with the words 'Best regards'."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What is the main topic of the conversation?","options":["A. Planning a vacation","B. Coping with stress and writing an apology email","C. Applying for a new job","D. Discussing medical treatments"],"ans":"B. Coping with stress and writing an apology email"},{"type":"tf","q":"The person overslept because they were completely relaxed.","options":["True","False"],"ans":"False"},{"type":"fill","q":"Deep _____ exercises can help reduce your nervousness.","options":[],"ans":"breathing"},{"type":"mc","q":"What did the person do when the schedule changed?","options":["A. They went home early.","B. They lost their temper and criticized a coworker.","C. They asked the manager for help.","D. They wrote a formal report."],"ans":"B. They lost their temper and criticized a coworker."},{"type":"tf","q":"The person feels no regret about their unprofessional behavior.","options":["True","False"],"ans":"False"},{"type":"fill","q":"Keep a casual _____ throughout the body of the message.","options":[],"ans":"tone"},{"type":"mc","q":"What helps to significantly improve readability in an email?","options":["A. Using complex vocabulary","B. Writing one long paragraph","C. Using short paragraphs","D. Ignoring punctuation"],"ans":"C. Using short paragraphs"},{"type":"tf","q":"A simple sentence is highly recommended for explaining very detailed and complicated thoughts.","options":["True","False"],"ans":"False"},{"type":"fill","q":"Use an _____ correctly to show possession.","options":[],"ans":"apostrophe"},{"type":"dict","q":"Listen and write down the sentence you hear.","options":[],"ans":"Finally, sign off warmly to show you are sincere.","srcText":"Finally, sign off warmly to show you are sincere."}]; 
        let vocabQuestions = [{"type":"mc","q":"Breaking text into short paragraphs improves its:","options":["A. punctuation","B. readability","C. nervousness","D. greeting"],"ans":"B. readability"},{"type":"fill","q":"I _____ not buying that house when the price was low.","options":[],"ans":"regret"},{"type":"tf","q":"A 'simple sentence' contains only one independent clause.","options":["True","False"],"ans":"True"},{"type":"fill","q":"Use words like 'however' and 'therefore' as a _____ between ideas.","options":[],"ans":"transition"},{"type":"fill","q":"The atmosphere in the meeting room was very _____ before the announcement.","options":[],"ans":"tense"},{"type":"fill","q":"Make sure to _____ with your name at the end of the message.","options":[],"ans":"sign off"},{"type":"fill","q":"Start your speech with a strong _____ to grab the audience's attention.","options":[],"ans":"opening"},{"type":"mc","q":"Words like 'Hi' or 'Dear' at the start of an email are called a:","options":["A. greeting","B. possession","C. transition","D. body"],"ans":"A. greeting"},{"type":"fill","q":"I missed the early train because I _____ this morning.","options":[],"ans":"overslept"},{"type":"tf","q":"A 'casual tone' is highly formal and strict, usually used in legal documents.","options":["True","False"],"ans":"False"},{"type":"fill","q":"An _____ is used to show strong emotion or shouting in text.","options":[],"ans":"exclamation mark"},{"type":"tf","q":"'Breathing' refers to the process of taking air into and out of the lungs.","options":["True","False"],"ans":"True"},{"type":"fill","q":"A _____ sentence joins two independent clauses with a conjunction.","options":[],"ans":"compound"},{"type":"mc","q":"A disease of the body or mind is called an:","options":["A. reaction","B. illness","C. apostrophe","D. opening"],"ans":"B. illness"},{"type":"fill","q":"The main information and news are located in the _____ of the letter.","options":[],"ans":"body"},{"type":"fill","q":"Proper _____ requires the first letter of a person's name to be uppercase.","options":[],"ans":"capitalization"},{"type":"fill","q":"He has been feeling very _____ lately due to the heavy workload.","options":[],"ans":"stressed"},{"type":"tf","q":"'Cope with' means to successfully deal with a difficult situation.","options":["True","False"],"ans":"True"},{"type":"fill","q":"It is unprofessional to _____ and yell at your team.","options":[],"ans":"lose one's temper"},{"type":"mc","q":"What grammatical concept shows ownership?","options":["A. possession","B. transition","C. opening","D. readability"],"ans":"A. possession"},{"type":"fill","q":"She felt _____ before taking her final driving exam.","options":[],"ans":"anxious"},{"type":"tf","q":"'Punctuation' includes periods, commas, and question marks.","options":["True","False"],"ans":"True"},{"type":"mc","q":"If you do something 'regularly', you do it:","options":["A. rarely","B. often and evenly","C. accidentally","D. suddenly"],"ans":"B. often and evenly"},{"type":"mc","q":"To express disapproval of someone's actions is to:","options":["A. regret","B. sign off","C. criticize","D. relax"],"ans":"C. criticize"},{"type":"fill","q":"The symbol used in the word 'don't' is called an _____.","options":[],"ans":"apostrophe"},{"type":"tf","q":"To 'wrap up' a meeting means to start it.","options":["True","False"],"ans":"False"},{"type":"tf","q":"A 'reaction' is something you do or say as a result of something else.","options":["True","False"],"ans":"True"},{"type":"mc","q":"Which sentence type contains one independent clause and at least one dependent clause?","options":["A. simple sentence","B. complex sentence","C. informal email","D. subject line"],"ans":"B. complex sentence"},{"type":"fill","q":"The _____ should briefly summarize the email's content before the recipient opens it.","options":[],"ans":"subject line"},{"type":"fill","q":"It is too noisy here; I cannot _____ on my work.","options":[],"ans":"concentrate"},{"type":"fill","q":"Speaking in public always gives me a feeling of _____.","options":[],"ans":"nervousness"},{"type":"tf","q":"An 'informal email' is usually sent to a close friend, family member, or close colleague.","options":["True","False"],"ans":"True"},{"type":"mc","q":"Which word means to stop feeling nervous or angry?","options":["A. criticize","B. relax","C. oversleep","D. regret"],"ans":"B. relax"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = (dialogueData[index].en || '').trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${(k.point || '').replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${(q.srcText || '').replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>