<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giving Advice and Managing Stress</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Giving Advice and Managing Stress</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Hey Sarah, are you okay?","cn":"嘿，莎拉，你还好吗？"},{"en":"You look a bit stressed out today.","cn":"你今天看起来有点压力过大。"},{"en":"To be honest, Mark, I am feeling really exhausted.","cn":"老实说，马克，我真的感觉筋疲力尽。"},{"en":"I have had terrible insomnia for the past week.","cn":"过去的一周我失眠很严重。"},{"en":"I just lie in bed feeling anxious about work.","cn":"我只是躺在床上，对工作感到焦虑。"},{"en":"I'm sorry to hear that.","cn":"听到这个我很遗憾。"},{"en":"Chronic stress can lead to serious health problems if you ignore it.","cn":"如果你忽视它，慢性压力会导致严重的健康问题。"},{"en":"I know.","cn":"我知道。"},{"en":"It is getting hard to concentrate on my tasks.","cn":"我现在很难集中精力完成任务。"},{"en":"I get distracted by every little noise.","cn":"一点小噪音就会让我分心。"},{"en":"Yesterday, I almost lost my temper with a client.","cn":"昨天，我差点对一个客户发脾气。"},{"en":"That sounds exhausting.","cn":"听起来真让人精疲力竭。"},{"en":"Have you tried talking to your manager about your workload?","cn":"你试过和你的经理谈谈你的工作量吗？"},{"en":"Not yet.","cn":"还没有。"},{"en":"I am worried she might think I cannot handle the job.","cn":"我担心她会觉得我无法胜任这份工作。"},{"en":"If I were you, I would ask for help.","cn":"如果我是你，我会寻求帮助。"},{"en":"You shouldn't work so much overtime.","cn":"你不应该加那么多班。"},{"en":"Maybe you could take a few days off to calm down.","cn":"也许你可以请几天假冷静一下。"},{"en":"You're right.","cn":"你说得对。"},{"en":"I probably need to deal with this before I feel blue all the time.","cn":"我可能需要在一直感到忧郁之前处理好这件事。"},{"en":"Why don't you try taking a yoga class?","cn":"你为什么不试着上瑜伽课呢？"},{"en":"It might help you cope with the tension in your body.","cn":"它可能有助于你缓解身体的紧张感。"},{"en":"That is a good idea.","cn":"是个好主意。"},{"en":"My back is tense and I have some chronic pain recently.","cn":"我的背部很紧绷，最近还有一些慢性疼痛。"},{"en":"How about going to the clinic this afternoon?","cn":"今天下午去诊所怎么样？"},{"en":"You really should prioritize your health, or else you might burn out completely.","cn":"你真的应该优先考虑你的健康，否则你可能会彻底累垮。"},{"en":"I will think about that.","cn":"我会考虑的。"},{"en":"Thanks for the advice, Mark.","cn":"谢谢你的建议，马克。"}];
        const knowledgePoints = [{"cat":"Adjective","point":"exhausted","ex":"After running the marathon, he felt completely exhausted.","ipa":""},{"cat":"Adjective","point":"stressed out","ex":"She is stressed out because of her upcoming exams.","ipa":""},{"cat":"Noun","point":"insomnia","ex":"Drinking too much coffee can cause insomnia.","ipa":""},{"cat":"Noun","point":"anxiety","ex":"Deep breathing can help reduce anxiety.","ipa":""},{"cat":"Verb Phrase","point":"cope with","ex":"Music helps him cope with difficult emotions.","ipa":""},{"cat":"Verb","point":"handle","ex":"I don't think I can handle any more bad news today.","ipa":""},{"cat":"Verb Phrase","point":"lose one's temper","ex":"Please be patient and do not lose your temper.","ipa":""},{"cat":"Verb Phrase","point":"feel blue","ex":"He tends to feel blue during the rainy season.","ipa":""},{"cat":"Verb","point":"concentrate","ex":"Please be quiet so I can concentrate on my reading.","ipa":""},{"cat":"Adjective","point":"distracted","ex":"Drivers should not get distracted by their phones.","ipa":""},{"cat":"Noun Phrase","point":"chronic pain","ex":"My grandmother suffers from chronic pain in her knees.","ipa":""},{"cat":"Adjective","point":"tense","ex":"Her shoulders were tense from sitting at the computer all day.","ipa":""},{"cat":"Adjective","point":"depressed","ex":"It is normal to feel depressed after losing a pet.","ipa":""},{"cat":"Adjective","point":"worried","ex":"Parents are always worried about their children's safety.","ipa":""},{"cat":"Modal Verb","point":"should","ex":"You should eat more vegetables for better health.","ipa":""},{"cat":"Modal Verb","point":"shouldn't","ex":"You shouldn't drive if you are feeling very tired.","ipa":""},{"cat":"Phrase","point":"If I were you","ex":"If I were you, I would accept the job offer.","ipa":""},{"cat":"Phrase","point":"Why don't you","ex":"Why don't you join us for dinner tonight?","ipa":""},{"cat":"Phrase","point":"How about","ex":"How about going for a walk in the park?","ipa":""},{"cat":"Phrase","point":"Have you tried","ex":"Have you tried restarting your computer to fix the problem?","ipa":""},{"cat":"Verb Phrase","point":"lead to","ex":"Poor diet can lead to many health issues.","ipa":""},{"cat":"Verb Phrase","point":"contribute to","ex":"Smoking contributes to lung disease.","ipa":""},{"cat":"Adjective/Verb","point":"calm","ex":"Try to stay calm during the emergency.","ipa":""},{"cat":"Verb Phrase","point":"deal with","ex":"We need to deal with this complaint immediately.","ipa":""},{"cat":"Adjective","point":"exhausting","ex":"The hike up the mountain was exhausting but worth it.","ipa":""},{"cat":"Noun","point":"depression","ex":"He sought help from a therapist for his depression.","ipa":""},{"cat":"Adjective","point":"anxious","ex":"She felt anxious before her public speech.","ipa":""},{"cat":"Noun","point":"stress","ex":"Yoga is a great way to relieve stress.","ipa":""},{"cat":"Adverb","point":"probably","ex":"It will probably rain later today.","ipa":""},{"cat":"Adverb","point":"maybe","ex":"Maybe we should wait for him a bit longer.","ipa":""},{"cat":"Phrase","point":"or else","ex":"Hurry up, or else we will miss the bus.","ipa":""}];
        const cultureData = [{"en":"In Western culture, giving direct advice (like 'You must do this') can sometimes be considered rude or bossy, especially with colleagues or acquaintances. It is very common to 'soften' advice to sound more polite. We use phrases like 'Maybe you should...', 'If I were you, I would...', 'Why don't you...', or 'Have you tried...'. This allows the listener to feel they have a choice, rather than being ordered what to do.","cn":"在西方文化中，直接给出建议（比如“你必须这样做”）有时会被认为是粗鲁或专横的，尤其是对同事或熟人。为了听起来更礼貌，人们通常会“软化”建议。我们使用诸如“也许你应该……”、“如果我是你，我会……”、“你为什么不……”或“你试过……吗”之类的短语。这让听者感觉他们有选择权，而不是被命令去做什么。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"exhausted (adj.) /ɪɡˈzɔːstɪd/","back":"筋疲力尽的"},{"front":"stressed out (adj.) /strest aʊt/","back":"压力过大的"},{"front":"insomnia (n.) /ɪnˈsɒmniə/","back":"失眠"},{"front":"anxiety (n.) /æŋˈzaɪəti/","back":"焦虑"},{"front":"cope with (v. phr.) /kəʊp wɪð/","back":"处理，应对"},{"front":"handle (v.) /ˈhændl/","back":"处理，应付"},{"front":"lose one's temper (v. phr.) /luːz wʌnz ˈtempər/","back":"发脾气"},{"front":"feel blue (v. phr.) /fiːl bluː/","back":"感到忧郁/沮丧"},{"front":"concentrate (v.) /ˈkɒnsntreɪt/","back":"集中注意力"},{"front":"distracted (adj.) /dɪˈstræktɪd/","back":"分心的"},{"front":"chronic pain (n. phr.) /ˈkrɒnɪk peɪn/","back":"慢性疼痛"},{"front":"tense (adj.) /tens/","back":"紧张的，紧绷的"},{"front":"depressed (adj.) /dɪˈprest/","back":"沮丧的，抑郁的"},{"front":"worried (adj.) /ˈwʌrid/","back":"担心的"},{"front":"should (modal v.) /ʃʊd/","back":"应该"},{"front":"shouldn't (modal v.) /ˈʃʊdnt/","back":"不应该"},{"front":"If I were you (phr.) /ɪf aɪ wɜːr juː/","back":"如果我是你（用于给出建议）"},{"front":"Why don't you (phr.) /waɪ dəʊnt juː/","back":"你为什么不...（表示建议）"},{"front":"How about (phr.) /haʊ əˈbaʊt/","back":"...怎么样"},{"front":"Have you tried (phr.) /hæv juː traɪd/","back":"你试过...吗"},{"front":"lead to (v. phr.) /liːd tuː/","back":"导致"},{"front":"contribute to (v. phr.) /kənˈtrɪbjuːt tuː/","back":"导致，促成"},{"front":"calm (adj./v.) /kɑːm/","back":"冷静的；使平静"},{"front":"deal with (v. phr.) /diːl wɪð/","back":"处理，解决"},{"front":"exhausting (adj.) /ɪɡˈzɔːstɪŋ/","back":"令人筋疲力尽的"},{"front":"depression (n.) /dɪˈpreʃn/","back":"抑郁症，沮丧"},{"front":"anxious (adj.) /ˈæŋkʃəs/","back":"焦虑的"},{"front":"stress (n.) /stres/","back":"压力"},{"front":"probably (adv.) /ˈprɒbəbli/","back":"可能，大概"},{"front":"maybe (adv.) /ˈmeɪbi/","back":"也许"},{"front":"or else (phr.) /ɔːr els/","back":"否则，要不然"}],"group_2":[{"front":"筋疲力尽的","back":"exhausted (adj.) /ɪɡˈzɔːstɪd/"},{"front":"压力过大的","back":"stressed out (adj.) /strest aʊt/"},{"front":"失眠","back":"insomnia (n.) /ɪnˈsɒmniə/"},{"front":"焦虑","back":"anxiety (n.) /æŋˈzaɪəti/"},{"front":"处理，应对","back":"cope with (v. phr.) /kəʊp wɪð/"},{"front":"处理，应付","back":"handle (v.) /ˈhændl/"},{"front":"发脾气","back":"lose one's temper (v. phr.) /luːz wʌnz ˈtempər/"},{"front":"感到忧郁/沮丧","back":"feel blue (v. phr.) /fiːl bluː/"},{"front":"集中注意力","back":"concentrate (v.) /ˈkɒnsntreɪt/"},{"front":"分心的","back":"distracted (adj.) /dɪˈstræktɪd/"},{"front":"慢性疼痛","back":"chronic pain (n. phr.) /ˈkrɒnɪk peɪn/"},{"front":"紧张的，紧绷的","back":"tense (adj.) /tens/"},{"front":"沮丧的，抑郁的","back":"depressed (adj.) /dɪˈprest/"},{"front":"担心的","back":"worried (adj.) /ˈwʌrid/"},{"front":"应该","back":"should (modal v.) /ʃʊd/"},{"front":"不应该","back":"shouldn't (modal v.) /ˈʃʊdnt/"},{"front":"如果我是你（用于给出建议）","back":"If I were you (phr.) /ɪf aɪ wɜːr juː/"},{"front":"你为什么不...（表示建议）","back":"Why don't you (phr.) /waɪ dəʊnt juː/"},{"front":"...怎么样","back":"How about (phr.) /haʊ əˈbaʊt/"},{"front":"你试过...吗","back":"Have you tried (phr.) /hæv juː traɪd/"},{"front":"导致","back":"lead to (v. phr.) /liːd tuː/"},{"front":"导致，促成","back":"contribute to (v. phr.) /kənˈtrɪbjuːt tuː/"},{"front":"冷静的；使平静","back":"calm (adj./v.) /kɑːm/"},{"front":"处理，解决","back":"deal with (v. phr.) /diːl wɪð/"},{"front":"令人筋疲力尽的","back":"exhausting (adj.) /ɪɡˈzɔːstɪŋ/"},{"front":"抑郁症，沮丧","back":"depression (n.) /dɪˈpreʃn/"},{"front":"焦虑的","back":"anxious (adj.) /ˈæŋkʃəs/"},{"front":"压力","back":"stress (n.) /stres/"},{"front":"可能，大概","back":"probably (adv.) /ˈprɒbəbli/"},{"front":"也许","back":"maybe (adv.) /ˈmeɪbi/"},{"front":"否则，要不然","back":"or else (phr.) /ɔːr els/"}],"group_3":[{"front":"After running the marathon, he felt completely exhausted.","back":"跑完马拉松后，他感到彻底筋疲力尽。"},{"front":"She is stressed out because of her upcoming exams.","back":"因为即将到来的考试，她感到压力很大。"},{"front":"Drinking too much coffee can cause insomnia.","back":"喝太多咖啡会导致失眠。"},{"front":"Deep breathing can help reduce anxiety.","back":"深呼吸可以帮助减轻焦虑。"},{"front":"Music helps him cope with difficult emotions.","back":"音乐帮助他应对糟糕的情绪。"},{"front":"I don't think I can handle any more bad news today.","back":"我觉得我今天无法再承受任何坏消息了。"},{"front":"Please be patient and do not lose your temper.","back":"请耐心点，不要发脾气。"},{"front":"He tends to feel blue during the rainy season.","back":"在雨季他往往会感到忧郁。"},{"front":"Please be quiet so I can concentrate on my reading.","back":"请安静，这样我才能集中精力读书。"},{"front":"Drivers should not get distracted by their phones.","back":"司机不应该被手机分心。"},{"front":"My grandmother suffers from chronic pain in her knees.","back":"我的祖母膝盖患有慢性疼痛。"},{"front":"Her shoulders were tense from sitting at the computer all day.","back":"在电脑前坐了一整天，她的肩膀很紧绷。"},{"front":"It is normal to feel depressed after losing a pet.","back":"失去宠物后感到沮丧是正常的。"},{"front":"Parents are always worried about their children's safety.","back":"父母总是担心孩子的安全。"},{"front":"You should eat more vegetables for better health.","back":"为了更健康，你应该多吃蔬菜。"},{"front":"You shouldn't drive if you are feeling very tired.","back":"如果你感觉很累，就不应该开车。"},{"front":"If I were you, I would accept the job offer.","back":"如果我是你，我会接受这份工作。"},{"front":"Why don't you join us for dinner tonight?","back":"你今晚为什么不和我们一起吃晚饭呢？"},{"front":"How about going for a walk in the park?","back":"去公园散步怎么样？"},{"front":"Have you tried restarting your computer to fix the problem?","back":"你试过重启电脑来解决这个问题吗？"},{"front":"Poor diet can lead to many health issues.","back":"不良饮食会导致许多健康问题。"},{"front":"Smoking contributes to lung disease.","back":"吸烟会导致肺部疾病。"},{"front":"Try to stay calm during the emergency.","back":"在紧急情况下尽量保持冷静。"},{"front":"We need to deal with this complaint immediately.","back":"我们需要立即处理这个投诉。"},{"front":"The hike up the mountain was exhausting but worth it.","back":"爬山虽然让人筋疲力尽，但很值得。"},{"front":"He sought help from a therapist for his depression.","back":"他因为抑郁症向治疗师寻求帮助。"},{"front":"She felt anxious before her public speech.","back":"她在公开演讲前感到焦虑。"},{"front":"Yoga is a great way to relieve stress.","back":"瑜伽是缓解压力的好方法。"},{"front":"It will probably rain later today.","back":"今天晚些时候可能会下雨。"},{"front":"Maybe we should wait for him a bit longer.","back":"也许我们应该再等他一会儿。"},{"front":"Hurry up, or else we will miss the bus.","back":"快点，否则我们要错过公交车了。"}],"group_4":[{"front":"跑完马拉松后，他感到彻底筋疲力尽。","back":"After running the marathon, he felt completely exhausted."},{"front":"因为即将到来的考试，她感到压力很大。","back":"She is stressed out because of her upcoming exams."},{"front":"喝太多咖啡会导致失眠。","back":"Drinking too much coffee can cause insomnia."},{"front":"深呼吸可以帮助减轻焦虑。","back":"Deep breathing can help reduce anxiety."},{"front":"音乐帮助他应对糟糕的情绪。","back":"Music helps him cope with difficult emotions."},{"front":"我觉得我今天无法再承受任何坏消息了。","back":"I don't think I can handle any more bad news today."},{"front":"请耐心点，不要发脾气。","back":"Please be patient and do not lose your temper."},{"front":"在雨季他往往会感到忧郁。","back":"He tends to feel blue during the rainy season."},{"front":"请安静，这样我才能集中精力读书。","back":"Please be quiet so I can concentrate on my reading."},{"front":"司机不应该被手机分心。","back":"Drivers should not get distracted by their phones."},{"front":"我的祖母膝盖患有慢性疼痛。","back":"My grandmother suffers from chronic pain in her knees."},{"front":"在电脑前坐了一整天，她的肩膀很紧绷。","back":"Her shoulders were tense from sitting at the computer all day."},{"front":"失去宠物后感到沮丧是正常的。","back":"It is normal to feel depressed after losing a pet."},{"front":"父母总是担心孩子的安全。","back":"Parents are always worried about their children's safety."},{"front":"为了更健康，你应该多吃蔬菜。","back":"You should eat more vegetables for better health."},{"front":"如果你感觉很累，就不应该开车。","back":"You shouldn't drive if you are feeling very tired."},{"front":"如果我是你，我会接受这份工作。","back":"If I were you, I would accept the job offer."},{"front":"你今晚为什么不和我们一起吃晚饭呢？","back":"Why don't you join us for dinner tonight?"},{"front":"去公园散步怎么样？","back":"How about going for a walk in the park?"},{"front":"你试过重启电脑来解决这个问题吗？","back":"Have you tried restarting your computer to fix the problem?"},{"front":"不良饮食会导致许多健康问题。","back":"Poor diet can lead to many health issues."},{"front":"吸烟会导致肺部疾病。","back":"Smoking contributes to lung disease."},{"front":"在紧急情况下尽量保持冷静。","back":"Try to stay calm during the emergency."},{"front":"我们需要立即处理这个投诉。","back":"We need to deal with this complaint immediately."},{"front":"爬山虽然让人筋疲力尽，但很值得。","back":"The hike up the mountain was exhausting but worth it."},{"front":"他因为抑郁症向治疗师寻求帮助。","back":"He sought help from a therapist for his depression."},{"front":"她在公开演讲前感到焦虑。","back":"She felt anxious before her public speech."},{"front":"瑜伽是缓解压力的好方法。","back":"Yoga is a great way to relieve stress."},{"front":"今天晚些时候可能会下雨。","back":"It will probably rain later today."},{"front":"也许我们应该再等他一会儿。","back":"Maybe we should wait for him a bit longer."},{"front":"快点，否则我们要错过公交车了。","back":"Hurry up, or else we will miss the bus."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What is Sarah's main problem?","options":["A. She has a headache.","B. She is stressed and has insomnia.","C. She lost her job.","D. She is angry at Mark."],"ans":"B. She is stressed and has insomnia."},{"type":"tf","q":"Sarah has been sleeping well recently.","options":["True","False"],"ans":"False"},{"type":"fill","q":"Mark says that chronic stress can ________ serious health problems.","options":["lead to"],"ans":"lead to"},{"type":"mc","q":"What happened to Sarah yesterday?","options":["A. She finished all her work.","B. She went to yoga.","C. She almost lost her temper with a client.","D. She spoke to her manager."],"ans":"C. She almost lost her temper with a client."},{"type":"dict","q":"Listen and type the sentence.","options":["If I were you, I would ask for help."],"ans":"If I were you, I would ask for help.","srcText":"If I were you, I would ask for help."},{"type":"mc","q":"Why hasn't Sarah talked to her manager?","options":["A. She doesn't like her manager.","B. She is worried her manager will think she can't handle the job.","C. Her manager is on vacation.","D. She wants to quit."],"ans":"B. She is worried her manager will think she can't handle the job."},{"type":"tf","q":"Mark suggests that Sarah should work more overtime.","options":["True","False"],"ans":"False"},{"type":"mc","q":"What activity does Mark suggest to help Sarah cope?","options":["A. Swimming","B. Running","C. Yoga","D. Painting"],"ans":"C. Yoga"},{"type":"fill","q":"Sarah mentions she has some ________ pain in her back.","options":["chronic"],"ans":"chronic"},{"type":"mc","q":"What warning does Mark give at the end?","options":["A. She might get fired.","B. She might burn out completely.","C. She might lose money.","D. She might lose her friends."],"ans":"B. She might burn out completely."}]; 
        let vocabQuestions = [{"type":"fill","q":"After working for 12 hours straight, I felt completely ________.","options":["exhausted"],"ans":"exhausted"},{"type":"mc","q":"What fits best? 'She is ________ because she has too much work.'","options":["A. happy","B. stressed out","C. calm","D. relaxed"],"ans":"B. stressed out"},{"type":"fill","q":"I can't sleep at night. I think I have ________.","options":["insomnia"],"ans":"insomnia"},{"type":"tf","q":"'Anxiety' means feeling very calm and peaceful.","options":["True","False"],"ans":"False"},{"type":"mc","q":"Which word is similar to 'manage' or 'survive' a difficult situation?","options":["A. create","B. cope with","C. ignore","D. enjoy"],"ans":"B. cope with"},{"type":"fill","q":"The new manager knows how to ________ difficult customers politely.","options":["handle"],"ans":"handle"},{"type":"mc","q":"If you get very angry suddenly, you:","options":["A. lose your temper","B. find your temper","C. keep your temper","D. hide your temper"],"ans":"A. lose your temper"},{"type":"fill","q":"I always ________ on rainy days; I just want to stay in bed.","options":["feel blue"],"ans":"feel blue"},{"type":"fill","q":"It is too noisy here. I cannot ________ on my homework.","options":["concentrate"],"ans":"concentrate"},{"type":"mc","q":"When you are not paying attention, you are:","options":["A. focused","B. distracted","C. careful","D. serious"],"ans":"B. distracted"},{"type":"fill","q":"Pain that lasts for a long time is called ________ pain.","options":["chronic"],"ans":"chronic"},{"type":"tf","q":"If your muscles are 'tense', they are relaxed and loose.","options":["True","False"],"ans":"False"},{"type":"mc","q":"A feeling of severe despondency and dejection is:","options":["A. depression","B. happiness","C. excitement","D. energy"],"ans":"A. depression"},{"type":"fill","q":"Don't be ________. Everything will be fine.","options":["worried"],"ans":"worried"},{"type":"mc","q":"Which word is used to give advice? 'You ________ see a doctor.'","options":["A. should","B. will","C. did","D. are"],"ans":"A. should"},{"type":"fill","q":"You ________ smoke here. It is not allowed.","options":["shouldn't"],"ans":"shouldn't"},{"type":"mc","q":"Complete the phrase: 'If I ________ you, I would study harder.'","options":["A. was","B. am","C. were","D. be"],"ans":"C. were"},{"type":"fill","q":"________ don't you take a break?","options":["Why"],"ans":"Why"},{"type":"mc","q":"Which is correct? 'How about ________ to the cinema?'","options":["A. go","B. going","C. to go","D. went"],"ans":"B. going"},{"type":"fill","q":"Have you ________ turning it off and on again?","options":["tried"],"ans":"tried"},{"type":"mc","q":"Lack of sleep can ________ poor performance at work.","options":["A. lead to","B. lead from","C. lead by","D. lead on"],"ans":"A. lead to"},{"type":"fill","q":"Loud noise can ________ to hearing loss over time.","options":["contribute"],"ans":"contribute"},{"type":"tf","q":"'Calm' is the opposite of 'anxious' or 'excited'.","options":["True","False"],"ans":"True"},{"type":"fill","q":"I have to ________ a difficult situation at the office.","options":["deal with"],"ans":"deal with"},{"type":"mc","q":"The journey was long and ________.","options":["A. exhausting","B. exhausted","C. exhaust","D. exhaustion"],"ans":"A. exhausting"},{"type":"fill","q":"He has been suffering from ________ since his wife passed away.","options":["depression"],"ans":"depression"},{"type":"mc","q":"If you are worried about something that might happen, you are:","options":["A. anxious","B. confident","C. bored","D. sleepy"],"ans":"A. anxious"},{"type":"fill","q":"I have too much work ________ right now.","options":["stress"],"ans":"stress"},{"type":"mc","q":"I'm not sure, but he is ________ at home.","options":["A. probably","B. sure","C. never","D. won't"],"ans":"A. probably"},{"type":"fill","q":"________ we can go to the beach if the weather is nice.","options":["Maybe"],"ans":"Maybe"},{"type":"fill","q":"You need to study, ________ you will fail the test.","options":["or else"],"ans":"or else"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = (dialogueData[index].en || '').trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${(k.point || '').replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${(q.srcText || '').replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>