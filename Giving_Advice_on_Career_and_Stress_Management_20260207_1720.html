<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giving Advice on Career and Stress Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Giving Advice on Career and Stress Management</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Hey Alex, do you have a minute to talk?","cn":"嘿，亚历克斯，你有空聊聊吗？"},{"en":"You look really exhausted today.","cn":"你今天看起来真的筋疲力尽。"},{"en":"To be honest, I am feeling very frustrated with my life right now.","cn":"老实说，我对现在的生活感到非常沮丧。"},{"en":"Working the night shift as a security guard is draining my energy.","cn":"做保安上夜班正在耗尽我的精力。"},{"en":"I know it is hard, but you are a talented civil engineer.","cn":"我知道这很难，但你是一名才华横溢的土木工程师。"},{"en":"It feels like I am wasting my skills while I just sit there all night.","cn":"感觉我整晚坐在那里是在浪费我的技能。"},{"en":"I have become so irritable lately that I am constantly fighting with my wife.","cn":"我最近变得非常易怒，经常和妻子吵架。"},{"en":"I am also having trouble controlling my temper with my teenage children.","cn":"我也难以控制对十几岁孩子发脾气。"},{"en":"That sounds like a very stressful situation for you and your family.","cn":"这对你和你的家人来说听起来是一个非常有压力的情况。"},{"en":"If you don't manage your stress levels, you might push your family away.","cn":"如果你不管理你的压力水平，你可能会把你的家人推开。"},{"en":"I know, but I just don't know what to do.","cn":"我知道，但我真的不知道该怎么做。"},{"en":"I feel like I am failing my family because I am not earning enough money.","cn":"我觉得我辜负了我的家人，因为我挣的钱不够多。"},{"en":"Please don't be so hard on yourself; moving to a new country is incredibly difficult.","cn":"请不要对自己太苛刻；搬到一个新国家是非常困难的。"},{"en":"However, if I were you, I would try to find a way to return to your profession.","cn":"不过，如果我是你，我会设法回到你的本行。"},{"en":"Have you tried getting your international credentials evaluated yet?","cn":"你试过评估你的国际证书了吗？"},{"en":"I haven't started that process because it seems so complicated and expensive.","cn":"我还没开始那个过程，因为它看起来太复杂且昂贵了。"},{"en":"You really should prioritize that, because it is the first step to working as an engineer here.","cn":"你真的应该优先考虑那件事，因为这是在这里做工程师的第一步。"},{"en":"You are right; I cannot stay in this security job forever.","cn":"你说得对；我不能永远待在这个保安的工作上。"},{"en":"Also, why don't you try networking with other engineers in the city?","cn":"另外，你为什么不试着和城里的其他工程师建立联系呢？"},{"en":"Connecting with people in your field can lead to new job opportunities.","cn":"与你所在领域的人联系可能会带来新的工作机会。"},{"en":"That is a good suggestion, although I feel too tired to meet new people.","cn":"这是个好建议，尽管我觉得太累了，没法去见新朋友。"},{"en":"You must take care of your mental health, or else you will burn out completely.","cn":"你必须照顾好你的心理健康，否则你会彻底崩溃。"},{"en":"Maybe you could join a local association for immigrant professionals.","cn":"也许你可以加入一个当地的移民专业人士协会。"},{"en":"They might help you cope with the challenges of settling in Canada.","cn":"他们可能会帮助你应对在加拿大定居的挑战。"},{"en":"You need to channel that frustration into positive action.","cn":"你需要将那种沮丧转化为积极的行动。"},{"en":"For example, you could study for a certification exam during your downtime at work.","cn":"例如，你可以利用工作时的空闲时间学习认证考试。"},{"en":"That is actually a brilliant idea since it is usually quiet at night.","cn":"这实际上是个绝妙的主意，因为晚上通常很安静。"},{"en":"Exactly, use that time to upgrade your qualifications.","cn":"没错，利用那段时间提升你的资历。"},{"en":"It will give you a sense of purpose again.","cn":"这会让你再次找到目标感。"},{"en":"You should also talk to your wife about how you are feeling.","cn":"你也应该和你妻子谈谈你的感受。"},{"en":"She needs to understand that your anger comes from frustration with your career.","cn":"她需要理解你的愤怒来自于对职业的沮丧。"},{"en":"If you explain your feelings, she will probably be more supportive.","cn":"如果你解释你的感受，她可能会更支持你。"},{"en":"Thanks for the advice; I really need to make a change before things get worse.","cn":"谢谢你的建议；在事情变得更糟之前，我真的需要做出改变。"},{"en":"Remember, if you ignore these problems, they will only become bigger in the long run.","cn":"记住，如果你忽视这些问题，从长远来看它们只会变得更大。"}];
        const knowledgePoints = [{"cat":"Adjective","point":"exhausted","ex":"I was too exhausted to cook dinner after work.","ipa":""},{"cat":"Adjective","point":"frustrated","ex":"He felt frustrated when he couldn't solve the math problem.","ipa":""},{"cat":"Noun Phrase","point":"night shift","ex":"Nurses often have to work the night shift.","ipa":""},{"cat":"Verb","point":"drain","ex":"Constant meetings drain my energy.","ipa":""},{"cat":"Noun Phrase","point":"civil engineer","ex":"A civil engineer designs bridges and roads.","ipa":""},{"cat":"Adjective","point":"irritable","ex":"Lack of sleep makes him very irritable.","ipa":""},{"cat":"Adverb","point":"constantly","ex":"Technology is constantly changing.","ipa":""},{"cat":"Verb Phrase","point":"control one's temper","ex":"It is important to control your temper during a disagreement.","ipa":""},{"cat":"Adjective","point":"stressful","ex":"Moving houses can be a stressful experience.","ipa":""},{"cat":"Verb","point":"manage","ex":"She knows how to manage her time effectively.","ipa":""},{"cat":"Phrasal Verb","point":"push away","ex":"Don't push away the people who try to help you.","ipa":""},{"cat":"Noun","point":"profession","ex":"Teaching is a respected profession.","ipa":""},{"cat":"Noun","point":"credentials","ex":"The committee reviewed his academic credentials.","ipa":""},{"cat":"Verb","point":"evaluate","ex":"We need to evaluate the results of the survey.","ipa":""},{"cat":"Adjective","point":"complicated","ex":"The instructions were too complicated to follow.","ipa":""},{"cat":"Verb","point":"prioritize","ex":"You must prioritize your tasks to meet the deadline.","ipa":""},{"cat":"Noun/Verb","point":"networking","ex":"Networking is essential for finding a job in business.","ipa":""},{"cat":"Noun","point":"field","ex":"He is an expert in the field of biology.","ipa":""},{"cat":"Noun","point":"opportunity","ex":"This job is a great opportunity for growth.","ipa":""},{"cat":"Noun Phrase","point":"mental health","ex":"Exercise is good for both physical and mental health.","ipa":""},{"cat":"Phrasal Verb","point":"burn out","ex":"If you work seven days a week, you will burn out.","ipa":""},{"cat":"Verb Phrase","point":"cope with","ex":"Humor helps him cope with difficult situations.","ipa":""},{"cat":"Phrasal Verb","point":"settle in","ex":"It took a few months to settle in to our new apartment.","ipa":""},{"cat":"Adjective","point":"supportive","ex":"His family was very supportive during his illness.","ipa":""},{"cat":"Phrase","point":"in the long run","ex":"Quitting smoking is beneficial in the long run.","ipa":""},{"cat":"Verb","point":"channel","ex":"She channels her energy into her painting.","ipa":""},{"cat":"Noun","point":"certification","ex":"You need a special certification to operate this machine.","ipa":""},{"cat":"Noun","point":"downtime","ex":"We played cards during the downtime on the set.","ipa":""},{"cat":"Noun","point":"qualification","ex":"Experience is a key qualification for this role.","ipa":""},{"cat":"Noun Phrase","point":"sense of purpose","ex":"Volunteering gave him a renewed sense of purpose.","ipa":""}];
        const cultureData = [{"en":"In Canada, newcomers often work in 'survival jobs' (jobs below their skill level) to make ends meet while they work towards returning to their original profession. For regulated professions like Engineering, getting international credentials evaluated by organizations (like WES) is a critical step. Networking and joining professional immigrant associations are also key strategies to overcome the 'lack of Canadian experience' barrier.","cn":"在加拿大，新移民通常会从事“生存工作”（低于其技能水平的工作）来维持生计，同时努力回归原本的职业。对于像工程这样的受监管职业，让国际学历通过机构（如WES）进行认证是关键的一步。建立人脉和加入专业移民协会也是克服“缺乏加拿大工作经验”障碍的关键策略。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"exhausted (adj.) /ɪɡˈzɔːstɪd/","back":"精疲力竭的"},{"front":"frustrated (adj.) /frʌˈstreɪtɪd/","back":"沮丧的，灰心的"},{"front":"night shift (n. phr.) /naɪt ʃɪft/","back":"夜班"},{"front":"drain (v.) /dreɪn/","back":"消耗，耗尽"},{"front":"civil engineer (n. phr.) /ˈsɪvəl endʒɪˈnɪər/","back":"土木工程师"},{"front":"irritable (adj.) /ˈɪrɪtəbl/","back":"易怒的，急躁的"},{"front":"constantly (adv.) /ˈkɒnstəntli/","back":"不断地，经常地"},{"front":"control one's temper (v. phr.) /kənˈtrəʊl wʌnz ˈtempər/","back":"控制脾气"},{"front":"stressful (adj.) /ˈstresfl/","back":"充满压力的"},{"front":"manage (v.) /ˈmænɪdʒ/","back":"管理，应对"},{"front":"push away (phr. v.) /pʊʃ əˈweɪ/","back":"推开，排斥"},{"front":"profession (n.) /prəˈfeʃn/","back":"职业，专业"},{"front":"credentials (n.) /krəˈdenʃlz/","back":"资历，证书"},{"front":"evaluate (v.) /ɪˈvæljueɪt/","back":"评估，评价"},{"front":"complicated (adj.) /ˈkɒmplɪkeɪtɪd/","back":"复杂的"},{"front":"prioritize (v.) /praɪˈɒrətaɪz/","back":"优先考虑"},{"front":"networking (n.) /ˈnetwɜːkɪŋ/","back":"建立人脉，社交"},{"front":"field (n.) /fiːld/","back":"领域，行业"},{"front":"opportunity (n.) /ˌɒpəˈtjuːnəti/","back":"机会"},{"front":"mental health (n. phr.) /ˈmentl helθ/","back":"心理健康"},{"front":"burn out (phr. v.) /bɜːn aʊt/","back":"累垮，耗尽体力"},{"front":"cope with (v. phr.) /kəʊp wɪð/","back":"应对，处理"},{"front":"settle in (phr. v.) /ˈsetl ɪn/","back":"安顿下来，适应"},{"front":"supportive (adj.) /səˈpɔːtɪv/","back":"支持的"},{"front":"in the long run (phr.) /ɪn ðə lɒŋ rʌn/","back":"从长远来看"},{"front":"channel (v.) /ˈtʃænl/","back":"引导，将...专注于"},{"front":"certification (n.) /ˌsɜːtɪfɪˈkeɪʃn/","back":"认证，执照"},{"front":"downtime (n.) /ˈdaʊntaɪm/","back":"停工期，空闲时间"},{"front":"qualification (n.) /ˌkwɒlɪfɪˈkeɪʃn/","back":"资格，资历"},{"front":"sense of purpose (n. phr.) /sens əv ˈpɜːpəs/","back":"目标感，使命感"}],"group_2":[{"front":"精疲力竭的","back":"exhausted (adj.) /ɪɡˈzɔːstɪd/"},{"front":"沮丧的，灰心的","back":"frustrated (adj.) /frʌˈstreɪtɪd/"},{"front":"夜班","back":"night shift (n. phr.) /naɪt ʃɪft/"},{"front":"消耗，耗尽","back":"drain (v.) /dreɪn/"},{"front":"土木工程师","back":"civil engineer (n. phr.) /ˈsɪvəl endʒɪˈnɪər/"},{"front":"易怒的，急躁的","back":"irritable (adj.) /ˈɪrɪtəbl/"},{"front":"不断地，经常地","back":"constantly (adv.) /ˈkɒnstəntli/"},{"front":"控制脾气","back":"control one's temper (v. phr.) /kənˈtrəʊl wʌnz ˈtempər/"},{"front":"充满压力的","back":"stressful (adj.) /ˈstresfl/"},{"front":"管理，应对","back":"manage (v.) /ˈmænɪdʒ/"},{"front":"推开，排斥","back":"push away (phr. v.) /pʊʃ əˈweɪ/"},{"front":"职业，专业","back":"profession (n.) /prəˈfeʃn/"},{"front":"资历，证书","back":"credentials (n.) /krəˈdenʃlz/"},{"front":"评估，评价","back":"evaluate (v.) /ɪˈvæljueɪt/"},{"front":"复杂的","back":"complicated (adj.) /ˈkɒmplɪkeɪtɪd/"},{"front":"优先考虑","back":"prioritize (v.) /praɪˈɒrətaɪz/"},{"front":"建立人脉，社交","back":"networking (n.) /ˈnetwɜːkɪŋ/"},{"front":"领域，行业","back":"field (n.) /fiːld/"},{"front":"机会","back":"opportunity (n.) /ˌɒpəˈtjuːnəti/"},{"front":"心理健康","back":"mental health (n. phr.) /ˈmentl helθ/"},{"front":"累垮，耗尽体力","back":"burn out (phr. v.) /bɜːn aʊt/"},{"front":"应对，处理","back":"cope with (v. phr.) /kəʊp wɪð/"},{"front":"安顿下来，适应","back":"settle in (phr. v.) /ˈsetl ɪn/"},{"front":"支持的","back":"supportive (adj.) /səˈpɔːtɪv/"},{"front":"从长远来看","back":"in the long run (phr.) /ɪn ðə lɒŋ rʌn/"},{"front":"引导，将...专注于","back":"channel (v.) /ˈtʃænl/"},{"front":"认证，执照","back":"certification (n.) /ˌsɜːtɪfɪˈkeɪʃn/"},{"front":"停工期，空闲时间","back":"downtime (n.) /ˈdaʊntaɪm/"},{"front":"资格，资历","back":"qualification (n.) /ˌkwɒlɪfɪˈkeɪʃn/"},{"front":"目标感，使命感","back":"sense of purpose (n. phr.) /sens əv ˈpɜːpəs/"}],"group_3":[{"front":"I was too exhausted to cook dinner after work.","back":"下班后我太累了，没法做晚饭。"},{"front":"He felt frustrated when he couldn't solve the math problem.","back":"当他解不出这道数学题时，他感到很沮丧。"},{"front":"Nurses often have to work the night shift.","back":"护士经常需要上夜班。"},{"front":"Constant meetings drain my energy.","back":"没完没了的会议耗尽了我的精力。"},{"front":"A civil engineer designs bridges and roads.","back":"土木工程师设计桥梁和道路。"},{"front":"Lack of sleep makes him very irritable.","back":"缺乏睡眠让他变得非常易怒。"},{"front":"Technology is constantly changing.","back":"科技在不断变化。"},{"front":"It is important to control your temper during a disagreement.","back":"在争执中控制脾气很重要。"},{"front":"Moving houses can be a stressful experience.","back":"搬家可能是一次充满压力的经历。"},{"front":"She knows how to manage her time effectively.","back":"她知道如何有效地管理时间。"},{"front":"Don't push away the people who try to help you.","back":"不要推开那些试图帮助你的人。"},{"front":"Teaching is a respected profession.","back":"教书是一个受人尊敬的职业。"},{"front":"The committee reviewed his academic credentials.","back":"委员会审查了他的学历证书。"},{"front":"We need to evaluate the results of the survey.","back":"我们需要评估调查的结果。"},{"front":"The instructions were too complicated to follow.","back":"说明书太复杂了，无法照做。"},{"front":"You must prioritize your tasks to meet the deadline.","back":"为了赶上截止日期，你必须优先安排你的任务。"},{"front":"Networking is essential for finding a job in business.","back":"建立人脉对于在商业领域找工作至关重要。"},{"front":"He is an expert in the field of biology.","back":"他是生物学领域的专家。"},{"front":"This job is a great opportunity for growth.","back":"这份工作是一个很好的成长机会。"},{"front":"Exercise is good for both physical and mental health.","back":"运动对身心健康都有益。"},{"front":"If you work seven days a week, you will burn out.","back":"如果你一周工作七天，你会累垮的。"},{"front":"Humor helps him cope with difficult situations.","back":"幽默帮助他应对困难的情况。"},{"front":"It took a few months to settle in to our new apartment.","back":"我们花了好几个月才在很多公寓安顿下来。"},{"front":"His family was very supportive during his illness.","back":"在他生病期间，他的家人非常支持他。"},{"front":"Quitting smoking is beneficial in the long run.","back":"从长远来看，戒烟是有益的。"},{"front":"She channels her energy into her painting.","back":"她把精力都倾注在绘画上。"},{"front":"You need a special certification to operate this machine.","back":"你需要特殊的认证才能操作这台机器。"},{"front":"We played cards during the downtime on the set.","back":"我们在片场的空闲时间打牌。"},{"front":"Experience is a key qualification for this role.","back":"经验是这个职位的关键资格。"},{"front":"Volunteering gave him a renewed sense of purpose.","back":"志愿服务让他重新找到了使命感。"}],"group_4":[{"front":"下班后我太累了，没法做晚饭。","back":"I was too exhausted to cook dinner after work."},{"front":"当他解不出这道数学题时，他感到很沮丧。","back":"He felt frustrated when he couldn't solve the math problem."},{"front":"护士经常需要上夜班。","back":"Nurses often have to work the night shift."},{"front":"没完没了的会议耗尽了我的精力。","back":"Constant meetings drain my energy."},{"front":"土木工程师设计桥梁和道路。","back":"A civil engineer designs bridges and roads."},{"front":"缺乏睡眠让他变得非常易怒。","back":"Lack of sleep makes him very irritable."},{"front":"科技在不断变化。","back":"Technology is constantly changing."},{"front":"在争执中控制脾气很重要。","back":"It is important to control your temper during a disagreement."},{"front":"搬家可能是一次充满压力的经历。","back":"Moving houses can be a stressful experience."},{"front":"她知道如何有效地管理时间。","back":"She knows how to manage her time effectively."},{"front":"不要推开那些试图帮助你的人。","back":"Don't push away the people who try to help you."},{"front":"教书是一个受人尊敬的职业。","back":"Teaching is a respected profession."},{"front":"委员会审查了他的学历证书。","back":"The committee reviewed his academic credentials."},{"front":"我们需要评估调查的结果。","back":"We need to evaluate the results of the survey."},{"front":"说明书太复杂了，无法照做。","back":"The instructions were too complicated to follow."},{"front":"为了赶上截止日期，你必须优先安排你的任务。","back":"You must prioritize your tasks to meet the deadline."},{"front":"建立人脉对于在商业领域找工作至关重要。","back":"Networking is essential for finding a job in business."},{"front":"他是生物学领域的专家。","back":"He is an expert in the field of biology."},{"front":"这份工作是一个很好的成长机会。","back":"This job is a great opportunity for growth."},{"front":"运动对身心健康都有益。","back":"Exercise is good for both physical and mental health."},{"front":"如果你一周工作七天，你会累垮的。","back":"If you work seven days a week, you will burn out."},{"front":"幽默帮助他应对困难的情况。","back":"Humor helps him cope with difficult situations."},{"front":"我们花了好几个月才在很多公寓安顿下来。","back":"It took a few months to settle in to our new apartment."},{"front":"在他生病期间，他的家人非常支持他。","back":"His family was very supportive during his illness."},{"front":"从长远来看，戒烟是有益的。","back":"Quitting smoking is beneficial in the long run."},{"front":"她把精力都倾注在绘画上。","back":"She channels her energy into her painting."},{"front":"你需要特殊的认证才能操作这台机器。","back":"You need a special certification to operate this machine."},{"front":"我们在片场的空闲时间打牌。","back":"We played cards during the downtime on the set."},{"front":"经验是这个职位的关键资格。","back":"Experience is a key qualification for this role."},{"front":"志愿服务让他重新找到了使命感。","back":"Volunteering gave him a renewed sense of purpose."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What is Alex's current job?","options":["A. Civil Engineer","B. Security Guard","C. Teacher","D. Doctor"],"ans":"B. Security Guard"},{"type":"tf","q":"Alex is happy with his current work schedule.","options":["True","False"],"ans":"False"},{"type":"fill","q":"Alex feels ________ because he thinks he is wasting his skills.","options":["frustrated"],"ans":"frustrated"},{"type":"mc","q":"How is Alex's stress affecting his family life?","options":["A. He is spending more time with them.","B. He is buying them gifts.","C. He is fighting with his wife and children.","D. He is cooking dinner for them."],"ans":"C. He is fighting with his wife and children."},{"type":"dict","q":"Listen and type the sentence.","options":["You must take care of your mental health."],"ans":"You must take care of your mental health.","srcText":"You must take care of your mental health."},{"type":"mc","q":"What advice does the friend give regarding credentials?","options":["A. Forget about them.","B. Get them evaluated.","C. Hide them.","D. Send them to his parents."],"ans":"B. Get them evaluated."},{"type":"tf","q":"The friend suggests Alex should stop talking to other engineers.","options":["True","False"],"ans":"False"},{"type":"mc","q":"What might happen if Alex ignores his problems?","options":["A. They will disappear.","B. They will become bigger in the long run.","C. He will get a promotion.","D. His wife will be happy."],"ans":"B. They will become bigger in the long run."},{"type":"fill","q":"Alex should use his ________ at work to study.","options":["downtime"],"ans":"downtime"},{"type":"mc","q":"Why hasn't Alex evaluated his credentials yet?","options":["A. He is lazy.","B. It seems complicated and expensive.","C. He lost his papers.","D. He doesn't want to be an engineer."],"ans":"B. It seems complicated and expensive."}]; 
        let vocabQuestions = [{"type":"fill","q":"After the long hike, everyone was completely ________.","options":["exhausted"],"ans":"exhausted"},{"type":"mc","q":"If something stops you from achieving your goal, you might feel:","options":["A. happy","B. frustrated","C. calm","D. excited"],"ans":"B. frustrated"},{"type":"fill","q":"He prefers working the ________ because it is quieter.","options":["night shift"],"ans":"night shift"},{"type":"mc","q":"Dealing with negative people can ________ your energy.","options":["A. drain","B. fill","C. boost","D. save"],"ans":"A. drain"},{"type":"fill","q":"My uncle is a ________ who builds skyscrapers.","options":["civil engineer"],"ans":"civil engineer"},{"type":"tf","q":"An 'irritable' person is usually very patient and happy.","options":["True","False"],"ans":"False"},{"type":"mc","q":"She checks her phone ________ throughout the day.","options":["A. rarely","B. constantly","C. never","D. once"],"ans":"B. constantly"},{"type":"fill","q":"When you are angry, try to ________ your temper.","options":["control"],"ans":"control"},{"type":"mc","q":"Exams can be very ________ for students.","options":["A. stressful","B. delicious","C. soft","D. funny"],"ans":"A. stressful"},{"type":"fill","q":"It is difficult to ________ a large team of people.","options":["manage"],"ans":"manage"},{"type":"fill","q":"His rude behavior might ________ his friends ________.","options":["push away"],"ans":"push away"},{"type":"mc","q":"Medicine is a challenging ________.","options":["A. profession","B. hobby","C. game","D. toy"],"ans":"A. profession"},{"type":"fill","q":"You need to show your ________ to get the job.","options":["credentials"],"ans":"credentials"},{"type":"mc","q":"The teacher will ________ the students' projects.","options":["A. evaluate","B. ignore","C. eat","D. hide"],"ans":"A. evaluate"},{"type":"tf","q":"If a problem is 'complicated', it is easy to solve.","options":["True","False"],"ans":"False"},{"type":"fill","q":"Please ________ safety over speed.","options":["prioritize"],"ans":"prioritize"},{"type":"mc","q":"Going to industry events is good for ________.","options":["A. sleeping","B. networking","C. hiding","D. cooking"],"ans":"B. networking"},{"type":"fill","q":"She works in the ________ of computer science.","options":["field"],"ans":"field"},{"type":"mc","q":"Don't miss this ________ to travel.","options":["A. opportunity","B. mistake","C. trouble","D. danger"],"ans":"A. opportunity"},{"type":"fill","q":"Talking to a counselor can improve your ________.","options":["mental health"],"ans":"mental health"},{"type":"mc","q":"If you don't take breaks, you will ________.","options":["A. burn out","B. burn up","C. burn down","D. burn off"],"ans":"A. burn out"},{"type":"fill","q":"She uses meditation to ________ stress.","options":["cope with"],"ans":"cope with"},{"type":"mc","q":"It takes time to ________ to a new school.","options":["A. settle in","B. move out","C. run away","D. fall down"],"ans":"A. settle in"},{"type":"fill","q":"A good friend should be ________.","options":["supportive"],"ans":"supportive"},{"type":"mc","q":"Investing money is smart ________.","options":["A. in the short run","B. in the long run","C. yesterday","D. quickly"],"ans":"B. in the long run"},{"type":"fill","q":"He needs to ________ his anger into sports.","options":["channel"],"ans":"channel"},{"type":"mc","q":"You need a first aid ________ to be a lifeguard.","options":["A. certification","B. paper","C. suggestion","D. idea"],"ans":"A. certification"},{"type":"fill","q":"I like to read during my ________.","options":["downtime"],"ans":"downtime"},{"type":"mc","q":"Does he have the right ________ for the job?","options":["A. qualification","B. shoes","C. lunch","D. car"],"ans":"A. qualification"},{"type":"fill","q":"Having a goal gives you a ________.","options":["sense of purpose"],"ans":"sense of purpose"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${(line.en || '').replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = (dialogueData[index].en || '').trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${(k.point || '').replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${(q.srcText || '').replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>