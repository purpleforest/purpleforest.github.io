<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastering Kitchen Vocabulary: Cooking a Feast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Mastering Kitchen Vocabulary: Cooking a Feast</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Let's prepare a big dinner tonight using all the fresh ingredients we bought.","cn":"我们今晚用买的所有新鲜食材准备一顿大餐吧。"},{"en":"First, grab the cutting board and peel these potatoes for the mash.","cn":"首先，拿菜板把这些土豆削皮，做土豆泥。"},{"en":"Then slice the carrots thinly and mince the garlic cloves.","cn":"然后把胡萝卜切成薄片，把大蒜瓣切成碎末。"},{"en":"I will turn on the stove and heat the skillet to medium temperature.","cn":"我会打开炉子，把平底锅加热到中温。"},{"en":"Please sauté the onions in a little oil until they are soft and golden.","cn":"请用少许油煸炒洋葱，直到它们变软金黄。"},{"en":"Use the food processor to chop the walnuts for the salad topping.","cn":"用食品加工机把核桃切碎，做沙拉的配料。"},{"en":"We need to season the chicken thoroughly before we put it in the baking dish.","cn":"在把鸡肉放入烤盘之前，我们需要彻底调味。"},{"en":"I'll roast the chicken in the oven for about one hour.","cn":"我会把鸡肉在烤箱里烤大约一个小时。"},{"en":"Can you pour the water into the big pot to boil the pasta?","cn":"你能把水倒进大锅里煮意大利面吗？"},{"en":"Don't forget to add salt and stir it occasionally so it doesn't stick.","cn":"别忘了加盐，偶尔搅拌一下，以免粘连。"},{"en":"Use the colander to drain the hot water once the pasta is ready.","cn":"意大利面煮好后，用滤水篮沥干热水。"},{"en":"I'll use the blender to purée the tomatoes for the marinara sauce.","cn":"我会用搅拌机把西红柿打成泥做意式大蒜番茄酱。"},{"en":"Let the sauce simmer on low heat while I fry the bacon strips.","cn":"让酱汁用小火慢炖，同时我来煎培根条。"},{"en":"Pass me the spatula so I can flip them over easily.","cn":"把铲子递给我，这样我可以轻松把它们翻面。"},{"en":"For the dessert bread, we must knead the dough on the counter for ten minutes.","cn":"至于甜点面包，我们必须在台面上揉面团十分钟。"},{"en":"Place it in a mixing bowl and cover it with plastic wrap to let it rise.","cn":"把它放在搅拌碗里，盖上保鲜膜让它发酵。"},{"en":"We can also ferment these cucumbers in a jar to make pickles for next week.","cn":"我们还可以把这些黄瓜放在罐子里发酵，做下周吃的酸黄瓜。"},{"en":"Use the grinder to crush some fresh black pepper over the salad.","cn":"用研磨机把一些新鲜的黑胡椒磨碎撒在沙拉上。"},{"en":"Just cut the baguette into thick pieces for the side.","cn":"只要把法棍切成厚片放在旁边就行。"},{"en":"Finally, garnish the soup with fresh herbs and sprinkle parmesan cheese on top.","cn":"最后，用新鲜香草装饰汤，并在上面撒上帕尔马干酪。"}];
        const knowledgePoints = [{"point":"skillet","ex":"He cooked the eggs in a cast-iron skillet.","exTrans":"他在一个铸铁平底锅里煮了鸡蛋。","ipa":""},{"point":"stove","ex":"Please turn off the stove after you finish cooking.","exTrans":"做完饭后请关掉炉子。","ipa":""},{"point":"pot","ex":"She made a large pot of vegetable soup.","exTrans":"她做了一大锅蔬菜汤。","ipa":""},{"point":"baking dish","ex":"Grease the baking dish before adding the batter.","exTrans":"在加入面糊之前先把烤盘涂上油。","ipa":""},{"point":"blender","ex":"I use a blender to make fruit smoothies every morning.","exTrans":"我每天早上用搅拌机做水果冰沙。","ipa":""},{"point":"cutting board","ex":"Always wash the cutting board after cutting raw meat.","exTrans":"切完生肉后一定要清洗切菜板。","ipa":""},{"point":"grinder","ex":"Fresh coffee tastes better if you use a grinder.","exTrans":"如果你用研磨机，新鲜咖啡的味道会更好。","ipa":""},{"point":"food processor","ex":"A food processor can chop onions in seconds.","exTrans":"食品加工机可以在几秒钟内切碎洋葱。","ipa":""},{"point":"mixing bowl","ex":"Combine the flour and sugar in a large mixing bowl.","exTrans":"在一个大搅拌碗里混合面粉和糖。","ipa":""},{"point":"plastic wrap","ex":"Wrap the leftovers in plastic wrap to keep them fresh.","exTrans":"用保鲜膜包好剩菜以保持新鲜。","ipa":""},{"point":"colander","ex":"Wash the grapes in a colander under cold water.","exTrans":"把葡萄放在滤水篮里用冷水冲洗。","ipa":""},{"point":"spatula","ex":"Use a rubber spatula to scrape the bowl clean.","exTrans":"用橡胶铲把碗刮干净。","ipa":""},{"point":"cut","ex":"Be careful not to cut your finger with the sharp knife.","exTrans":"小心不要被那把锋利的刀切到手指。","ipa":""},{"point":"mince","ex":"You should mince the ginger for the marinade.","exTrans":"你应该把姜切碎用来做腌料。","ipa":""},{"point":"slice","ex":"Slice the lemon into wedges for the tea.","exTrans":"把柠檬切成块泡茶。","ipa":""},{"point":"chop","ex":"Chop the parsley roughly before adding it to the stew.","exTrans":"在加入炖菜之前把欧芹粗略地切碎。","ipa":""},{"point":"garnish","ex":"The chef will garnish the steak with a sprig of rosemary.","exTrans":"厨师会用一枝迷迭香装饰牛排。","ipa":""},{"point":"sprinkle","ex":"Sprinkle some sugar on the strawberries.","exTrans":"在草莓上撒一些糖。","ipa":""},{"point":"peel","ex":"It is easier to peel an orange with your hands.","exTrans":"用手剥橙子皮更容易。","ipa":""},{"point":"season","ex":"Season the soup with salt and pepper to taste.","exTrans":"根据口味用盐和胡椒给汤调味。","ipa":""},{"point":"purée","ex":"Purée the boiled baby carrots until smooth.","exTrans":"把煮熟的小胡萝卜打成泥直到顺滑。","ipa":""},{"point":"pour","ex":"Pour the milk into the glass carefully.","exTrans":"把牛奶小心地倒进杯子里。","ipa":""},{"point":"knead","ex":"You need to knead the dough until it is elastic.","exTrans":"你需要揉面团直到它有弹性。","ipa":""},{"point":"add","ex":"Add two cups of flour to the mixture.","exTrans":"往混合物中加入两杯面粉。","ipa":""},{"point":"stir","ex":"Stir the coffee to dissolve the sugar.","exTrans":"搅拌咖啡让糖溶解。","ipa":""},{"point":"roast","ex":"We plan to roast a turkey for Thanksgiving.","exTrans":"我们计划感恩节烤一只火鸡。","ipa":""},{"point":"fry","ex":"They fry the fish until it is crispy.","exTrans":"他们把鱼炸到酥脆。","ipa":""},{"point":"sauté","ex":"Sauté the garlic in olive oil for one minute.","exTrans":"用橄榄油把大蒜煸炒一分钟。","ipa":""},{"point":"ferment","ex":"Yogurt is milk that has been allowed to ferment.","exTrans":"酸奶是经过发酵的牛奶。","ipa":""},{"point":"boil","ex":"Water will boil at 100 degrees Celsius.","exTrans":"水会在100摄氏度时沸腾。","ipa":""},{"point":"simmer","ex":"Bring the sauce to a boil and then let it simmer.","exTrans":"把酱汁煮开，然后让它慢炖。","ipa":""}];
        const cultureData = [{"en":"In Western cooking culture, particularly influenced by French cuisine, the concept of 'Mise en place' is essential. It means 'putting in place' or 'gathering.' Before turning on the stove or skillet, cooks prepare all their ingredients—washing, peeling, slicing, mincing, and measuring everything into small bowls. This organization prevents burning food while searching for ingredients and makes the cooking process smoother and more enjoyable.","cn":"在受法国烹饪影响深远的西方烹饪文化中，“Mise en place”的概念至关重要。它的意思是“各就各位”或“准备工作”。在打开炉灶或平底锅之前，厨师会准备好所有的食材——清洗、削皮、切片、切碎，并将每样东西量好放入小碗中。这种有条理的组织方式可以防止在寻找食材时烧焦食物，并使烹饪过程更加顺畅和愉快。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"skillet (n.) /ˈskɪlɪt/","back":"平底煎锅"},{"front":"stove (n.) /stoʊv/","back":"炉灶，火炉"},{"front":"pot (n.) /pɒt/","back":"锅 (通常指深锅)"},{"front":"baking dish (n.) /ˈbeɪkɪŋ dɪʃ/","back":"烤盘"},{"front":"blender (n.) /ˈblɛndər/","back":"搅拌机"},{"front":"cutting board (n.) /ˈkʌtɪŋ bɔːrd/","back":"切菜板"},{"front":"grinder (n.) /ˈɡraɪndər/","back":"研磨机"},{"front":"food processor (n.) /fuːd ˈprɒsɛsər/","back":"食品加工机"},{"front":"mixing bowl (n.) /ˈmɪksɪŋ boʊl/","back":"搅拌碗"},{"front":"plastic wrap (n.) /ˈplæstɪk ræp/","back":"保鲜膜"},{"front":"colander (n.) /ˈkʌləndər/","back":"滤水篮，沥水碗"},{"front":"spatula (n.) /ˈspætʃʊlə/","back":"铲子"},{"front":"cut (v.) /kʌt/","back":"切"},{"front":"mince (v.) /mɪns/","back":"切碎 (通常指极细)"},{"front":"slice (v.) /slaɪs/","back":"切片"},{"front":"chop (v.) /tʃɒp/","back":"剁碎，砍"},{"front":"garnish (v.) /ˈɡɑːrnɪʃ/","back":"装饰 (菜肴)"},{"front":"sprinkle (v.) /ˈsprɪŋkəl/","back":"撒"},{"front":"peel (v.) /piːl/","back":"削皮，剥皮"},{"front":"season (v.) /ˈsiːzən/","back":"调味"},{"front":"purée (v.) /pjʊˈreɪ/","back":"制成泥/糊"},{"front":"pour (v.) /pɔːr/","back":"倒"},{"front":"knead (v.) /niːd/","back":"揉 (面团)"},{"front":"add (v.) /æd/","back":"添加"},{"front":"stir (v.) /stɜːr/","back":"搅拌"},{"front":"roast (v.) /roʊst/","back":"烤 (肉、菜)"},{"front":"fry (v.) /fraɪ/","back":"油炸，煎"},{"front":"sauté (v.) /soʊˈteɪ/","back":"煸炒，嫩煎"},{"front":"ferment (v.) /fərˈmɛnt/","back":"发酵"},{"front":"boil (v.) /bɔɪl/","back":"煮沸"},{"front":"simmer (v.) /ˈsɪmər/","back":"煨，慢炖"}],"group_2":[{"front":"平底煎锅","back":"skillet (n.) /ˈskɪlɪt/"},{"front":"炉灶，火炉","back":"stove (n.) /stoʊv/"},{"front":"锅 (通常指深锅)","back":"pot (n.) /pɒt/"},{"front":"烤盘","back":"baking dish (n.) /ˈbeɪkɪŋ dɪʃ/"},{"front":"搅拌机","back":"blender (n.) /ˈblɛndər/"},{"front":"切菜板","back":"cutting board (n.) /ˈkʌtɪŋ bɔːrd/"},{"front":"研磨机","back":"grinder (n.) /ˈɡraɪndər/"},{"front":"食品加工机","back":"food processor (n.) /fuːd ˈprɒsɛsər/"},{"front":"搅拌碗","back":"mixing bowl (n.) /ˈmɪksɪŋ boʊl/"},{"front":"保鲜膜","back":"plastic wrap (n.) /ˈplæstɪk ræp/"},{"front":"滤水篮，沥水碗","back":"colander (n.) /ˈkʌləndər/"},{"front":"铲子","back":"spatula (n.) /ˈspætʃʊlə/"},{"front":"切","back":"cut (v.) /kʌt/"},{"front":"切碎 (通常指极细)","back":"mince (v.) /mɪns/"},{"front":"切片","back":"slice (v.) /slaɪs/"},{"front":"剁碎，砍","back":"chop (v.) /tʃɒp/"},{"front":"装饰 (菜肴)","back":"garnish (v.) /ˈɡɑːrnɪʃ/"},{"front":"撒","back":"sprinkle (v.) /ˈsprɪŋkəl/"},{"front":"削皮，剥皮","back":"peel (v.) /piːl/"},{"front":"调味","back":"season (v.) /ˈsiːzən/"},{"front":"制成泥/糊","back":"purée (v.) /pjʊˈreɪ/"},{"front":"倒","back":"pour (v.) /pɔːr/"},{"front":"揉 (面团)","back":"knead (v.) /niːd/"},{"front":"添加","back":"add (v.) /æd/"},{"front":"搅拌","back":"stir (v.) /stɜːr/"},{"front":"烤 (肉、菜)","back":"roast (v.) /roʊst/"},{"front":"油炸，煎","back":"fry (v.) /fraɪ/"},{"front":"煸炒，嫩煎","back":"sauté (v.) /soʊˈteɪ/"},{"front":"发酵","back":"ferment (v.) /fərˈmɛnt/"},{"front":"煮沸","back":"boil (v.) /bɔɪl/"},{"front":"煨，慢炖","back":"simmer (v.) /ˈsɪmər/"}],"group_3":[{"front":"He cooked the eggs in a cast-iron skillet.","back":"他在一个铸铁平底锅里煮了鸡蛋。"},{"front":"Please turn off the stove after you finish cooking.","back":"做完饭后请关掉炉子。"},{"front":"She made a large pot of vegetable soup.","back":"她做了一大锅蔬菜汤。"},{"front":"Grease the baking dish before adding the batter.","back":"在加入面糊之前先把烤盘涂上油。"},{"front":"I use a blender to make fruit smoothies every morning.","back":"我每天早上用搅拌机做水果冰沙。"},{"front":"Always wash the cutting board after cutting raw meat.","back":"切完生肉后一定要清洗切菜板。"},{"front":"Fresh coffee tastes better if you use a grinder.","back":"如果你用研磨机，新鲜咖啡的味道会更好。"},{"front":"A food processor can chop onions in seconds.","back":"食品加工机可以在几秒钟内切碎洋葱。"},{"front":"Combine the flour and sugar in a large mixing bowl.","back":"在一个大搅拌碗里混合面粉和糖。"},{"front":"Wrap the leftovers in plastic wrap to keep them fresh.","back":"用保鲜膜包好剩菜以保持新鲜。"},{"front":"Wash the grapes in a colander under cold water.","back":"把葡萄放在滤水篮里用冷水冲洗。"},{"front":"Use a rubber spatula to scrape the bowl clean.","back":"用橡胶铲把碗刮干净。"},{"front":"Be careful not to cut your finger with the sharp knife.","back":"小心不要被那把锋利的刀切到手指。"},{"front":"You should mince the ginger for the marinade.","back":"你应该把姜切碎用来做腌料。"},{"front":"Slice the lemon into wedges for the tea.","back":"把柠檬切成块泡茶。"},{"front":"Chop the parsley roughly before adding it to the stew.","back":"在加入炖菜之前把欧芹粗略地切碎。"},{"front":"The chef will garnish the steak with a sprig of rosemary.","back":"厨师会用一枝迷迭香装饰牛排。"},{"front":"Sprinkle some sugar on the strawberries.","back":"在草莓上撒一些糖。"},{"front":"It is easier to peel an orange with your hands.","back":"用手剥橙子皮更容易。"},{"front":"Season the soup with salt and pepper to taste.","back":"根据口味用盐和胡椒给汤调味。"},{"front":"Purée the boiled baby carrots until smooth.","back":"把煮熟的小胡萝卜打成泥直到顺滑。"},{"front":"Pour the milk into the glass carefully.","back":"把牛奶小心地倒进杯子里。"},{"front":"You need to knead the dough until it is elastic.","back":"你需要揉面团直到它有弹性。"},{"front":"Add two cups of flour to the mixture.","back":"往混合物中加入两杯面粉。"},{"front":"Stir the coffee to dissolve the sugar.","back":"搅拌咖啡让糖溶解。"},{"front":"We plan to roast a turkey for Thanksgiving.","back":"我们计划感恩节烤一只火鸡。"},{"front":"They fry the fish until it is crispy.","back":"他们把鱼炸到酥脆。"},{"front":"Sauté the garlic in olive oil for one minute.","back":"用橄榄油把大蒜煸炒一分钟。"},{"front":"Yogurt is milk that has been allowed to ferment.","back":"酸奶是经过发酵的牛奶。"},{"front":"Water will boil at 100 degrees Celsius.","back":"水会在100摄氏度时沸腾。"},{"front":"Bring the sauce to a boil and then let it simmer.","back":"把酱汁煮开，然后让它慢炖。"}],"group_4":[{"front":"他在一个铸铁平底锅里煮了鸡蛋。","back":"He cooked the eggs in a cast-iron skillet."},{"front":"做完饭后请关掉炉子。","back":"Please turn off the stove after you finish cooking."},{"front":"她做了一大锅蔬菜汤。","back":"She made a large pot of vegetable soup."},{"front":"在加入面糊之前先把烤盘涂上油。","back":"Grease the baking dish before adding the batter."},{"front":"我每天早上用搅拌机做水果冰沙。","back":"I use a blender to make fruit smoothies every morning."},{"front":"切完生肉后一定要清洗切菜板。","back":"Always wash the cutting board after cutting raw meat."},{"front":"如果你用研磨机，新鲜咖啡的味道会更好。","back":"Fresh coffee tastes better if you use a grinder."},{"front":"食品加工机可以在几秒钟内切碎洋葱。","back":"A food processor can chop onions in seconds."},{"front":"在一个大搅拌碗里混合面粉和糖。","back":"Combine the flour and sugar in a large mixing bowl."},{"front":"用保鲜膜包好剩菜以保持新鲜。","back":"Wrap the leftovers in plastic wrap to keep them fresh."},{"front":"把葡萄放在滤水篮里用冷水冲洗。","back":"Wash the grapes in a colander under cold water."},{"front":"用橡胶铲把碗刮干净。","back":"Use a rubber spatula to scrape the bowl clean."},{"front":"小心不要被那把锋利的刀切到手指。","back":"Be careful not to cut your finger with the sharp knife."},{"front":"你应该把姜切碎用来做腌料。","back":"You should mince the ginger for the marinade."},{"front":"把柠檬切成块泡茶。","back":"Slice the lemon into wedges for the tea."},{"front":"在加入炖菜之前把欧芹粗略地切碎。","back":"Chop the parsley roughly before adding it to the stew."},{"front":"厨师会用一枝迷迭香装饰牛排。","back":"The chef will garnish the steak with a sprig of rosemary."},{"front":"在草莓上撒一些糖。","back":"Sprinkle some sugar on the strawberries."},{"front":"用手剥橙子皮更容易。","back":"It is easier to peel an orange with your hands."},{"front":"根据口味用盐和胡椒给汤调味。","back":"Season the soup with salt and pepper to taste."},{"front":"把煮熟的小胡萝卜打成泥直到顺滑。","back":"Purée the boiled baby carrots until smooth."},{"front":"把牛奶小心地倒进杯子里。","back":"Pour the milk into the glass carefully."},{"front":"你需要揉面团直到它有弹性。","back":"You need to knead the dough until it is elastic."},{"front":"往混合物中加入两杯面粉。","back":"Add two cups of flour to the mixture."},{"front":"搅拌咖啡让糖溶解。","back":"Stir the coffee to dissolve the sugar."},{"front":"我们计划感恩节烤一只火鸡。","back":"We plan to roast a turkey for Thanksgiving."},{"front":"他们把鱼炸到酥脆。","back":"They fry the fish until it is crispy."},{"front":"用橄榄油把大蒜煸炒一分钟。","back":"Sauté the garlic in olive oil for one minute."},{"front":"酸奶是经过发酵的牛奶。","back":"Yogurt is milk that has been allowed to ferment."},{"front":"水会在100摄氏度时沸腾。","back":"Water will boil at 100 degrees Celsius."},{"front":"把酱汁煮开，然后让它慢炖。","back":"Bring the sauce to a boil and then let it simmer."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What is the first step mentioned for preparing the potatoes?","options":["A. Boil them","B. Peel them using a cutting board","C. Roast them immediately","D. Mash them without peeling"],"ans":"B. Peel them using a cutting board"},{"type":"fill","q":"The speaker asks to _____ the carrots thinly.","options":["A. chop","B. slice","C. mince","D. purée"],"ans":"B. slice"},{"type":"tf","q":"The skillet is heated on the stove to a high temperature.","options":["True","False"],"ans":"False"},{"type":"mc","q":"Which appliance is used to chop the walnuts?","options":["A. Blender","B. Grinder","C. Food processor","D. Mixer"],"ans":"C. Food processor"},{"type":"mc","q":"Where is the chicken placed for cooking?","options":["A. In a pot","B. In a baking dish","C. On a skillet","D. In a colander"],"ans":"B. In a baking dish"},{"type":"fill","q":"You should use a _____ to drain the water from the pasta.","options":["A. pot","B. colander","C. bowl","D. spatula"],"ans":"B. colander"},{"type":"tf","q":"The sauce should simmer on low heat.","options":["True","False"],"ans":"True"},{"type":"mc","q":"What is used to cover the dough?","options":["A. A lid","B. Plastic wrap","C. A towel","D. A baking sheet"],"ans":"B. Plastic wrap"},{"type":"mc","q":"What verb is used for preparing the cucumbers?","options":["A. Fry","B. Ferment","C. Roast","D. Boil"],"ans":"B. Ferment"},{"type":"mc","q":"What is the final step for the soup?","options":["A. Stir it","B. Pour it","C. Garnish it","D. Strain it"],"ans":"C. Garnish it"}]; 
        let vocabQuestions = [{"type":"mc","q":"Which tool is best for frying eggs?","options":["A. colander","B. skillet","C. blender","D. grinder"],"ans":"B. skillet"},{"type":"fill","q":"We cook food inside the kitchen on a large appliance called a _____.","options":["A. stove","B. pot","C. spatula","D. bowl"],"ans":"A. stove"},{"type":"mc","q":"If you want to make soup, you should use a large _____.","options":["A. skillet","B. pot","C. cutting board","D. spatula"],"ans":"B. pot"},{"type":"mc","q":"What dish is specifically designed to go inside an oven?","options":["A. frying pan","B. plastic wrap","C. baking dish","D. cutting board"],"ans":"C. baking dish"},{"type":"fill","q":"To make a liquid smoothie from fruit, use a _____.","options":["A. blender","B. stove","C. colander","D. baking dish"],"ans":"A. blender"},{"type":"mc","q":"You should place vegetables on a _____ before using a knife.","options":["A. pot","B. stove","C. cutting board","D. colander"],"ans":"C. cutting board"},{"type":"mc","q":"Which machine is used to crush coffee beans or spices?","options":["A. grinder","B. peeler","C. skillet","D. boiler"],"ans":"A. grinder"},{"type":"mc","q":"For chopping large amounts of vegetables quickly, use a _____.","options":["A. food processor","B. spoon","C. pot","D. baking dish"],"ans":"A. food processor"},{"type":"fill","q":"Mix the salad ingredients together in a large _____.","options":["A. mixing bowl","B. stove","C. knife","D. grinder"],"ans":"A. mixing bowl"},{"type":"mc","q":"What transparent material is used to cover food?","options":["A. aluminum foil","B. plastic wrap","C. paper towel","D. cloth"],"ans":"B. plastic wrap"},{"type":"mc","q":"Which tool has holes and is used to wash vegetables?","options":["A. colander","B. bowl","C. skillet","D. pan"],"ans":"A. colander"},{"type":"fill","q":"Use a _____ to flip pancakes in the pan.","options":["A. spoon","B. fork","C. spatula","D. knife"],"ans":"C. spatula"},{"type":"mc","q":"The general verb for using a knife is _____.","options":["A. smash","B. cut","C. break","D. hit"],"ans":"B. cut"},{"type":"mc","q":"To cut garlic into very tiny pieces is to _____ it.","options":["A. slice","B. mince","C. peel","D. roast"],"ans":"B. mince"},{"type":"fill","q":"Please _____ the bread into thin pieces for sandwiches.","options":["A. slice","B. mash","C. boil","D. stir"],"ans":"A. slice"},{"type":"mc","q":"To cut food into small cubes is to _____.","options":["A. chop","B. grate","C. pour","D. knead"],"ans":"A. chop"},{"type":"mc","q":"To add a decoration to a finished dish is to _____.","options":["A. garnish","B. destroy","C. cook","D. boil"],"ans":"A. garnish"},{"type":"mc","q":"To drop small pieces (like salt) over food is to _____.","options":["A. pour","B. sprinkle","C. dip","D. slice"],"ans":"B. sprinkle"},{"type":"fill","q":"You must _____ the skin off the banana before eating it.","options":["A. peel","B. kill","C. cook","D. fry"],"ans":"A. peel"},{"type":"mc","q":"To add flavor like salt, pepper, or herbs is to _____.","options":["A. season","B. wash","C. dry","D. freeze"],"ans":"A. season"},{"type":"mc","q":"To mix ingredients into a liquid form using a machine is to _____.","options":["A. chop","B. purée","C. bake","D. roast"],"ans":"B. purée"},{"type":"fill","q":"Please _____ the water into the glass.","options":["A. pour","B. throw","C. eat","D. slice"],"ans":"A. pour"},{"type":"mc","q":"What do you do with your hands to prepare bread dough?","options":["A. knead","B. drink","C. sauté","D. boil"],"ans":"A. knead"},{"type":"mc","q":"To put an extra ingredient into the pot is to _____ it.","options":["A. remove","B. add","C. clean","D. peel"],"ans":"B. add"},{"type":"mc","q":"To mix food with a spoon in a circular motion is to _____.","options":["A. stir","B. shake","C. cut","D. fry"],"ans":"A. stir"},{"type":"fill","q":"We usually _____ a chicken in the oven for a long time.","options":["A. roast","B. boil","C. ferment","D. pour"],"ans":"A. roast"},{"type":"mc","q":"To cook food in hot oil is to _____.","options":["A. freeze","B. fry","C. wet","D. dry"],"ans":"B. fry"},{"type":"mc","q":"To cook quickly with a little oil is to _____.","options":["A. sauté","B. boil","C. bake","D. steam"],"ans":"A. sauté"},{"type":"mc","q":"Kimchi is cabbage that we _____ to preserve it.","options":["A. burn","B. ferment","C. throw","D. break"],"ans":"B. ferment"},{"type":"fill","q":"Water will _____ when it reaches 100 degrees Celsius.","options":["A. boil","B. freeze","C. melt","D. stop"],"ans":"A. boil"},{"type":"mc","q":"To cook slowly at a lower heat just below boiling is to _____.","options":["A. explode","B. simmer","C. rush","D. cut"],"ans":"B. simmer"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>