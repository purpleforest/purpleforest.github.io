<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigating Healthcare and Pharmacies in BC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Navigating Healthcare and Pharmacies in BC</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Good morning, I would like to fill this prescription for my asthma.","cn":"早上好，我想照这张处方抓药治疗我的哮喘。"},{"en":"Sure, let me take a look at the doctor's note.","cn":"好的，让我看看医生的处方。"},{"en":"While you are processing that, could you check if I am covered by PharmaCare?","cn":"你在处理的时候，能帮我查查我是否有医药保健计划的保险覆盖吗？"},{"en":"I can check that for you right now.","cn":"我现在就可以为你查一下。"},{"en":"It looks like you are registered for Fair PharmaCare.","cn":"看来你已经注册了公平医药保健计划。"},{"en":"That is great, so the cost depends on my family income, right?","cn":"太好了，所以费用是根据我的家庭收入决定的，对吗？"},{"en":"Exactly, lower income families receive more financial assistance.","cn":"没错，低收入家庭会得到更多的经济援助。"},{"en":"Regarding this new medication, what is the dosage?","cn":"关于这种新药，剂量是多少？"},{"en":"You need to inhale two puffs every four hours.","cn":"你需要每四小时吸入两口。"},{"en":"Could you explain what you mean by inhale?","cn":"你能解释一下吸入是什么意思吗？"},{"en":"It means to breathe the medicine into your airways using the puffer.","cn":"意思是用喷雾器把药吸进你的呼吸道里。"},{"en":"I understand, are there any side effects I should watch for?","cn":"我明白了，有什么副作用我需要注意的吗？"},{"en":"You might feel a slight headache, but it is usually not severe.","cn":"你可能会感到轻微的头痛，但通常并不严重。"},{"en":"Also, I have a cold sore on my lip.","cn":"另外，我嘴唇上长了个唇疱疹。"},{"en":"Can you recommend something over-the-counter for that?","cn":"你能推荐一些非处方药来治疗它吗？"},{"en":"Yes, we have a cream in aisle three that helps with healing.","cn":"有的，我们在三号通道有一种药膏有助于愈合。"},{"en":"Please remember that hygiene is extremely important to prevent spreading it.","cn":"请记住，卫生对于防止传染非常重要。"},{"en":"Should I apply the cream with my finger?","cn":"我应该用手指涂药膏吗？"},{"en":"No, use cotton swabs to keep the area clean.","cn":"不，要用棉签以保持该区域清洁。"},{"en":"Just to confirm, I use the puffer daily and the cream only if symptoms persist?","cn":"确认一下，我每天用喷雾器，而药膏只有在症状持续时才用？"},{"en":"That is correct, and read the instructions on the box carefully.","cn":"没错，还要仔细阅读盒子上的说明。"}];
        const knowledgePoints = [{"cat":"Noun","point":"Prescription","cn":"医生开具的药方","ex":"The doctor wrote a prescription for antibiotics to treat the infection.","exTrans":"医生开了一张抗生素的处方来治疗感染。","ipa":""},{"cat":"Noun","point":"Pharmacist","cn":"药剂师","ex":"You can ask the pharmacist if this medicine should be taken with food.","exTrans":"你可以问药剂师这种药是否需要随餐服用。","ipa":""},{"cat":"Adjective/Phrase","point":"Over-the-counter","cn":"非处方药","ex":"Aspirin is an over-the-counter drug available at any pharmacy.","exTrans":"阿司匹林是一种可以在任何药店买到的非处方药。","ipa":""},{"cat":"Noun","point":"Dosage","cn":"剂量","ex":"The correct dosage is one tablet twice a day.","exTrans":"正确的剂量是每天两次，每次一片。","ipa":""},{"cat":"Noun","point":"Side Effect","cn":"副作用","ex":"Drowsiness is a common side effect of this allergy medication.","exTrans":"嗜睡是这种过敏药物常见的副作用。","ipa":""},{"cat":"Verb","point":"Inhale","cn":"吸入","ex":"Please inhale deeply while the doctor listens to your lungs.","exTrans":"医生听诊肺部时请深吸气。","ipa":""},{"cat":"Noun","point":"Airways","cn":"呼吸道","ex":"Asthma can cause your airways to narrow and make breathing difficult.","exTrans":"哮喘会导致呼吸道变窄，使呼吸困难。","ipa":""},{"cat":"Noun","point":"Puffer","cn":"喷雾器（吸入器）","ex":"He always carries his puffer in case he has an asthma attack.","exTrans":"他总是随身携带喷雾器，以防哮喘发作。","ipa":""},{"cat":"Noun","point":"Hygiene","cn":"卫生","ex":"Good hand hygiene prevents the spread of flu viruses.","exTrans":"良好的手部卫生可以防止流感病毒的传播。","ipa":""},{"cat":"Noun","point":"Symptom","cn":"症状","ex":"Fever is a common symptom of the flu.","exTrans":"发烧是流感的常见症状。","ipa":""},{"cat":"Noun","point":"Ailment","cn":"小病，不适","ex":"Pharmacists can treat minor ailments like rashes or insect bites.","exTrans":"药剂师可以治疗皮疹或蚊虫叮咬等小病。","ipa":""},{"cat":"Adjective","point":"Eligible","cn":"符合条件的，合格的","ex":"Only residents with MSP coverage are eligible for this program.","exTrans":"只有拥有MSP保险的居民才有资格参加此计划。","ipa":""},{"cat":"Verb","point":"Register","cn":"注册，登记","ex":"You need to register online to receive financial assistance.","exTrans":"你需要在线注册才能获得经济援助。","ipa":""},{"cat":"Noun","point":"Coverage","cn":"保险覆盖范围","ex":"My insurance coverage includes dental and vision care.","exTrans":"我的保险范围包括牙科和眼科护理。","ipa":""},{"cat":"Verb","point":"Clarify","cn":"澄清，阐明","ex":"Could you clarify what you mean by 'frequent use'?","exTrans":"你能解释一下你说的“频繁使用”是什么意思吗？","ipa":""},{"cat":"Verb","point":"Confirm","cn":"确认","ex":"I want to confirm the appointment time before I leave.","exTrans":"我想在离开前确认一下预约时间。","ipa":""},{"cat":"Noun","point":"Frequency","cn":"频率","ex":"The frequency of the bus service decreases at night.","exTrans":"晚间公交车的班次频率会降低。","ipa":""},{"cat":"Adjective","point":"Severe","cn":"严重的","ex":"If the pain becomes severe, go to the hospital immediately.","exTrans":"如果疼痛变得严重，请立即去医院。","ipa":""},{"cat":"Noun","point":"Antibiotic","cn":"抗生素","ex":"You must finish the full course of antibiotics even if you feel better.","exTrans":"即使感觉好转，你也必须服完整个疗程的抗生素。","ipa":""},{"cat":"Noun","point":"Instruction","cn":"说明，指示","ex":"Read the instruction manual before using the device.","exTrans":"使用该设备前请阅读说明书。","ipa":""},{"cat":"Verb","point":"Consult","cn":"咨询","ex":"You should consult a doctor if the cough persists for more than a week.","exTrans":"如果咳嗽持续超过一周，你应该咨询医生。","ipa":""},{"cat":"Noun","point":"Assistance","cn":"援助，帮助","ex":"The government provides financial assistance for low-income families.","exTrans":"政府为低收入家庭提供经济援助。","ipa":""},{"cat":"Noun","point":"Income","cn":"收入","ex":"Your subsidy level is based on your annual family income.","exTrans":"你的补贴水平取决于你的家庭年收入。","ipa":""},{"cat":"Noun","point":"Medication","cn":"药物","ex":"Keep this medication out of reach of children.","exTrans":"请将此药物放在儿童接触不到的地方。","ipa":""},{"cat":"Noun","point":"Cotton Swab","cn":"棉签","ex":"Use a cotton swab to clean the wound gently.","exTrans":"用棉签轻轻清洁伤口。","ipa":""},{"cat":"Noun","point":"Cold Sore","cn":"唇疱疹","ex":"A cold sore is a viral infection that appears on the lip.","exTrans":"唇疱疹是一种出现在嘴唇上的病毒感染。","ipa":""}];
        const cultureData = [{"en":"In British Columbia, pharmacists do more than just dispense medication. They are accessible healthcare professionals who can provide advice on minor ailments, explain side effects, and instruct on proper dosage. Residents must present a physical prescription from a doctor, midwife, or nurse practitioner for restricted drugs. BC also offers 'Fair PharmaCare,' a financial assistance program based on net family income to help cover the cost of eligible prescription drugs and medical supplies. You must have MSP coverage to register.","cn":"在不列颠哥伦比亚省（BC省），药剂师不仅仅是分发药物。他们是您可以直接接触到的医疗专业人员，可以就轻微疾病提供建议，解释副作用，并指导正确的用量。对于受管制的药物，居民必须出示医生、助产士或执业护士开具的纸质处方。BC省还提供“公平医药保健计划”（Fair PharmaCare），这是一项基于家庭净收入的财政援助计划，旨在帮助支付符合条件的处方药和医疗用品的费用。您必须拥有MSP（医疗服务计划）保险才能注册。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"Prescription (n.) /prɪˈskrɪpʃən/","back":"医生开具的药方"},{"front":"Pharmacist (n.) /ˈfɑːrməsɪst/","back":"药剂师"},{"front":"Over-the-counter (adj.) /ˌoʊvərðəˈkaʊntər/","back":"非处方药"},{"front":"Dosage (n.) /ˈdoʊsɪdʒ/","back":"剂量"},{"front":"Side Effect (n.) /ˈsaɪd ɪˌfɛkt/","back":"副作用"},{"front":"Inhale (v.) /ɪnˈheɪl/","back":"吸入"},{"front":"Airways (n.) /ˈɛrˌweɪz/","back":"呼吸道"},{"front":"Puffer (n.) /ˈpʌfər/","back":"喷雾器（吸入器）"},{"front":"Hygiene (n.) /ˈhaɪdʒiːn/","back":"卫生"},{"front":"Symptom (n.) /ˈsɪmptəm/","back":"症状"},{"front":"Ailment (n.) /ˈeɪlmənt/","back":"小病，不适"},{"front":"Eligible (adj.) /ˈɛlɪdʒəbəl/","back":"符合条件的，合格的"},{"front":"Register (v.) /ˈrɛdʒɪstər/","back":"注册，登记"},{"front":"Coverage (n.) /ˈkʌvərɪdʒ/","back":"保险覆盖范围"},{"front":"Clarify (v.) /ˈklærəˌfaɪ/","back":"澄清，阐明"},{"front":"Confirm (v.) /kənˈfɜːrm/","back":"确认"},{"front":"Frequency (n.) /ˈfriːkwənsi/","back":"频率"},{"front":"Severe (adj.) /səˈvɪr/","back":"严重的"},{"front":"Antibiotic (n.) /ˌæntibaɪˈɒtɪk/","back":"抗生素"},{"front":"Instruction (n.) /ɪnˈstrʌkʃən/","back":"说明，指示"},{"front":"Consult (v.) /kənˈsʌlt/","back":"咨询"},{"front":"Assistance (n.) /əˈsɪstəns/","back":"援助，帮助"},{"front":"Income (n.) /ˈɪnkʌm/","back":"收入"},{"front":"Medication (n.) /ˌmɛdɪˈkeɪʃən/","back":"药物"},{"front":"Cotton Swab (n.) /ˈkɑːtn swɑːb/","back":"棉签"},{"front":"Cold Sore (n.) /koʊld sɔːr/","back":"唇疱疹"}],"group_2":[{"front":"医生开具的药方","back":"Prescription (n.) /prɪˈskrɪpʃən/"},{"front":"药剂师","back":"Pharmacist (n.) /ˈfɑːrməsɪst/"},{"front":"非处方药","back":"Over-the-counter (adj.) /ˌoʊvərðəˈkaʊntər/"},{"front":"剂量","back":"Dosage (n.) /ˈdoʊsɪdʒ/"},{"front":"副作用","back":"Side Effect (n.) /ˈsaɪd ɪˌfɛkt/"},{"front":"吸入","back":"Inhale (v.) /ɪnˈheɪl/"},{"front":"呼吸道","back":"Airways (n.) /ˈɛrˌweɪz/"},{"front":"喷雾器（吸入器）","back":"Puffer (n.) /ˈpʌfər/"},{"front":"卫生","back":"Hygiene (n.) /ˈhaɪdʒiːn/"},{"front":"症状","back":"Symptom (n.) /ˈsɪmptəm/"},{"front":"小病，不适","back":"Ailment (n.) /ˈeɪlmənt/"},{"front":"符合条件的，合格的","back":"Eligible (adj.) /ˈɛlɪdʒəbəl/"},{"front":"注册，登记","back":"Register (v.) /ˈrɛdʒɪstər/"},{"front":"保险覆盖范围","back":"Coverage (n.) /ˈkʌvərɪdʒ/"},{"front":"澄清，阐明","back":"Clarify (v.) /ˈklærəˌfaɪ/"},{"front":"确认","back":"Confirm (v.) /kənˈfɜːrm/"},{"front":"频率","back":"Frequency (n.) /ˈfriːkwənsi/"},{"front":"严重的","back":"Severe (adj.) /səˈvɪr/"},{"front":"抗生素","back":"Antibiotic (n.) /ˌæntibaɪˈɒtɪk/"},{"front":"说明，指示","back":"Instruction (n.) /ɪnˈstrʌkʃən/"},{"front":"咨询","back":"Consult (v.) /kənˈsʌlt/"},{"front":"援助，帮助","back":"Assistance (n.) /əˈsɪstəns/"},{"front":"收入","back":"Income (n.) /ˈɪnkʌm/"},{"front":"药物","back":"Medication (n.) /ˌmɛdɪˈkeɪʃən/"},{"front":"棉签","back":"Cotton Swab (n.) /ˈkɑːtn swɑːb/"},{"front":"唇疱疹","back":"Cold Sore (n.) /koʊld sɔːr/"}],"group_3":[{"front":"The doctor wrote a prescription for antibiotics to treat the infection.","back":"医生开了一张抗生素的处方来治疗感染。"},{"front":"You can ask the pharmacist if this medicine should be taken with food.","back":"你可以问药剂师这种药是否需要随餐服用。"},{"front":"Aspirin is an over-the-counter drug available at any pharmacy.","back":"阿司匹林是一种可以在任何药店买到的非处方药。"},{"front":"The correct dosage is one tablet twice a day.","back":"正确的剂量是每天两次，每次一片。"},{"front":"Drowsiness is a common side effect of this allergy medication.","back":"嗜睡是这种过敏药物常见的副作用。"},{"front":"Please inhale deeply while the doctor listens to your lungs.","back":"医生听诊肺部时请深吸气。"},{"front":"Asthma can cause your airways to narrow and make breathing difficult.","back":"哮喘会导致呼吸道变窄，使呼吸困难。"},{"front":"He always carries his puffer in case he has an asthma attack.","back":"他总是随身携带喷雾器，以防哮喘发作。"},{"front":"Good hand hygiene prevents the spread of flu viruses.","back":"良好的手部卫生可以防止流感病毒的传播。"},{"front":"Fever is a common symptom of the flu.","back":"发烧是流感的常见症状。"},{"front":"Pharmacists can treat minor ailments like rashes or insect bites.","back":"药剂师可以治疗皮疹或蚊虫叮咬等小病。"},{"front":"Only residents with MSP coverage are eligible for this program.","back":"只有拥有MSP保险的居民才有资格参加此计划。"},{"front":"You need to register online to receive financial assistance.","back":"你需要在线注册才能获得经济援助。"},{"front":"My insurance coverage includes dental and vision care.","back":"我的保险范围包括牙科和眼科护理。"},{"front":"Could you clarify what you mean by 'frequent use'?","back":"你能解释一下你说的“频繁使用”是什么意思吗？"},{"front":"I want to confirm the appointment time before I leave.","back":"我想在离开前确认一下预约时间。"},{"front":"The frequency of the bus service decreases at night.","back":"晚间公交车的班次频率会降低。"},{"front":"If the pain becomes severe, go to the hospital immediately.","back":"如果疼痛变得严重，请立即去医院。"},{"front":"You must finish the full course of antibiotics even if you feel better.","back":"即使感觉好转，你也必须服完整个疗程的抗生素。"},{"front":"Read the instruction manual before using the device.","back":"使用该设备前请阅读说明书。"},{"front":"You should consult a doctor if the cough persists for more than a week.","back":"如果咳嗽持续超过一周，你应该咨询医生。"},{"front":"The government provides financial assistance for low-income families.","back":"政府为低收入家庭提供经济援助。"},{"front":"Your subsidy level is based on your annual family income.","back":"你的补贴水平取决于你的家庭年收入。"},{"front":"Keep this medication out of reach of children.","back":"请将此药物放在儿童接触不到的地方。"},{"front":"Use a cotton swab to clean the wound gently.","back":"用棉签轻轻清洁伤口。"},{"front":"A cold sore is a viral infection that appears on the lip.","back":"唇疱疹是一种出现在嘴唇上的病毒感染。"}],"group_4":[{"front":"医生开了一张抗生素的处方来治疗感染。","back":"The doctor wrote a prescription for antibiotics to treat the infection."},{"front":"你可以问药剂师这种药是否需要随餐服用。","back":"You can ask the pharmacist if this medicine should be taken with food."},{"front":"阿司匹林是一种可以在任何药店买到的非处方药。","back":"Aspirin is an over-the-counter drug available at any pharmacy."},{"front":"正确的剂量是每天两次，每次一片。","back":"The correct dosage is one tablet twice a day."},{"front":"嗜睡是这种过敏药物常见的副作用。","back":"Drowsiness is a common side effect of this allergy medication."},{"front":"医生听诊肺部时请深吸气。","back":"Please inhale deeply while the doctor listens to your lungs."},{"front":"哮喘会导致呼吸道变窄，使呼吸困难。","back":"Asthma can cause your airways to narrow and make breathing difficult."},{"front":"他总是随身携带喷雾器，以防哮喘发作。","back":"He always carries his puffer in case he has an asthma attack."},{"front":"良好的手部卫生可以防止流感病毒的传播。","back":"Good hand hygiene prevents the spread of flu viruses."},{"front":"发烧是流感的常见症状。","back":"Fever is a common symptom of the flu."},{"front":"药剂师可以治疗皮疹或蚊虫叮咬等小病。","back":"Pharmacists can treat minor ailments like rashes or insect bites."},{"front":"只有拥有MSP保险的居民才有资格参加此计划。","back":"Only residents with MSP coverage are eligible for this program."},{"front":"你需要在线注册才能获得经济援助。","back":"You need to register online to receive financial assistance."},{"front":"我的保险范围包括牙科和眼科护理。","back":"My insurance coverage includes dental and vision care."},{"front":"你能解释一下你说的“频繁使用”是什么意思吗？","back":"Could you clarify what you mean by 'frequent use'?"},{"front":"我想在离开前确认一下预约时间。","back":"I want to confirm the appointment time before I leave."},{"front":"晚间公交车的班次频率会降低。","back":"The frequency of the bus service decreases at night."},{"front":"如果疼痛变得严重，请立即去医院。","back":"If the pain becomes severe, go to the hospital immediately."},{"front":"即使感觉好转，你也必须服完整个疗程的抗生素。","back":"You must finish the full course of antibiotics even if you feel better."},{"front":"使用该设备前请阅读说明书。","back":"Read the instruction manual before using the device."},{"front":"如果咳嗽持续超过一周，你应该咨询医生。","back":"You should consult a doctor if the cough persists for more than a week."},{"front":"政府为低收入家庭提供经济援助。","back":"The government provides financial assistance for low-income families."},{"front":"你的补贴水平取决于你的家庭年收入。","back":"Your subsidy level is based on your annual family income."},{"front":"请将此药物放在儿童接触不到的地方。","back":"Keep this medication out of reach of children."},{"front":"用棉签轻轻清洁伤口。","back":"Use a cotton swab to clean the wound gently."},{"front":"唇疱疹是一种出现在嘴唇上的病毒感染。","back":"A cold sore is a viral infection that appears on the lip."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What medical condition is the patient treating with the prescription?","options":["A. A headache","B. Asthma","C. A broken leg"],"ans":"B. Asthma"},{"type":"tf","q":"The patient is not registered for any PharmaCare plan.","options":["True","False"],"ans":"False"},{"type":"fill","q":"The pharmacist says the cost of medication depends on family ______.","options":[],"ans":"income"},{"type":"mc","q":"How often does the patient need to use the inhaler?","options":["A. Once a day","B. Every four hours","C. Only when sick"],"ans":"B. Every four hours"},{"type":"mc","q":"What implies that the medicine for the cold sore does not need a prescription?","options":["A. The patient asks for something over-the-counter.","B. The pharmacist calls the doctor.","C. The medicine is very expensive."],"ans":"A. The patient asks for something over-the-counter."},{"type":"tf","q":"The pharmacist advises applying the cream with a finger.","options":["True","False"],"ans":"False"},{"type":"dict","q":"Please write down the sentence you hear: 'You need to inhale two puffs every four hours.'","options":[],"ans":"You need to inhale two puffs every four hours.","srcText":"You need to inhale two puffs every four hours."},{"type":"mc","q":"What is a potential side effect mentioned?","options":["A. Dizziness","B. Slight headache","C. Stomach pain"],"ans":"B. Slight headache"},{"type":"mc","q":"What tool does the pharmacist recommend for applying the cream?","options":["A. A toothbrush","B. Cotton swabs","C. A bandage"],"ans":"B. Cotton swabs"},{"type":"tf","q":"The patient asks confirming questions to ensure they understand.","options":["True","False"],"ans":"True"}]; 
        let vocabQuestions = [{"type":"mc","q":"If you are 'eligible' for a program, it means you...","options":["A. Cannot join it","B. Meet the requirements to join","C. Need to pay a fine"],"ans":"B. Meet the requirements to join"},{"type":"fill","q":"A doctor's written note for medicine is called a ______.","options":[],"ans":"prescription"},{"type":"tf","q":"An 'over-the-counter' drug requires a doctor's permission to buy.","options":["True","False"],"ans":"False"},{"type":"mc","q":"Which word refers to the tubes that carry air into your lungs?","options":["A. Airways","B. Veins","C. Muscles"],"ans":"A. Airways"},{"type":"fill","q":"The professional who prepares and sells medicines is a ______.","options":[],"ans":"pharmacist"},{"type":"mc","q":"What is a 'side effect'?","options":["A. The main benefit of a drug","B. An unintended reaction to a drug","C. The price of the drug"],"ans":"B. An unintended reaction to a drug"},{"type":"tf","q":"To 'inhale' means to breathe out.","options":["True","False"],"ans":"False"},{"type":"fill","q":"A device used to deliver asthma medication into the lungs is a ______.","options":[],"ans":"puffer"},{"type":"mc","q":"Washing hands regularly is an example of good...","options":["A. Diet","B. Hygiene","C. Exercise"],"ans":"B. Hygiene"},{"type":"mc","q":"A physical or mental feature that indicates a condition of disease is a...","options":["A. Symptom","B. Cure","C. Vitamin"],"ans":"A. Symptom"},{"type":"fill","q":"A minor illness or health problem is often called an ______.","options":[],"ans":"ailment"},{"type":"tf","q":"When you 'register' for something, you put your name on an official list.","options":["True","False"],"ans":"True"},{"type":"mc","q":"The amount of protection given by an insurance plan is called...","options":["A. Coverage","B. Dosage","C. Frequency"],"ans":"A. Coverage"},{"type":"fill","q":"If you don't understand, ask the speaker to ______ their statement.","options":[],"ans":"clarify"},{"type":"mc","q":"To establish the truth or correctness of something is to...","options":["A. Confirm","B. Guess","C. Ignore"],"ans":"A. Confirm"},{"type":"mc","q":"How often something happens is its...","options":["A. History","B. Frequency","C. Method"],"ans":"B. Frequency"},{"type":"tf","q":"A 'severe' headache is very mild and barely noticeable.","options":["True","False"],"ans":"False"},{"type":"fill","q":"A medicine used to destroy bacteria is an ______.","options":[],"ans":"antibiotic"},{"type":"mc","q":"Detailed information telling you how to do something are...","options":["A. Instructions","B. Opinions","C. Stories"],"ans":"A. Instructions"},{"type":"mc","q":"To seek information or advice from an expert is to...","options":["A. Consult","B. Instruct","C. Command"],"ans":"A. Consult"},{"type":"fill","q":"Financial ______ helps people pay for things they cannot afford.","options":[],"ans":"assistance"},{"type":"mc","q":"Money received on a regular basis for work is your...","options":["A. Expense","B. Income","C. Tax"],"ans":"B. Income"},{"type":"fill","q":"Another word for medicine or drugs used for treatment is ______.","options":[],"ans":"medication"},{"type":"mc","q":"A small stick with soft material at the end used for cleaning is a...","options":["A. Needle","B. Cotton Swab","C. Spoon"],"ans":"B. Cotton Swab"},{"type":"tf","q":"A cold sore is usually found on the lips.","options":["True","False"],"ans":"True"},{"type":"fill","q":"The amount of medicine you take at one time is the ______.","options":[],"ans":"dosage"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>