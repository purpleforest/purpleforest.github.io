<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Shopping Nightmare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Online Shopping Nightmare</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Awesome! Sounds so easy.","cn":"太棒了！听起来很简单。"},{"en":"I’ve only had one experience with shopping online.","cn":"我只有过一次网购经历。"},{"en":"And it was terrible.","cn":"而且那次经历很糟糕。"},{"en":"I bought a pair of pants and they didn’t fit properly.","cn":"我买了一条裤子，但不太合身。"},{"en":"I wanted to send them back.","cn":"我想把它们退回去。"},{"en":"But it was really difficult to find the return policy on the company website.","cn":"但在公司网站上很难找到退货政策。"},{"en":"When I eventually did find it, I realized I had to pay for the return shipping.","cn":"当我最终找到时，我意识到我必须支付退货运费。"},{"en":"The shipping cost was $15 and the pants were only $25.","cn":"运费是15美元，而裤子只要25美元。"},{"en":"What a rip-off!","cn":"真是敲竹杠！"},{"en":"And it took over a month to get my money back.","cn":"而且花了一个多月才拿到退款。"},{"en":"I even called their customer service line a couple of times.","cn":"我甚至给他们的客服热线打了几次电话。"},{"en":"It was always busy.","cn":"电话总是占线。"},{"en":"I decided after that that I would never buy anything online again.","cn":"之后我就决定再也不网购了。"},{"en":"When I did more investigating, I realized there was no physical address for the company.","cn":"当我做了更多调查后，我发现这家公司没有实体地址。"},{"en":"I also noticed so many spelling mistakes on their website.","cn":"我还注意到他们网站上有很多拼写错误。"},{"en":"So I started to become suspicious.","cn":"所以我开始怀疑起来。"},{"en":"I should have paid closer attention to those details.","cn":"我本应该更密切关注这些细节。"},{"en":"Through all the fine-print, I figured out the company was overseas somewhere.","cn":"通过阅读那些细则，我发现这家公司是在海外某地。"},{"en":"Sounds like it wasn’t a reputable site.","cn":"听起来那不像是个信誉良好的网站。"},{"en":"It really wasn’t worth all the hassle.","cn":"真是不值得这么麻烦。"},{"en":"If you change your mind about online shopping, you should try The Blue Nile.","cn":"如果你改变了对网购的看法，你应该试试“蓝色尼罗河”。"},{"en":"I give it 5 stars!","cn":"我给它五星好评！"}];
        const knowledgePoints = [{"cat":"Phrase","point":"fit properly","cn":"合身；尺寸合适","ex":"This shirt is too tight, it doesn't fit properly.","ipa":""},{"cat":"Noun Phrase","point":"return policy","cn":"退货政策","ex":"Always check the return policy before buying electronics.","ipa":""},{"cat":"Noun Phrase","point":"shipping cost","cn":"运费","ex":"The shipping cost is free if you spend over $50.","ipa":""},{"cat":"Slang","point":"rip-off","cn":"敲竹杠；价格过高","ex":"Ten dollars for a bottle of water? That is a total rip-off!","ipa":""},{"cat":"Noun Phrase","point":"customer service line","cn":"客服热线","ex":"I stayed on the customer service line for 20 minutes.","ipa":""},{"cat":"Adjective","point":"busy","cn":"（电话）占线","ex":"I tried to call my mom, but the line was busy.","ipa":""},{"cat":"Verb","point":"investigate","cn":"调查；研究","ex":"You should investigate the seller before sending money.","ipa":""},{"cat":"Noun Phrase","point":"physical address","cn":"实体地址","ex":"The bank requires a physical address, not just a PO Box.","ipa":""},{"cat":"Adjective","point":"suspicious","cn":"可疑的；怀疑的","ex":"The email looked suspicious, so I deleted it.","ipa":""},{"cat":"Phrasal Verb","point":"pay attention to","cn":"注意；留心","ex":"Please pay attention to the road signs while driving.","ipa":""},{"cat":"Noun","point":"fine-print","cn":"细则；附属细则（通常字体很小）","ex":"Read the fine-print to see if there are hidden fees.","ipa":""},{"cat":"Adverb","point":"overseas","cn":"在海外；在国外","ex":"My brother lives overseas, so we video chat often.","ipa":""},{"cat":"Adjective","point":"reputable","cn":"声誉好的；值得信赖的","ex":"Buy your car from a reputable dealer.","ipa":""},{"cat":"Noun","point":"hassle","cn":"麻烦；困难","ex":"Travelling during the holidays can be a huge hassle.","ipa":""},{"cat":"Idiom","point":"change your mind","cn":"改变主意","ex":"I was going to eat out, but I changed my mind.","ipa":""},{"cat":"Phrase","point":"give it 5 stars","cn":"给五星好评；高度评价","ex":"The movie was amazing, I give it 5 stars.","ipa":""},{"cat":"Noun Phrase","point":"experience with","cn":"……的经历/经验","ex":"Do you have any experience with fixing computers?","ipa":""},{"cat":"Adverb","point":"eventually","cn":"最终；终于","ex":"It rained all day, but the sun came out eventually.","ipa":""},{"cat":"Noun Phrase","point":"spelling mistake","cn":"拼写错误","ex":"Check your essay for any spelling mistakes.","ipa":""},{"cat":"Adjective","point":"worth","cn":"值得","ex":"This book is definitely worth reading.","ipa":""},{"cat":"Phrasal Verb","point":"figure out","cn":"弄清楚；解决","ex":"We need to figure out how to get to the airport.","ipa":""}];
        const cultureData = [{"en":"In North America, online shopping is extremely common, but 'scam' websites do exist. Legitimate businesses typically display a clear physical address and phone number. 'Fine print' often contains crucial information about return policies and fees, which consumers are expected to read before purchasing. A 'rip-off' is a common slang term for a deal that is bad value for money. Checking for spelling errors and overseas addresses are common ways to verify if a site is reputable.","cn":"在北美，网上购物非常普遍，但也确实存在“诈骗”网站。合法的企业通常会显示清晰的实体地址和电话号码。“细则”（Fine print）通常包含有关退货政策和费用的关键信息，消费者在购买前应该阅读这些信息。“Rip-off”是一个常见的俚语，指性价比很低的交易或被敲竹杠。检查拼写错误和海外地址是验证网站信誉是否良好的常用方法。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"fit properly (phr.) /fɪt ˈprɑpərli/","back":"合身；尺寸合适"},{"front":"return policy (n.) /rɪˈtɜrn ˈpɑləsi/","back":"退货政策"},{"front":"shipping cost (n.) /'ʃɪpɪŋ kɔst/","back":"运费"},{"front":"rip-off (n.) /ˈrɪpˌɔf/","back":"敲竹杠；价格过高"},{"front":"customer service line (n.) /ˈkʌstəmər ˈsɜrvəs laɪn/","back":"客服热线"},{"front":"busy (adj.) /ˈbɪzi/","back":"（电话）占线"},{"front":"investigate (v.) /ɪnˈvɛstəˌɡeɪt/","back":"调查；研究"},{"front":"physical address (n.) /ˈfɪzɪkəl əˈdrɛs/","back":"实体地址"},{"front":"suspicious (adj.) /səˈspɪʃəs/","back":"可疑的；怀疑的"},{"front":"pay attention to (v.) /peɪ əˈtɛnʃən tu/","back":"注意；留心"},{"front":"fine-print (n.) /faɪn prɪnt/","back":"细则；附属细则"},{"front":"overseas (adv.) /ˌoʊvərˈsiz/","back":"在海外；在国外"},{"front":"reputable (adj.) /ˈrɛpjətəbəl/","back":"声誉好的；值得信赖的"},{"front":"hassle (n.) /ˈhæsəl/","back":"麻烦；困难"},{"front":"change your mind (phr.) /tʃeɪndʒ jɔr maɪnd/","back":"改变主意"},{"front":"give it 5 stars (phr.) /ɡɪv ɪt faɪv stɑrz/","back":"给五星好评"},{"front":"experience with (phr.) /ɪkˈspɪriəns wɪð/","back":"……的经历/经验"},{"front":"eventually (adv.) /ɪˈvɛntʃuəli/","back":"最终；终于"},{"front":"spelling mistake (n.) /ˈspɛlɪŋ mɪˈsteɪk/","back":"拼写错误"},{"front":"worth (adj.) /wɜrθ/","back":"值得"},{"front":"figure out (v.) /ˈfɪɡjər aʊt/","back":"弄清楚；解决"}],"group_2":[{"front":"合身；尺寸合适","back":"fit properly (phr.) /fɪt ˈprɑpərli/"},{"front":"退货政策","back":"return policy (n.) /rɪˈtɜrn ˈpɑləsi/"},{"front":"运费","back":"shipping cost (n.) /'ʃɪpɪŋ kɔst/"},{"front":"敲竹杠；价格过高","back":"rip-off (n.) /ˈrɪpˌɔf/"},{"front":"客服热线","back":"customer service line (n.) /ˈkʌstəmər ˈsɜrvəs laɪn/"},{"front":"（电话）占线","back":"busy (adj.) /ˈbɪzi/"},{"front":"调查；研究","back":"investigate (v.) /ɪnˈvɛstəˌɡeɪt/"},{"front":"实体地址","back":"physical address (n.) /ˈfɪzɪkəl əˈdrɛs/"},{"front":"可疑的；怀疑的","back":"suspicious (adj.) /səˈspɪʃəs/"},{"front":"注意；留心","back":"pay attention to (v.) /peɪ əˈtɛnʃən tu/"},{"front":"细则；附属细则","back":"fine-print (n.) /faɪn prɪnt/"},{"front":"在海外；在国外","back":"overseas (adv.) /ˌoʊvərˈsiz/"},{"front":"声誉好的；值得信赖的","back":"reputable (adj.) /ˈrɛpjətəbəl/"},{"front":"麻烦；困难","back":"hassle (n.) /ˈhæsəl/"},{"front":"改变主意","back":"change your mind (phr.) /tʃeɪndʒ jɔr maɪnd/"},{"front":"给五星好评","back":"give it 5 stars (phr.) /ɡɪv ɪt faɪv stɑrz/"},{"front":"……的经历/经验","back":"experience with (phr.) /ɪkˈspɪriəns wɪð/"},{"front":"最终；终于","back":"eventually (adv.) /ɪˈvɛntʃuəli/"},{"front":"拼写错误","back":"spelling mistake (n.) /ˈspɛlɪŋ mɪˈsteɪk/"},{"front":"值得","back":"worth (adj.) /wɜrθ/"},{"front":"弄清楚；解决","back":"figure out (v.) /ˈfɪɡjər aʊt/"}],"group_3":[{"front":"This shirt is too tight, it doesn't fit properly.","back":"这件衬衫太紧了，不太合身。"},{"front":"Always check the return policy before buying electronics.","back":"买电子产品前一定要查看退货政策。"},{"front":"The shipping cost is free if you spend over $50.","back":"如果你消费超过50美元，运费是免费的。"},{"front":"Ten dollars for a bottle of water? That is a total rip-off!","back":"一瓶水要十美元？这简直是敲竹杠！"},{"front":"I stayed on the customer service line for 20 minutes.","back":"我在客服热线上等了20分钟。"},{"front":"I tried to call my mom, but the line was busy.","back":"我试着给我妈打电话，但电话占线。"},{"front":"You should investigate the seller before sending money.","back":"汇款前你应该调查一下卖家。"},{"front":"The bank requires a physical address, not just a PO Box.","back":"银行需要实体地址，而不仅仅是邮政信箱。"},{"front":"The email looked suspicious, so I deleted it.","back":"那封邮件看起来很可疑，所以我把它删了。"},{"front":"Please pay attention to the road signs while driving.","back":"开车时请留意路标。"},{"front":"Read the fine-print to see if there are hidden fees.","back":"阅读细则看看是否有隐藏费用。"},{"front":"My brother lives overseas, so we video chat often.","back":"我哥哥住在国外，所以我们经常视频聊天。"},{"front":"Buy your car from a reputable dealer.","back":"要从信誉良好的经销商那里买车。"},{"front":"Travelling during the holidays can be a huge hassle.","back":"假期出行可能会很麻烦。"},{"front":"I was going to eat out, but I changed my mind.","back":"我本来打算出去吃，但我改变主意了。"},{"front":"The movie was amazing, I give it 5 stars.","back":"这部电影太棒了，我给五星好评。"},{"front":"Do you have any experience with fixing computers?","back":"你有修电脑的经验吗？"},{"front":"It rained all day, but the sun came out eventually.","back":"下了一整天雨，但太阳最终还是出来了。"},{"front":"Check your essay for any spelling mistakes.","back":"检查你的文章有没有拼写错误。"},{"front":"This book is definitely worth reading.","back":"这本书绝对值得一读。"},{"front":"We need to figure out how to get to the airport.","back":"我们需要弄清楚怎么去机场。"}],"group_4":[{"front":"这件衬衫太紧了，不太合身。","back":"This shirt is too tight, it doesn't fit properly."},{"front":"买电子产品前一定要查看退货政策。","back":"Always check the return policy before buying electronics."},{"front":"如果你消费超过50美元，运费是免费的。","back":"The shipping cost is free if you spend over $50."},{"front":"一瓶水要十美元？这简直是敲竹杠！","back":"Ten dollars for a bottle of water? That is a total rip-off!"},{"front":"我在客服热线上等了20分钟。","back":"I stayed on the customer service line for 20 minutes."},{"front":"我试着给我妈打电话，但电话占线。","back":"I tried to call my mom, but the line was busy."},{"front":"汇款前你应该调查一下卖家。","back":"You should investigate the seller before sending money."},{"front":"银行需要实体地址，而不仅仅是邮政信箱。","back":"The bank requires a physical address, not just a PO Box."},{"front":"那封邮件看起来很可疑，所以我把它删了。","back":"The email looked suspicious, so I deleted it."},{"front":"开车时请留意路标。","back":"Please pay attention to the road signs while driving."},{"front":"阅读细则看看是否有隐藏费用。","back":"Read the fine-print to see if there are hidden fees."},{"front":"我哥哥住在国外，所以我们经常视频聊天。","back":"My brother lives overseas, so we video chat often."},{"front":"要从信誉良好的经销商那里买车。","back":"Buy your car from a reputable dealer."},{"front":"假期出行可能会很麻烦。","back":"Travelling during the holidays can be a huge hassle."},{"front":"我本来打算出去吃，但我改变主意了。","back":"I was going to eat out, but I changed my mind."},{"front":"这部电影太棒了，我给五星好评。","back":"The movie was amazing, I give it 5 stars."},{"front":"你有修电脑的经验吗？","back":"Do you have any experience with fixing computers?"},{"front":"下了一整天雨，但太阳最终还是出来了。","back":"It rained all day, but the sun came out eventually."},{"front":"检查你的文章有没有拼写错误。","back":"Check your essay for any spelling mistakes."},{"front":"这本书绝对值得一读。","back":"This book is definitely worth reading."},{"front":"我们需要弄清楚怎么去机场。","back":"We need to figure out how to get to the airport."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What item of clothing did Alya buy?","options":["A. A skirt","B. A pair of pants","C. A jacket","D. A pair of shoes"],"ans":"B. A pair of pants"},{"type":"tf","q":"Alya found the return policy immediately on the website.","options":["A. True","B. False"],"ans":"B. False"},{"type":"fill","q":"The shipping cost was $15, but the pants only cost ____.","options":[],"ans":"$25"},{"type":"mc","q":"Why did Carmen say 'What a rip-off!'?","options":["A. Because the pants were ugly.","B. Because the shipping cost was very high compared to the item price.","C. Because the website was closed.","D. Because the pants never arrived."],"ans":"B. Because the shipping cost was very high compared to the item price."},{"type":"tf","q":"Alya was able to speak to customer service easily.","options":["A. True","B. False"],"ans":"B. False"},{"type":"dict","q":"Listen and write the sentence you hear.","options":[],"ans":"I decided after that that I would never buy anything online again.","srcText":"I decided after that that I would never buy anything online again."},{"type":"mc","q":"What red flag did Alya notice on the website?","options":["A. It was too colorful.","B. There were spelling mistakes.","C. The images were blurry.","D. The font was too small."],"ans":"B. There were spelling mistakes."},{"type":"fill","q":"Through the ____ print, Alya discovered the company was overseas.","options":[],"ans":"fine"},{"type":"mc","q":"What website does Carmen recommend?","options":["A. Fairprice","B. Amazon","C. The Blue Nile","D. eBay"],"ans":"C. The Blue Nile"},{"type":"tf","q":"Alya thinks the experience was worth the hassle because she got her money back.","options":["A. True","B. False"],"ans":"B. False"}]; 
        let vocabQuestions = [{"type":"mc","q":"Which word means 'situated in a foreign country, especially across the sea'?","options":["A. Reputable","B. Suspicious","C. Overseas","D. Physical"],"ans":"C. Overseas"},{"type":"fill","q":"If something costs far more than it is worth, it is a ____.","options":[],"ans":"rip-off"},{"type":"mc","q":"What does 'reputable' mean?","options":["A. Difficult to find","B. Having a good reputation and trustworthy","C. Very expensive","D. Full of mistakes"],"ans":"B. Having a good reputation and trustworthy"},{"type":"fill","q":"Before signing the contract, make sure you read the ____ at the bottom.","options":[],"ans":"fine-print"},{"type":"mc","q":"If you solve a problem or understand something, you ____ it ____.","options":["A. figure out","B. give up","C. pay attention","D. change mind"],"ans":"A. figure out"},{"type":"tf","q":"If a phone line is 'busy', it means someone is currently using it.","options":["A. True","B. False"],"ans":"A. True"},{"type":"fill","q":"I had a bad ____ with that airline, so I won't fly with them again.","options":[],"ans":"experience"},{"type":"mc","q":"Which phrase means 'to decide differently than before'?","options":["A. Fit properly","B. Change your mind","C. Pay attention","D. Give it 5 stars"],"ans":"B. Change your mind"},{"type":"fill","q":"The jeans didn't ____ properly, so I returned them.","options":[],"ans":"fit"},{"type":"mc","q":"What is a 'hassle'?","options":["A. A great deal","B. An irritating inconvenience","C. A spelling mistake","D. A type of shipping"],"ans":"B. An irritating inconvenience"},{"type":"fill","q":"You should verify the company's ____ address to ensure they are real.","options":[],"ans":"physical"},{"type":"mc","q":"If you think something is wrong or dishonest, you are ____.","options":["A. suspicious","B. reputable","C. worth","D. busy"],"ans":"A. suspicious"},{"type":"fill","q":"After waiting for hours, he ____ got to see the doctor.","options":[],"ans":"eventually"},{"type":"mc","q":"What does 'pay attention to' mean?","options":["A. To ignore","B. To pay money for","C. To focus on or notice","D. To travel overseas"],"ans":"C. To focus on or notice"},{"type":"fill","q":"The ____ policy stated that no refunds were allowed after 30 days.","options":[],"ans":"return"},{"type":"mc","q":"If a service is excellent, you might say you ____.","options":["A. give it 5 stars","B. find it suspicious","C. call the line","D. pay shipping"],"ans":"A. give it 5 stars"},{"type":"fill","q":"I need to call the customer ____ line to complain.","options":[],"ans":"service"},{"type":"mc","q":"Which word describes the price paid to send a package?","options":["A. Fine-print","B. Shipping cost","C. Physical address","D. Spelling mistake"],"ans":"B. Shipping cost"},{"type":"fill","q":"It is not ____ arguing with him; he won't listen.","options":[],"ans":"worth"},{"type":"mc","q":"Police will ____ the crime scene.","options":["A. investigate","B. hassle","C. fit properly","D. rip-off"],"ans":"A. investigate"},{"type":"fill","q":"There was a ____ mistake on the sign; it said 'appell' instead of 'apple'.","options":[],"ans":"spelling"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>