<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Shopping: Convenience and Safety</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Online Shopping: Convenience and Safety</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Are you a big fan of online shopping, or do you prefer going to the store?","cn":"你是网购的忠实粉丝，还是更喜欢去实体店？"},{"en":"In my opinion, online shopping offers consumers incredible convenience because I can shop from home anytime.","cn":"依我看，网购给消费者提供了极大的便利，因为我可以随时在家购物。"},{"en":"However, you have to be careful of sketchy websites that might sell fake products.","cn":"不过，你必须小心那些可能出售假货的可疑网站。"},{"en":"I agree, I once bought a jacket that looked authentic, but it turned out to be a total rip off.","cn":"我同意，我曾经买过一件看起来像正品的夹克，结果完全是敲诈。"},{"en":"That sounds terrible; was the merchant reputable, or was it a fraudulent site?","cn":"听起来太糟糕了；那个商家信誉好吗，还是个欺诈网站？"},{"en":"I didn't check if they were legitimate, and the URL didn't have HTTPS, so it wasn't secure.","cn":"我没检查他们是否合法，而且网址没有HTTPS，所以并不安全。"},{"en":"When I tried to get a refund, they said all sales final, which was not worth the hassle.","cn":"当我试图退款时，他们说所有商品概不退换，真是不值得这么麻烦。"},{"en":"Now, I always use a search engine to check reviews and ensure the site is credible.","cn":"现在，我总是用搜索引擎查看评论，确保网站是可信的。"},{"en":"Does the site have a good return policy if the item doesn't fit?","cn":"如果东西不合身，这个网站有好的退货政策吗？"},{"en":"Yes, most reputable sites provide a return label and allow you to exchange the item easily.","cn":"有的，大多数信誉好的网站都提供退货标签，并允许你轻松换货。"},{"en":"I also look at the size charts carefully to avoid paying for return shipping.","cn":"我也会仔细看尺码表，以免支付退货运费。"},{"en":"Another perk of online shopping is that you can consolidate your orders to save on delivery fees.","cn":"网购的另一个好处是你可以合并订单以节省运费。"},{"en":"What acts can we take to prevent online fraud and protect our data?","cn":"我们可以采取什么行动来防止网络诈骗并保护我们的数据？"},{"en":"You should only shop on encrypted sites and monitor your bank statements for any compromised accounts.","cn":"你应该只在加密的网站上购物，并监控银行对账单是否有被盗用的账户。"},{"en":"If someone uses your credit card without permission, your liability is usually limited by law.","cn":"如果有人未经许可使用你的信用卡，法律通常会限制你的责任。"},{"en":"That is true, consumers have the right to dispute charges that look unreliable or illegal.","cn":"没错，消费者有权对看起来不可靠或非法的收费提出异议。"},{"en":"Sometimes I worry about customs and duty when buying from another country.","cn":"有时我担心从其他国家购买时的关税和税费。"},{"en":"It can cost a fortune if you don't calculate those extra fees beforehand.","cn":"如果你不预先计算那些额外费用，可能会花一大笔钱。"},{"en":"I feel the same way, but the deals on e-commerce sites are often better than in stores.","cn":"我有同感，但电子商务网站上的交易通常比实体店更好。"},{"en":"Just remember to check the homepage for the lock icon in the browser's search bar.","cn":"只要记得检查浏览器搜索栏中主页上的锁形图标即可。"},{"en":"I would say that if a deal looks too good to be true, it is probably a scam.","cn":"我想说，如果一笔交易看起来好得令人难以置信，那可能就是个骗局。"},{"en":"Where is the company located, and do they have a valid order number system?","cn":"这家公司位于哪里，他们有有效的订单号系统吗？"},{"en":"Those are good questions to ask before you enter your payment details.","cn":"在输入付款详情之前，这些都是需要问的好问题。"},{"en":"Ultimately, I give online shopping five stars for efficiency, provided you stay safe.","cn":"最后，如果能保证安全，我给网购的效率打五星。"}];
        const knowledgePoints = [{"cat":"Phrase","point":"be a big fan","ex":"I am a big fan of their customer service because they are always helpful.","exTrans":"我是他们客户服务的超级粉丝，因为他们总是乐于助人。","ipa":""},{"cat":"Noun","point":"convenience","ex":"The convenience of having groceries delivered to your door is unmatched.","exTrans":"食品杂货送货上门的便利性是无与伦比的。","ipa":""},{"cat":"Noun","point":"consumer","ex":"Every consumer has the right to know what ingredients are in the product.","exTrans":"每个消费者都有权知道产品中含有什么成分。","ipa":""},{"cat":"Adjective","point":"sketchy","ex":"I didn't buy the phone because the seller seemed a bit sketchy.","exTrans":"我没买那个手机，因为卖家看起来有点可疑。","ipa":""},{"cat":"Noun","point":"fraud","ex":"Credit card fraud is a serious crime that affects many people.","exTrans":"信用卡诈骗是一种影响许多人的严重犯罪。","ipa":""},{"cat":"Adjective","point":"authentic","ex":"This handbag comes with a certificate to prove it is authentic.","exTrans":"这款手提包附有证书以证明它是正品。","ipa":""},{"cat":"Phrase","point":"rip off","ex":"Paying $20 for a sandwich is a total rip off.","exTrans":"花20美元买个三明治简直是敲诈。","ipa":""},{"cat":"Noun","point":"merchant","ex":"The merchant refused to accept the returned goods without a receipt.","exTrans":"没有收据，商家拒绝接受退货。","ipa":""},{"cat":"Adjective","point":"reputable","ex":"Always hire a reputable contractor for home repairs.","exTrans":"一定要聘请信誉良好的承包商进行房屋维修。","ipa":""},{"cat":"Adjective","point":"fraudulent","ex":"The bank blocked the fraudulent transaction immediately.","exTrans":"银行立即阻止了这笔欺诈性交易。","ipa":""},{"cat":"Adjective","point":"legitimate","ex":"Is this a legitimate email from the company, or is it spam?","exTrans":"这是公司的合法邮件还是垃圾邮件？","ipa":""},{"cat":"Adjective","point":"secure","ex":"Make sure your password is secure by using a mix of letters and numbers.","exTrans":"使用字母和数字的组合来确保你的密码是安全的。","ipa":""},{"cat":"Noun","point":"refund","ex":"I asked for a full refund because the product was broken.","exTrans":"因为产品坏了，我要求全额退款。","ipa":""},{"cat":"Phrase","point":"all sales final","ex":"The clearance items are cheap, but be aware that all sales are final.","exTrans":"清仓商品很便宜，但要注意所有商品概不退换。","ipa":""},{"cat":"Phrase","point":"not worth the hassle","ex":"Fixing this old car is not worth the hassle; just buy a new one.","exTrans":"修这辆旧车不值得那么麻烦，直接买辆新的吧。","ipa":""},{"cat":"Adjective","point":"credible","ex":"The news report cited several credible sources.","exTrans":"这篇新闻报道引用了几个可信的消息来源。","ipa":""},{"cat":"Phrase","point":"return policy","ex":"Please read the return policy before purchasing electronics.","exTrans":"购买电子产品前请阅读退货政策。","ipa":""},{"cat":"Noun","point":"return label","ex":"Stick the return label on the box and drop it off at the post office.","exTrans":"把退货标签贴在盒子上，然后送到邮局。","ipa":""},{"cat":"Noun","point":"exchange","ex":"I would like to make an exchange for a larger size.","exTrans":"我想换一个大一点的尺码。","ipa":""},{"cat":"Noun","point":"size chart","ex":"Consult the size chart to find your perfect fit.","exTrans":"查看尺码表以找到最适合你的尺码。","ipa":""},{"cat":"Noun","point":"perk","ex":"Free coffee is a nice perk of working at this office.","exTrans":"免费咖啡是在这个办公室工作的一个很好的福利。","ipa":""},{"cat":"Verb","point":"consolidate","ex":"We should consolidate our debts into one payment.","exTrans":"我们应该把债务合并成一次付款。","ipa":""},{"cat":"Adjective","point":"encrypted","ex":"Your messages are encrypted so no one else can read them.","exTrans":"你的消息是加密的，所以其他人无法阅读。","ipa":""},{"cat":"Adjective","point":"compromised","ex":"His account was compromised after he clicked on a phishing link.","exTrans":"他点击钓鱼链接后，账户被盗用了。","ipa":""},{"cat":"Noun","point":"liability","ex":"The company accepts no liability for damage caused by misuse.","exTrans":"公司对因误用造成的损坏不承担任何责任。","ipa":""},{"cat":"Verb","point":"dispute","ex":"You can dispute the charge if you didn't buy the item.","exTrans":"如果你没买那件商品，你可以对这笔费用提出异议。","ipa":""},{"cat":"Adjective","point":"unreliable","ex":"The bus service here is very unreliable in the winter.","exTrans":"这里的公共汽车服务在冬天非常不可靠。","ipa":""},{"cat":"Adjective","point":"illegal","ex":"It is illegal to drive without a license.","exTrans":"无证驾驶是违法的。","ipa":""},{"cat":"Phrase","point":"customs and duty","ex":"I had to pay extra customs and duty when the package arrived.","exTrans":"包裹到达时，我不得不支付额外的关税和税费。","ipa":""},{"cat":"Phrase","point":"cost a fortune","ex":"That luxury car must cost a fortune to maintain.","exTrans":"那辆豪车的保养费一定很贵。","ipa":""},{"cat":"Noun","point":"e-commerce","ex":"E-commerce has changed the way people shop for clothes.","exTrans":"电子商务改变了人们购买衣服的方式。","ipa":""},{"cat":"Noun","point":"homepage","ex":"You can find the latest news on the website's homepage.","exTrans":"你可以在网站的主页上找到最新消息。","ipa":""},{"cat":"Phrase","point":"search bar","ex":"Type the keyword into the search bar to find the product.","exTrans":"在搜索栏中输入关键字以查找产品。","ipa":""},{"cat":"Noun","point":"order number","ex":"Please keep your order number in case you need to contact support.","exTrans":"请保存你的订单号，以防你需要联系支持人员。","ipa":""},{"cat":"Phrase","point":"five stars","ex":"The hotel service was excellent, so I gave it five stars.","exTrans":"酒店服务非常好，所以我给了五星好评。","ipa":""},{"cat":"Noun","point":"fake","ex":"The painting was discovered to be a fake.","exTrans":"这幅画被发现是赝品。","ipa":""}];
        const cultureData = [{"en":"In North America, online shopping is extremely popular, but security is a major priority. E-commerce standards require merchants to use encryption (HTTPS) to protect consumer data. Most credit card companies offer fraud protection, limiting a consumer's liability to $50 or less if their card is compromised. It is common culture to read reviews and check 'Better Business Bureau' ratings before using a new site.","cn":"在北美，网购非常普及，但安全性是一个首要任务。电子商务标准要求商家使用加密技术（HTTPS）来保护消费者数据。大多数信用卡公司提供欺诈保护，如果消费者的卡被盗用，其责任通常限制在50美元或更少。在使用新网站之前，阅读评论和查看“商业改进局”的评级是一种普遍的习惯。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"be a big fan (phr.) /bi ə bɪg fæn/","back":"非常喜欢某事物"},{"front":"convenience (n.) /kənˈviːniəns/","back":"便利，方便"},{"front":"consumer (n.) /kənˈsuːmər/","back":"消费者，顾客"},{"front":"sketchy (adj.) /ˈskɛʧi/","back":"可疑的，不靠谱的"},{"front":"fraud (n.) /frɔːd/","back":"欺诈，诈骗"},{"front":"authentic (adj.) /ɔːˈθɛntɪk/","back":"真正的，正品的"},{"front":"rip off (phr.) /rɪp ɔf/","back":"敲诈，索价过高"},{"front":"merchant (n.) /ˈmɜːrʧənt/","back":"商人，商家"},{"front":"reputable (adj.) /ˈrɛpjətəbəl/","back":"声誉好的，值得信赖的"},{"front":"fraudulent (adj.) /ˈfrɔːʤələnt/","back":"欺诈性的"},{"front":"legitimate (adj.) /lɪˈʤɪtəmɪt/","back":"合法的，正规的"},{"front":"secure (adj.) /sɪˈkjʊr/","back":"安全的"},{"front":"refund (n.) /ˈriːfʌnd/","back":"退款"},{"front":"all sales final (phr.) /ɔl seɪlz ˈfaɪnəl/","back":"概不退换"},{"front":"not worth the hassle (phr.) /nɑt wɜrθ ðə ˈhæsəl/","back":"不值得那个麻烦"},{"front":"credible (adj.) /ˈkrɛdəbəl/","back":"可信的"},{"front":"return policy (n.) /rɪˈtɜrn ˈpɑləsi/","back":"退货政策"},{"front":"return label (n.) /rɪˈtɜrn ˈleɪbəl/","back":"退货标签"},{"front":"exchange (n.) /ɪksˈʧeɪnʤ/","back":"交换，换货"},{"front":"size chart (n.) /saɪz ʧɑrt/","back":"尺码表"},{"front":"perk (n.) /pɜrk/","back":"津贴，额外待遇"},{"front":"consolidate (v.) /kənˈsɑlɪˌdeɪt/","back":"合并，统一"},{"front":"encrypted (adj.) /ɛnˈkrɪptɪd/","back":"加密的"},{"front":"compromised (adj.) /ˈkɑmprəˌmaɪzd/","back":"被泄露的，被攻破的"},{"front":"liability (n.) /ˌlaɪəˈbɪlɪti/","back":"责任，义务"},{"front":"dispute (v.) /dɪˈspjuːt/","back":"提出异议，争论"},{"front":"unreliable (adj.) /ˌʌnrɪˈlaɪəbəl/","back":"不可靠的"},{"front":"illegal (adj.) /ɪˈliːgəl/","back":"违法的"},{"front":"customs and duty (phr.) /ˈkʌstəmz ənd ˈduːti/","back":"关税和税费"},{"front":"cost a fortune (phr.) /kɔst ə ˈfɔrʧən/","back":"花大价钱，很贵"},{"front":"e-commerce (n.) /iː-ˈkɑmərs/","back":"电子商务"},{"front":"homepage (n.) /ˈhoʊmˌpeɪʤ/","back":"主页"},{"front":"search bar (n.) /sɜrʧ bɑr/","back":"搜索栏"},{"front":"order number (n.) /ˈɔrdər ˈnʌmbər/","back":"订单号"},{"front":"five stars (phr.) /faɪv stɑrz/","back":"五星（好评）"},{"front":"fake (n.) /feɪk/","back":"假货，赝品"}],"group_2":[{"front":"非常喜欢某事物","back":"be a big fan (phr.) /bi ə bɪg fæn/"},{"front":"便利，方便","back":"convenience (n.) /kənˈviːniəns/"},{"front":"消费者，顾客","back":"consumer (n.) /kənˈsuːmər/"},{"front":"可疑的，不靠谱的","back":"sketchy (adj.) /ˈskɛʧi/"},{"front":"欺诈，诈骗","back":"fraud (n.) /frɔːd/"},{"front":"真正的，正品的","back":"authentic (adj.) /ɔːˈθɛntɪk/"},{"front":"敲诈，索价过高","back":"rip off (phr.) /rɪp ɔf/"},{"front":"商人，商家","back":"merchant (n.) /ˈmɜːrʧənt/"},{"front":"声誉好的，值得信赖的","back":"reputable (adj.) /ˈrɛpjətəbəl/"},{"front":"欺诈性的","back":"fraudulent (adj.) /ˈfrɔːʤələnt/"},{"front":"合法的，正规的","back":"legitimate (adj.) /lɪˈʤɪtəmɪt/"},{"front":"安全的","back":"secure (adj.) /sɪˈkjʊr/"},{"front":"退款","back":"refund (n.) /ˈriːfʌnd/"},{"front":"概不退换","back":"all sales final (phr.) /ɔl seɪlz ˈfaɪnəl/"},{"front":"不值得那个麻烦","back":"not worth the hassle (phr.) /nɑt wɜrθ ðə ˈhæsəl/"},{"front":"可信的","back":"credible (adj.) /ˈkrɛdəbəl/"},{"front":"退货政策","back":"return policy (n.) /rɪˈtɜrn ˈpɑləsi/"},{"front":"退货标签","back":"return label (n.) /rɪˈtɜrn ˈleɪbəl/"},{"front":"交换，换货","back":"exchange (n.) /ɪksˈʧeɪnʤ/"},{"front":"尺码表","back":"size chart (n.) /saɪz ʧɑrt/"},{"front":"津贴，额外待遇","back":"perk (n.) /pɜrk/"},{"front":"合并，统一","back":"consolidate (v.) /kənˈsɑlɪˌdeɪt/"},{"front":"加密的","back":"encrypted (adj.) /ɛnˈkrɪptɪd/"},{"front":"被泄露的，被攻破的","back":"compromised (adj.) /ˈkɑmprəˌmaɪzd/"},{"front":"责任，义务","back":"liability (n.) /ˌlaɪəˈbɪlɪti/"},{"front":"提出异议，争论","back":"dispute (v.) /dɪˈspjuːt/"},{"front":"不可靠的","back":"unreliable (adj.) /ˌʌnrɪˈlaɪəbəl/"},{"front":"违法的","back":"illegal (adj.) /ɪˈliːgəl/"},{"front":"关税和税费","back":"customs and duty (phr.) /ˈkʌstəmz ənd ˈduːti/"},{"front":"花大价钱，很贵","back":"cost a fortune (phr.) /kɔst ə ˈfɔrʧən/"},{"front":"电子商务","back":"e-commerce (n.) /iː-ˈkɑmərs/"},{"front":"主页","back":"homepage (n.) /ˈhoʊmˌpeɪʤ/"},{"front":"搜索栏","back":"search bar (n.) /sɜrʧ bɑr/"},{"front":"订单号","back":"order number (n.) /ˈɔrdər ˈnʌmbər/"},{"front":"五星（好评）","back":"five stars (phr.) /faɪv stɑrz/"},{"front":"假货，赝品","back":"fake (n.) /feɪk/"}],"group_3":[{"front":"I am a big fan of their customer service because they are always helpful.","back":"我是他们客户服务的超级粉丝，因为他们总是乐于助人。"},{"front":"The convenience of having groceries delivered to your door is unmatched.","back":"食品杂货送货上门的便利性是无与伦比的。"},{"front":"Every consumer has the right to know what ingredients are in the product.","back":"每个消费者都有权知道产品中含有什么成分。"},{"front":"I didn't buy the phone because the seller seemed a bit sketchy.","back":"我没买那个手机，因为卖家看起来有点可疑。"},{"front":"Credit card fraud is a serious crime that affects many people.","back":"信用卡诈骗是一种影响许多人的严重犯罪。"},{"front":"This handbag comes with a certificate to prove it is authentic.","back":"这款手提包附有证书以证明它是正品。"},{"front":"Paying $20 for a sandwich is a total rip off.","back":"花20美元买个三明治简直是敲诈。"},{"front":"The merchant refused to accept the returned goods without a receipt.","back":"没有收据，商家拒绝接受退货。"},{"front":"Always hire a reputable contractor for home repairs.","back":"一定要聘请信誉良好的承包商进行房屋维修。"},{"front":"The bank blocked the fraudulent transaction immediately.","back":"银行立即阻止了这笔欺诈性交易。"},{"front":"Is this a legitimate email from the company, or is it spam?","back":"这是公司的合法邮件还是垃圾邮件？"},{"front":"Make sure your password is secure by using a mix of letters and numbers.","back":"使用字母和数字的组合来确保你的密码是安全的。"},{"front":"I asked for a full refund because the product was broken.","back":"因为产品坏了，我要求全额退款。"},{"front":"The clearance items are cheap, but be aware that all sales are final.","back":"清仓商品很便宜，但要注意所有商品概不退换。"},{"front":"Fixing this old car is not worth the hassle; just buy a new one.","back":"修这辆旧车不值得那么麻烦，直接买辆新的吧。"},{"front":"The news report cited several credible sources.","back":"这篇新闻报道引用了几个可信的消息来源。"},{"front":"Please read the return policy before purchasing electronics.","back":"购买电子产品前请阅读退货政策。"},{"front":"Stick the return label on the box and drop it off at the post office.","back":"把退货标签贴在盒子上，然后送到邮局。"},{"front":"I would like to make an exchange for a larger size.","back":"我想换一个大一点的尺码。"},{"front":"Consult the size chart to find your perfect fit.","back":"查看尺码表以找到最适合你的尺码。"},{"front":"Free coffee is a nice perk of working at this office.","back":"免费咖啡是在这个办公室工作的一个很好的福利。"},{"front":"We should consolidate our debts into one payment.","back":"我们应该把债务合并成一次付款。"},{"front":"Your messages are encrypted so no one else can read them.","back":"你的消息是加密的，所以其他人无法阅读。"},{"front":"His account was compromised after he clicked on a phishing link.","back":"他点击钓鱼链接后，账户被盗用了。"},{"front":"The company accepts no liability for damage caused by misuse.","back":"公司对因误用造成的损坏不承担任何责任。"},{"front":"You can dispute the charge if you didn't buy the item.","back":"如果你没买那件商品，你可以对这笔费用提出异议。"},{"front":"The bus service here is very unreliable in the winter.","back":"这里的公共汽车服务在冬天非常不可靠。"},{"front":"It is illegal to drive without a license.","back":"无证驾驶是违法的。"},{"front":"I had to pay extra customs and duty when the package arrived.","back":"包裹到达时，我不得不支付额外的关税和税费。"},{"front":"That luxury car must cost a fortune to maintain.","back":"那辆豪车的保养费一定很贵。"},{"front":"E-commerce has changed the way people shop for clothes.","back":"电子商务改变了人们购买衣服的方式。"},{"front":"You can find the latest news on the website's homepage.","back":"你可以在网站的主页上找到最新消息。"},{"front":"Type the keyword into the search bar to find the product.","back":"在搜索栏中输入关键字以查找产品。"},{"front":"Please keep your order number in case you need to contact support.","back":"请保存你的订单号，以防你需要联系支持人员。"},{"front":"The hotel service was excellent, so I gave it five stars.","back":"酒店服务非常好，所以我给了五星好评。"},{"front":"The painting was discovered to be a fake.","back":"这幅画被发现是赝品。"}],"group_4":[{"front":"我是他们客户服务的超级粉丝，因为他们总是乐于助人。","back":"I am a big fan of their customer service because they are always helpful."},{"front":"食品杂货送货上门的便利性是无与伦比的。","back":"The convenience of having groceries delivered to your door is unmatched."},{"front":"每个消费者都有权知道产品中含有什么成分。","back":"Every consumer has the right to know what ingredients are in the product."},{"front":"我没买那个手机，因为卖家看起来有点可疑。","back":"I didn't buy the phone because the seller seemed a bit sketchy."},{"front":"信用卡诈骗是一种影响许多人的严重犯罪。","back":"Credit card fraud is a serious crime that affects many people."},{"front":"这款手提包附有证书以证明它是正品。","back":"This handbag comes with a certificate to prove it is authentic."},{"front":"花20美元买个三明治简直是敲诈。","back":"Paying $20 for a sandwich is a total rip off."},{"front":"没有收据，商家拒绝接受退货。","back":"The merchant refused to accept the returned goods without a receipt."},{"front":"一定要聘请信誉良好的承包商进行房屋维修。","back":"Always hire a reputable contractor for home repairs."},{"front":"银行立即阻止了这笔欺诈性交易。","back":"The bank blocked the fraudulent transaction immediately."},{"front":"这是公司的合法邮件还是垃圾邮件？","back":"Is this a legitimate email from the company, or is it spam?"},{"front":"使用字母和数字的组合来确保你的密码是安全的。","back":"Make sure your password is secure by using a mix of letters and numbers."},{"front":"因为产品坏了，我要求全额退款。","back":"I asked for a full refund because the product was broken."},{"front":"清仓商品很便宜，但要注意所有商品概不退换。","back":"The clearance items are cheap, but be aware that all sales are final."},{"front":"修这辆旧车不值得那么麻烦，直接买辆新的吧。","back":"Fixing this old car is not worth the hassle; just buy a new one."},{"front":"这篇新闻报道引用了几个可信的消息来源。","back":"The news report cited several credible sources."},{"front":"购买电子产品前请阅读退货政策。","back":"Please read the return policy before purchasing electronics."},{"front":"把退货标签贴在盒子上，然后送到邮局。","back":"Stick the return label on the box and drop it off at the post office."},{"front":"我想换一个大一点的尺码。","back":"I would like to make an exchange for a larger size."},{"front":"查看尺码表以找到最适合你的尺码。","back":"Consult the size chart to find your perfect fit."},{"front":"免费咖啡是在这个办公室工作的一个很好的福利。","back":"Free coffee is a nice perk of working at this office."},{"front":"我们应该把债务合并成一次付款。","back":"We should consolidate our debts into one payment."},{"front":"你的消息是加密的，所以其他人无法阅读。","back":"Your messages are encrypted so no one else can read them."},{"front":"他点击钓鱼链接后，账户被盗用了。","back":"His account was compromised after he clicked on a phishing link."},{"front":"公司对因误用造成的损坏不承担任何责任。","back":"The company accepts no liability for damage caused by misuse."},{"front":"如果你没买那件商品，你可以对这笔费用提出异议。","back":"You can dispute the charge if you didn't buy the item."},{"front":"这里的公共汽车服务在冬天非常不可靠。","back":"The bus service here is very unreliable in the winter."},{"front":"无证驾驶是违法的。","back":"It is illegal to drive without a license."},{"front":"包裹到达时，我不得不支付额外的关税和税费。","back":"I had to pay extra customs and duty when the package arrived."},{"front":"那辆豪车的保养费一定很贵。","back":"That luxury car must cost a fortune to maintain."},{"front":"电子商务改变了人们购买衣服的方式。","back":"E-commerce has changed the way people shop for clothes."},{"front":"你可以在网站的主页上找到最新消息。","back":"You can find the latest news on the website's homepage."},{"front":"在搜索栏中输入关键字以查找产品。","back":"Type the keyword into the search bar to find the product."},{"front":"请保存你的订单号，以防你需要联系支持人员。","back":"Please keep your order number in case you need to contact support."},{"front":"酒店服务非常好，所以我给了五星好评。","back":"The hotel service was excellent, so I gave it five stars."},{"front":"这幅画被发现是赝品。","back":"The painting was discovered to be a fake."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"tf","q":"The speakers believe online shopping is inconvenient.","options":["True","False"],"ans":"False"},{"type":"mc","q":"What happened to the speaker who bought the jacket?","options":["A. It was authentic and cheap.","B. It was a fake item and a rip off.","C. It arrived early.","D. It was the wrong size."],"ans":"B. It was a fake item and a rip off."},{"type":"fill","q":"You should check if the URL has ______ to ensure it is secure.","options":[],"ans":"HTTPS"},{"type":"mc","q":"What does 'all sales final' mean in the dialogue?","options":["A. You can return the item anytime.","B. You can exchange the item.","C. You cannot return or exchange the item.","D. The sale is ending soon."],"ans":"C. You cannot return or exchange the item."},{"type":"tf","q":"Consumers have the right to dispute charges that look unreliable.","options":["True","False"],"ans":"True"},{"type":"mc","q":"Why should you check size charts carefully?","options":["A. To see the price.","B. To avoid paying for return shipping.","C. To check the color.","D. To see if it is in stock."],"ans":"B. To avoid paying for return shipping."},{"type":"dict","q":"Listen and write down the phrase about combining orders.","options":[],"ans":"Consolidate your orders","srcText":"Consolidate your orders"},{"type":"mc","q":"What is a risk of buying from another country mentioned in the text?","options":["A. Slow internet.","B. Customs and duty fees.","C. Language barriers.","D. Bad reviews."],"ans":"B. Customs and duty fees."},{"type":"tf","q":"The liability for unauthorized credit card use is unlimited by law.","options":["True","False"],"ans":"False"},{"type":"mc","q":"How does the speaker rate online shopping in the end?","options":["A. One star.","B. Three stars.","C. Five stars.","D. Zero stars."],"ans":"C. Five stars."}]; 
        let vocabQuestions = [{"type":"mc","q":"Which phrase means to really like something?","options":["A. be a big fan","B. not worth the hassle","C. rip off","D. cost a fortune"],"ans":"A. be a big fan"},{"type":"fill","q":"Online shopping offers great ________ because you don't have to leave your house.","options":[],"ans":"convenience"},{"type":"mc","q":"A person who buys things is called a ________.","options":["A. merchant","B. consumer","C. browser","D. fake"],"ans":"B. consumer"},{"type":"tf","q":"A 'sketchy' website is one that you can trust completely.","options":["True","False"],"ans":"False"},{"type":"mc","q":"Deceiving someone for money is known as ________.","options":["A. perk","B. fraud","C. refund","D. exchange"],"ans":"B. fraud"},{"type":"mc","q":"If a product is real and not a copy, it is ________.","options":["A. authentic","B. fraudulent","C. compromised","D. illegal"],"ans":"A. authentic"},{"type":"fill","q":"That shirt was too expensive; it was a total ________.","options":[],"ans":"rip off"},{"type":"mc","q":"What do you call someone who sells things?","options":["A. consumer","B. merchant","C. liability","D. refund"],"ans":"B. merchant"},{"type":"mc","q":"A ________ company is well-known and respected.","options":["A. sketchy","B. reputable","C. fraudulent","D. fake"],"ans":"B. reputable"},{"type":"tf","q":"A fraudulent activity involves honesty and following the law.","options":["True","False"],"ans":"False"},{"type":"mc","q":"A site that follows laws and rules is ________.","options":["A. compromised","B. legitimate","C. illegal","D. fake"],"ans":"B. legitimate"},{"type":"fill","q":"You should check for HTTPS to make sure the site is ________.","options":[],"ans":"secure"},{"type":"mc","q":"Money you get back for a returned item is a ________.","options":["A. refund","B. fine","C. tax","D. fee"],"ans":"A. refund"},{"type":"mc","q":"What does 'all sales final' mean?","options":["A. You can return it.","B. You cannot return or exchange it.","C. It is free.","D. It is authentic."],"ans":"B. You cannot return or exchange it."},{"type":"mc","q":"If something is too much trouble, it is ________.","options":["A. not worth the hassle","B. a big fan","C. five stars","D. convenient"],"ans":"A. not worth the hassle"},{"type":"mc","q":"A source that is believable is ________.","options":["A. credible","B. sketchy","C. illegal","D. compromised"],"ans":"A. credible"},{"type":"fill","q":"Always check the ________ before buying to see the rules for sending items back.","options":[],"ans":"return policy"},{"type":"mc","q":"What do you stick on a box to mail it back?","options":["A. return label","B. size chart","C. search bar","D. homepage"],"ans":"A. return label"},{"type":"mc","q":"Trading an item for a different one is called an ________.","options":["A. exchange","B. refund","C. order number","D. liability"],"ans":"A. exchange"},{"type":"mc","q":"What helps you choose the right fit for clothes?","options":["A. size chart","B. return policy","C. duty","D. scam"],"ans":"A. size chart"},{"type":"mc","q":"A benefit or advantage is called a ________.","options":["A. perk","B. fraud","C. risk","D. hassle"],"ans":"A. perk"},{"type":"mc","q":"To combine many things into one is to ________.","options":["A. consolidate","B. dispute","C. compromise","D. refund"],"ans":"A. consolidate"},{"type":"mc","q":"Data that is coded for safety is ________.","options":["A. encrypted","B. open","C. public","D. unreliable"],"ans":"A. encrypted"},{"type":"mc","q":"An account that has been hacked is ________.","options":["A. compromised","B. secure","C. reputable","D. legitimate"],"ans":"A. compromised"},{"type":"fill","q":"Your responsibility for a debt or damage is your ________.","options":[],"ans":"liability"},{"type":"mc","q":"To question a charge you don't recognize is to ________ it.","options":["A. dispute","B. pay","C. consolidate","D. ignore"],"ans":"A. dispute"},{"type":"tf","q":"Something 'unreliable' always works well.","options":["True","False"],"ans":"False"},{"type":"mc","q":"Against the law means ________.","options":["A. illegal","B. legitimate","C. secure","D. reputable"],"ans":"A. illegal"},{"type":"mc","q":"Taxes on items from another country are ________.","options":["A. customs and duty","B. perks","C. refunds","D. exchanges"],"ans":"A. customs and duty"},{"type":"mc","q":"If something 'costs a fortune', it is ________.","options":["A. very expensive","B. very cheap","C. free","D. reasonable"],"ans":"A. very expensive"},{"type":"mc","q":"Business done on the internet is ________.","options":["A. e-commerce","B. retail","C. wholesale","D. manufacturing"],"ans":"A. e-commerce"},{"type":"mc","q":"The first page of a website is the ________.","options":["A. homepage","B. cart","C. checkout","D. login"],"ans":"A. homepage"},{"type":"mc","q":"Where do you type what you want to find online?","options":["A. search bar","B. size chart","C. return label","D. padlock"],"ans":"A. search bar"},{"type":"fill","q":"You get a unique ________ when you complete a purchase.","options":[],"ans":"order number"},{"type":"mc","q":"An excellent review is often described as ________.","options":["A. five stars","B. sketchy","C. compromised","D. liable"],"ans":"A. five stars"},{"type":"mc","q":"A product that is not real is a ________.","options":["A. fake","B. authentic","C. perk","D. refund"],"ans":"A. fake"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>