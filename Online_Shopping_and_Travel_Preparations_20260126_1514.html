<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Shopping and Travel Preparations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Online Shopping and Travel Preparations</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Hi Alya! How are you doing?","cn":"嗨，Alya！你好吗？"},{"en":"Oh, hi Carmen! I’m good. How about you?","cn":"噢，嗨，Carmen！我很好。你呢？"},{"en":"I bet you’re excited about your trip to Mexico.","cn":"我敢说你对去墨西哥的旅行一定很兴奋。"},{"en":"Are you all packed and ready to go?","cn":"你都收拾好行李准备出发了吗？"},{"en":"Well, almost.","cn":"嗯，差不多了。"},{"en":"I still have a few little things that I need to get, like a bathing suit and a couple of T-shirts.","cn":"我还有一些小东西需要买，比如泳衣和几件T恤。"},{"en":"But other than that, I’m ready to go!","cn":"除此之外，我都准备好了！"},{"en":"Oh. Where are you going to get those?","cn":"噢。你打算去哪里买那些东西？"},{"en":"It’s hard to shop for summer clothes in the middle of winter.","cn":"冬天买夏装很难。"},{"en":"I know. January’s not the best time to find swimsuits and beachwear.","cn":"我知道。一月份不是找泳衣和沙滩装的最佳时机。"},{"en":"But I found an online shopping site that has almost everything I need.","cn":"但我发现了一个网上购物网站，里面几乎有我需要的所有东西。"},{"en":"Really? Are you a big fan of shopping online?","cn":"真的吗？你很喜欢网购吗？"},{"en":"Well, I never was before, to be honest.","cn":"嗯，老实说，我以前从来不喜欢的。"},{"en":"I'm usually one of those people who likes to go to the mall every weekend.","cn":"我通常是那种喜欢每个周末都去商场的人。"},{"en":"I like to see things and try them on before I buy them.","cn":"我喜欢在买东西之前先看看实物并试穿一下。"},{"en":"But I found this site called “The Blue Nile” and it’s great.","cn":"但我发现了这个叫“The Blue Nile”的网站，它很棒。"},{"en":"Oh yeah? Tell me about it.","cn":"噢是吗？跟我说说。"},{"en":"Well, they have a really good selection of things.","cn":"嗯，他们的商品种类很丰富。"},{"en":"And I like that they have size charts on their website that show you exact measurements for all the sizes.","cn":"而且我喜欢他们网站上有尺码表，显示所有尺码的确切尺寸。"},{"en":"That way, I can easily figure out what size will fit me.","cn":"那样的话，我就能很容易地弄清楚什么尺码适合我。"},{"en":"They have some great deals and such a good return policy!","cn":"他们有一些很棒的优惠，而且退货政策也很好！"},{"en":"So, I’m just sticking to online shopping for everything I need.","cn":"所以，我现在需要的每样东西都坚持网购。"},{"en":"Really? But what about the shipping costs?","cn":"真的吗？但是运费呢？"},{"en":"Shipping usually costs a fortune, doesn’t it?","cn":"运费通常很贵，不是吗？"},{"en":"It depends. On this site, anything over $20 is free shipping.","cn":"看情况。在这个网站上，超过20美元就免运费。"},{"en":"Also, it’s a Canadian site, so you don’t have to worry about customs and duty charges.","cn":"另外，这是一个加拿大网站，所以你不必担心海关和关税费用。"},{"en":"Sounds good. So, did you see anything for your trip?","cn":"听起来不错。那么，你看到什么适合旅行的东西了吗？"},{"en":"Yeah, I found a couple of pairs of sandals and some swimsuits that I liked.","cn":"是的，我找到了几双凉鞋和一些我喜欢的泳衣。"},{"en":"I’m going to order them this week and then my shopping is done!","cn":"我打算这周下单，然后我的购物就完成了！"}];
        const knowledgePoints = [{"cat":"Verb","point":"bet","cn":"肯定；打赌","ex":"I bet it will rain later today.","exTrans":"我敢说今天晚些时候会下雨。","ipa":""},{"cat":"Adjective","point":"packed","cn":"收拾好行李的；打包好的","ex":"We are fully packed and waiting for the taxi.","exTrans":"我们已经完全收拾好行李，正在等出租车。","ipa":""},{"cat":"Noun","point":"bathing suit","cn":"泳衣","ex":"Don't forget to bring your bathing suit to the pool.","exTrans":"别忘了把你的泳衣带到游泳池来。","ipa":""},{"cat":"Phrase","point":"other than that","cn":"除此之外","ex":"I have a slight headache, but other than that, I feel fine.","exTrans":"我有点头痛，但除此之外，我感觉很好。","ipa":""},{"cat":"Noun","point":"beachwear","cn":"海滩服装","ex":"The store sells sunglasses and beachwear.","exTrans":"这家店卖太阳镜和海滩装。","ipa":""},{"cat":"Phrase","point":"be a big fan of","cn":"非常喜欢...","ex":"I am not a big fan of spicy food.","exTrans":"我不是很喜欢吃辣。","ipa":""},{"cat":"Phrase","point":"to be honest","cn":"老实说","ex":"To be honest, I didn't like the movie very much.","exTrans":"老实说，我不太喜欢这部电影。","ipa":""},{"cat":"Phrasal Verb","point":"try on","cn":"试穿","ex":"Can I try on these jeans in the fitting room?","exTrans":"我可以在试衣间试穿这条牛仔裤吗？","ipa":""},{"cat":"Noun","point":"selection","cn":"挑选；可供挑选的种类","ex":"The bakery has a wide selection of cakes.","exTrans":"这家面包店有各种各样的蛋糕供挑选。","ipa":""},{"cat":"Noun","point":"size chart","cn":"尺码表","ex":"Please check the size chart before ordering online.","exTrans":"网购前请查看尺码表。","ipa":""},{"cat":"Noun","point":"measurement","cn":"尺寸；测量","ex":"The tailor took my waist measurement.","exTrans":"裁缝量了我的腰围。","ipa":""},{"cat":"Phrasal Verb","point":"figure out","cn":"弄清楚；解决","ex":"We need to figure out how to fix this computer.","exTrans":"我们需要弄清楚如何修理这台电脑。","ipa":""},{"cat":"Noun","point":"deal","cn":"交易；优惠","ex":"I got a great deal on my new car.","exTrans":"我买新车时享受了很大的优惠。","ipa":""},{"cat":"Noun","point":"return policy","cn":"退货政策","ex":"You should ask about the return policy in case it doesn't fit.","exTrans":"你应该问问退货政策，以防不合身。","ipa":""},{"cat":"Phrasal Verb","point":"stick to","cn":"坚持；紧随","ex":"Let's stick to the original plan.","exTrans":"让我们坚持原来的计划。","ipa":""},{"cat":"Noun","point":"shipping cost","cn":"运费","ex":"The price includes the shipping cost.","exTrans":"这个价格包含了运费。","ipa":""},{"cat":"Idiom","point":"cost a fortune","cn":"花大价钱；非常昂贵","ex":"That diamond ring must have cost a fortune.","exTrans":"那枚钻戒肯定价格不菲。","ipa":""},{"cat":"Noun","point":"customs","cn":"海关","ex":"We had to show our passports at customs.","exTrans":"我们必须在海关出示护照。","ipa":""},{"cat":"Noun","point":"duty charge","cn":"关税费用","ex":"You may have to pay a duty charge on imported electronics.","exTrans":"你可能需要为进口电子产品支付关税。","ipa":""},{"cat":"Noun","point":"sandal","cn":"凉鞋","ex":"It's too cold to wear sandals today.","exTrans":"今天太冷了，不能穿凉鞋。","ipa":""},{"cat":"Verb","point":"order","cn":"订购","ex":"I'm going to order a pizza for dinner.","exTrans":"晚餐我要订个披萨。","ipa":""},{"cat":"Phrase","point":"in the middle of","cn":"在...中间；正当...","ex":"She stopped talking in the middle of a sentence.","exTrans":"她在一句话说到一半时停了下来。","ipa":""}];
        const cultureData = [{"en":"In Canada, online shopping is very popular, but consumers often have to pay attention to where the website is based. If ordering from the USA or other countries, Canadians may be charged 'customs duties' and taxes upon delivery if the value exceeds certain limits. This is why domestic Canadian sites ('.ca') are often preferred to avoid these extra fees and potential delays at the border. Additionally, return policies are crucial for online shoppers since they cannot try on clothes beforehand.","cn":"在加拿大，网上购物非常普及，但消费者通常必须注意网站的所在地。如果从美国或其他国家订购，当商品价值超过一定限额时，加拿大人可能需要在收货时支付“关税”和税款。这就是为什么要避免这些额外费用和潜在的边境延误，加拿大本土网站（'.ca'）通常更受青睐的原因。此外，退货政策对网购者至关重要，因为他们无法预先试穿衣服。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"bet (v.) /bɛt/","back":"肯定；打赌"},{"front":"packed (adj.) /pækt/","back":"收拾好行李的；打包好的"},{"front":"bathing suit (n.) /ˈbeɪðɪŋ suːt/","back":"泳衣"},{"front":"other than that (phr.) /ˈʌðər ðæn ðæt/","back":"除此之外"},{"front":"beachwear (n.) /ˈbiːtʃwɛr/","back":"海滩服装"},{"front":"be a big fan of (phr.) /bi ə bɪg fæn ʌv/","back":"非常喜欢..."},{"front":"to be honest (phr.) /tu bi ˈɒnɪst/","back":"老实说"},{"front":"try on (phr. v.) /traɪ ɒn/","back":"试穿"},{"front":"selection (n.) /sɪˈlɛkʃən/","back":"挑选；可供挑选的种类"},{"front":"size chart (n.) /saɪz tʃɑrt/","back":"尺码表"},{"front":"measurement (n.) /ˈmɛʒərmənt/","back":"尺寸；测量"},{"front":"figure out (phr. v.) /ˈfɪgjər aʊt/","back":"弄清楚；解决"},{"front":"deal (n.) /diːl/","back":"交易；优惠"},{"front":"return policy (n.) /rɪˈtɜrn ˈpɒlɪsi/","back":"退货政策"},{"front":"stick to (phr. v.) /stɪk tu/","back":"坚持；紧随"},{"front":"shipping cost (n.) /ˈʃɪpɪŋ kɔst/","back":"运费"},{"front":"cost a fortune (idiom) /kɔst ə ˈfɔrtʃən/","back":"花大价钱；非常昂贵"},{"front":"customs (n.) /ˈkʌstəmz/","back":"海关"},{"front":"duty charge (n.) /ˈdjuːti tʃɑrdʒ/","back":"关税费用"},{"front":"sandal (n.) /ˈsændəl/","back":"凉鞋"},{"front":"order (v.) /ˈɔrdər/","back":"订购"},{"front":"in the middle of (phr.) /ɪn ðə ˈmɪdəl ʌv/","back":"在...中间；正当..."}],"group_2":[{"front":"肯定；打赌","back":"bet (v.) /bɛt/"},{"front":"收拾好行李的；打包好的","back":"packed (adj.) /pækt/"},{"front":"泳衣","back":"bathing suit (n.) /ˈbeɪðɪŋ suːt/"},{"front":"除此之外","back":"other than that (phr.) /ˈʌðər ðæn ðæt/"},{"front":"海滩服装","back":"beachwear (n.) /ˈbiːtʃwɛr/"},{"front":"非常喜欢...","back":"be a big fan of (phr.) /bi ə bɪg fæn ʌv/"},{"front":"老实说","back":"to be honest (phr.) /tu bi ˈɒnɪst/"},{"front":"试穿","back":"try on (phr. v.) /traɪ ɒn/"},{"front":"挑选；可供挑选的种类","back":"selection (n.) /sɪˈlɛkʃən/"},{"front":"尺码表","back":"size chart (n.) /saɪz tʃɑrt/"},{"front":"尺寸；测量","back":"measurement (n.) /ˈmɛʒərmənt/"},{"front":"弄清楚；解决","back":"figure out (phr. v.) /ˈfɪgjər aʊt/"},{"front":"交易；优惠","back":"deal (n.) /diːl/"},{"front":"退货政策","back":"return policy (n.) /rɪˈtɜrn ˈpɒlɪsi/"},{"front":"坚持；紧随","back":"stick to (phr. v.) /stɪk tu/"},{"front":"运费","back":"shipping cost (n.) /ˈʃɪpɪŋ kɔst/"},{"front":"花大价钱；非常昂贵","back":"cost a fortune (idiom) /kɔst ə ˈfɔrtʃən/"},{"front":"海关","back":"customs (n.) /ˈkʌstəmz/"},{"front":"关税费用","back":"duty charge (n.) /ˈdjuːti tʃɑrdʒ/"},{"front":"凉鞋","back":"sandal (n.) /ˈsændəl/"},{"front":"订购","back":"order (v.) /ˈɔrdər/"},{"front":"在...中间；正当...","back":"in the middle of (phr.) /ɪn ðə ˈmɪdəl ʌv/"}],"group_3":[{"front":"I bet it will rain later today.","back":"我敢说今天晚些时候会下雨。"},{"front":"We are fully packed and waiting for the taxi.","back":"我们已经完全收拾好行李，正在等出租车。"},{"front":"Don't forget to bring your bathing suit to the pool.","back":"别忘了把你的泳衣带到游泳池来。"},{"front":"I have a slight headache, but other than that, I feel fine.","back":"我有点头痛，但除此之外，我感觉很好。"},{"front":"The store sells sunglasses and beachwear.","back":"这家店卖太阳镜和海滩装。"},{"front":"I am not a big fan of spicy food.","back":"我不是很喜欢吃辣。"},{"front":"To be honest, I didn't like the movie very much.","back":"老实说，我不太喜欢这部电影。"},{"front":"Can I try on these jeans in the fitting room?","back":"我可以在试衣间试穿这条牛仔裤吗？"},{"front":"The bakery has a wide selection of cakes.","back":"这家面包店有各种各样的蛋糕供挑选。"},{"front":"Please check the size chart before ordering online.","back":"网购前请查看尺码表。"},{"front":"The tailor took my waist measurement.","back":"裁缝量了我的腰围。"},{"front":"We need to figure out how to fix this computer.","back":"我们需要弄清楚如何修理这台电脑。"},{"front":"I got a great deal on my new car.","back":"我买新车时享受了很大的优惠。"},{"front":"You should ask about the return policy in case it doesn't fit.","back":"你应该问问退货政策，以防不合身。"},{"front":"Let's stick to the original plan.","back":"让我们坚持原来的计划。"},{"front":"The price includes the shipping cost.","back":"这个价格包含了运费。"},{"front":"That diamond ring must have cost a fortune.","back":"那枚钻戒肯定价格不菲。"},{"front":"We had to show our passports at customs.","back":"我们必须在海关出示护照。"},{"front":"You may have to pay a duty charge on imported electronics.","back":"你可能需要为进口电子产品支付关税。"},{"front":"It's too cold to wear sandals today.","back":"今天太冷了，不能穿凉鞋。"},{"front":"I'm going to order a pizza for dinner.","back":"晚餐我要订个披萨。"},{"front":"She stopped talking in the middle of a sentence.","back":"她在一句话说到一半时停了下来。"}],"group_4":[{"front":"我敢说今天晚些时候会下雨。","back":"I bet it will rain later today."},{"front":"我们已经完全收拾好行李，正在等出租车。","back":"We are fully packed and waiting for the taxi."},{"front":"别忘了把你的泳衣带到游泳池来。","back":"Don't forget to bring your bathing suit to the pool."},{"front":"我有点头痛，但除此之外，我感觉很好。","back":"I have a slight headache, but other than that, I feel fine."},{"front":"这家店卖太阳镜和海滩装。","back":"The store sells sunglasses and beachwear."},{"front":"我不是很喜欢吃辣。","back":"I am not a big fan of spicy food."},{"front":"老实说，我不太喜欢这部电影。","back":"To be honest, I didn't like the movie very much."},{"front":"我可以在试衣间试穿这条牛仔裤吗？","back":"Can I try on these jeans in the fitting room?"},{"front":"这家面包店有各种各样的蛋糕供挑选。","back":"The bakery has a wide selection of cakes."},{"front":"网购前请查看尺码表。","back":"Please check the size chart before ordering online."},{"front":"裁缝量了我的腰围。","back":"The tailor took my waist measurement."},{"front":"我们需要弄清楚如何修理这台电脑。","back":"We need to figure out how to fix this computer."},{"front":"我买新车时享受了很大的优惠。","back":"I got a great deal on my new car."},{"front":"你应该问问退货政策，以防不合身。","back":"You should ask about the return policy in case it doesn't fit."},{"front":"让我们坚持原来的计划。","back":"Let's stick to the original plan."},{"front":"这个价格包含了运费。","back":"The price includes the shipping cost."},{"front":"那枚钻戒肯定价格不菲。","back":"That diamond ring must have cost a fortune."},{"front":"我们必须在海关出示护照。","back":"We had to show our passports at customs."},{"front":"你可能需要为进口电子产品支付关税。","back":"You may have to pay a duty charge on imported electronics."},{"front":"今天太冷了，不能穿凉鞋。","back":"It's too cold to wear sandals today."},{"front":"晚餐我要订个披萨。","back":"I'm going to order a pizza for dinner."},{"front":"她在一句话说到一半时停了下来。","back":"She stopped talking in the middle of a sentence."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"Where is Carmen traveling to?","options":["A. The United States","B. Mexico","C. Canada","D. The Blue Nile"],"ans":"B. Mexico"},{"type":"tf","q":"Carmen has finished all her packing.","options":["A. True","B. False"],"ans":"B. False"},{"type":"fill","q":"Carmen needs to buy a ______ and a couple of T-shirts.","options":[],"ans":"bathing suit"},{"type":"mc","q":"Why is it difficult for Carmen to find what she needs in stores?","options":["A. The stores are closed.","B. She doesn't like shopping malls.","C. It is winter, and she needs summer clothes.","D. The prices are too high."],"ans":"C. It is winter, and she needs summer clothes."},{"type":"tf","q":"Carmen has always been a big fan of online shopping.","options":["A. True","B. False"],"ans":"B. False"},{"type":"mc","q":"What feature of the website helps Carmen choose the right clothes?","options":["A. The return policy","B. The size charts","C. The free shipping","D. The customer reviews"],"ans":"B. The size charts"},{"type":"mc","q":"How much do you need to spend on the site to get free shipping?","options":["A. Over $50","B. Over $20","C. Over $100","D. It is never free"],"ans":"B. Over $20"},{"type":"fill","q":"Carmen doesn't need to worry about customs because it is a ______ site.","options":[],"ans":"Canadian"},{"type":"tf","q":"Shipping usually costs a fortune on all websites.","options":["A. True","B. False"],"ans":"B. False"},{"type":"mc","q":"What items did Carmen find for her trip?","options":["A. Boots and jackets","B. Sandals and swimsuits","C. Hats and gloves","D. Jeans and sweaters"],"ans":"B. Sandals and swimsuits"}]; 
        let vocabQuestions = [{"type":"fill","q":"It's raining, so I ______ you are not going to the park.","options":[],"ans":"bet"},{"type":"mc","q":"Are your bags ______? The taxi is here.","options":["A. pack","B. packed","C. packing","D. packs"],"ans":"B. packed"},{"type":"mc","q":"Which item is considered a bathing suit?","options":["A. Jeans","B. Bikini","C. Sweater","D. Scarf"],"ans":"B. Bikini"},{"type":"mc","q":"The food was cold, but ______ that, the party was fun.","options":["A. other than","B. rather than","C. more than","D. other"],"ans":"A. other than"},{"type":"fill","q":"Shorts and tank tops are examples of summer ______.","options":[],"ans":"beachwear"},{"type":"tf","q":"If you are a 'big fan of' something, you dislike it.","options":["A. True","B. False"],"ans":"B. False"},{"type":"mc","q":"______, I don't think that's a good idea.","options":["A. To be honest","B. To be lie","C. To be fair","D. To be sure"],"ans":"A. To be honest"},{"type":"fill","q":"Make sure you ______ on the shoes before you buy them.","options":[],"ans":"try"},{"type":"mc","q":"This library has a large ______ of books.","options":["A. select","B. selected","C. selection","D. selecting"],"ans":"C. selection"},{"type":"tf","q":"A size chart helps you find the right size.","options":["A. True","B. False"],"ans":"A. True"},{"type":"fill","q":"The ______ of the table is 2 meters long.","options":[],"ans":"measurement"},{"type":"mc","q":"I can't ______ out the answer to this puzzle.","options":["A. figure","B. count","C. look","D. watch"],"ans":"A. figure"},{"type":"mc","q":"Buy one get one free is a great ______.","options":["A. deal","B. dealing","C. dealer","D. dealt"],"ans":"A. deal"},{"type":"tf","q":"A return policy explains how to buy items.","options":["A. True","B. False"],"ans":"B. False"},{"type":"fill","q":"If you want to lose weight, you must ______ to your diet.","options":[],"ans":"stick"},{"type":"mc","q":"Does the price include the ______ cost?","options":["A. ship","B. shipping","C. shipment","D. ships"],"ans":"B. shipping"},{"type":"mc","q":"Buying a house in this city can cost a ______.","options":["A. money","B. rich","C. fortune","D. expensive"],"ans":"C. fortune"},{"type":"fill","q":"International travelers must pass through ______ upon arrival.","options":[],"ans":"customs"},{"type":"tf","q":"A duty charge is a type of tax on imported goods.","options":["A. True","B. False"],"ans":"A. True"},{"type":"mc","q":"People usually wear ______ in the summer.","options":["A. boots","B. sandals","C. wool socks","D. mittens"],"ans":"B. sandals"},{"type":"mc","q":"Did you ______ the tickets online?","options":["A. order","B. ordering","C. orders","D. ordered"],"ans":"A. order"},{"type":"fill","q":"He woke up in the ______ of the night.","options":[],"ans":"middle"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>