<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Consultations and Medication Instructions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Pharmacy Consultations and Medication Instructions</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Hi, my throat is really sore.","cn":"嗨，我的喉咙真的很痛。"},{"en":"Could you tell me what to take for it?","cn":"你能告诉我该吃什么药吗？"},{"en":"Sure, you can take this cold medicine tonight before you go to bed.","cn":"当然，你可以今晚睡前服用这种感冒药。"},{"en":"It will help you sleep.","cn":"这会帮助你睡眠。"},{"en":"But it is sore right now.","cn":"但是我现在就很痛。"},{"en":"In that case, you can take these throat lozenges too.","cn":"那样的话，你也可以吃这些润喉糖。"},{"en":"Okay, thanks. Do I pay here?","cn":"好的，谢谢。我在这里付钱吗？"},{"en":"No, take them to the cashier.","cn":"不，拿到收银台去付。"},{"en":"Mr. Amador? Here is your prescription.","cn":"Amador先生？这是你的处方药。"},{"en":"Now, take five millilitres every morning and five millilitres every night, until it is all gone.","cn":"现在，每天早上服用5毫升，每天晚上服用5毫升，直到喝完为止。"},{"en":"When will it start to work?","cn":"它什么时候开始起效？"},{"en":"Soon. In a few hours, your ear will feel much better.","cn":"很快。几个小时后，你的耳朵会感觉好很多。"},{"en":"So that is five millilitres twice a day, morning and night?","cn":"所以是每天两次，早晚各5毫升？"},{"en":"That is right. It should take you about a week to finish the medicine.","cn":"没错。喝完这瓶药大约需要一周时间。"},{"en":"Hello, I am Jan Michesku. I called this morning.","cn":"你好，我是Jan Michesku。我今天早上打过电话。"},{"en":"Yes, Mr. Michesku. Your prescriptions are right here.","cn":"是的，Michesku先生。你的处方药就在这里。"},{"en":"They have been ready for an hour.","cn":"它们已经准备好一个小时了。"},{"en":"Now, take these pills three times a day. That is every eight hours.","cn":"现在，这些药片一天吃三次。也就是每八小时一次。"},{"en":"I usually take them at seven in the morning and three in the afternoon.","cn":"我通常在早上七点和下午三点服用。"},{"en":"And one before I go to bed, about ten or eleven at night.","cn":"还有一片在睡前吃，大约晚上十点或十一点。"},{"en":"That is fine. You can take these other pills anytime you feel a pain.","cn":"那可以。你感觉到痛的时候随时可以吃这些其他的药片。"},{"en":"Is it okay if I take one before lunch?","cn":"我在午饭前吃一片可以吗？"},{"en":"It is better if you wait till after lunch, after you have eaten.","cn":"最好等到午饭后，吃完饭再吃。"},{"en":"The pills may upset your stomach if it is empty.","cn":"如果是空腹的话，这些药片可能会让你的胃不舒服。"},{"en":"Excuse me. Can you tell me the best thing to take for a headache?","cn":"打扰一下。你能告诉我治头痛最好的药是什么吗？"},{"en":"Sure. Take one or two of these every four hours, up to six times a day.","cn":"当然。每四小时吃一到两片，一天最多吃六次。"},{"en":"Should I take them before or after meal time?","cn":"我应该在饭前还是饭后吃？"},{"en":"It does not matter. You can take them anytime.","cn":"没关系。你随时可以吃。"},{"en":"They take about twenty minutes to work.","cn":"它们大约需要二十分钟起效。"}];
        const knowledgePoints = [{"cat":"Adjective","point":"Sore","cn":"疼痛的，酸痛的","ex":"My legs are sore after the long run.","exTrans":"长跑后我的腿很酸痛。","ipa":""},{"cat":"Noun","point":"Lozenge","cn":"润喉糖","ex":"Sucking on a lozenge can soothe a dry throat.","exTrans":"含一颗润喉糖可以缓解喉咙干燥。","ipa":""},{"cat":"Noun","point":"Prescription","cn":"处方，处方药","ex":"You need a doctor's prescription to buy antibiotics.","exTrans":"你需要医生的处方才能买抗生素。","ipa":""},{"cat":"Noun","point":"Dosage","cn":"剂量","ex":"The recommended dosage is one tablet per day.","exTrans":"推荐剂量是每天一片。","ipa":""},{"cat":"Noun","point":"Pharmacist","cn":"药剂师","ex":"The pharmacist explained how to use the inhaler.","exTrans":"药剂师解释了如何使用吸入器。","ipa":""},{"cat":"Noun","point":"Millilitre","cn":"毫升","ex":"Please add 200 millilitres of water to the mixture.","exTrans":"请向混合物中加入200毫升水。","ipa":""},{"cat":"Noun","point":"Cashier","cn":"收银员","ex":"The cashier gave me the receipt after I paid.","exTrans":"我付款后收银员给了我收据。","ipa":""},{"cat":"Noun","point":"Pill","cn":"药丸，药片","ex":"This pill is hard to swallow without water.","exTrans":"没有水这药丸很难吞下去。","ipa":""},{"cat":"Phrase","point":"Upset stomach","cn":"胃部不适，肠胃难受","ex":"Spicy food often gives me an upset stomach.","exTrans":"辛辣食物经常让我胃部不适。","ipa":""},{"cat":"Noun","point":"Symptom","cn":"症状","ex":"Fever is a common symptom of the flu.","exTrans":"发烧是流感的常见症状。","ipa":""},{"cat":"Phrase","point":"Start to work","cn":"开始起效","ex":"The painkillers should start to work in about 30 minutes.","exTrans":"止痛药应该在大约30分钟内开始起效。","ipa":""},{"cat":"Adjective","point":"Empty","cn":"空的","ex":"Do not take this medicine on an empty stomach.","exTrans":"不要空腹服用此药。","ipa":""},{"cat":"Noun","point":"Headache","cn":"头痛","ex":"Lack of sleep can cause a severe headache.","exTrans":"睡眠不足会导致严重的头痛。","ipa":""},{"cat":"Verb","point":"Consult","cn":"咨询","ex":"You should consult your doctor before starting a new diet.","exTrans":"在开始新饮食计划前你应该咨询医生。","ipa":""},{"cat":"Noun","point":"Relief","cn":"缓解，解脱","ex":"The massage provided instant relief from the pain.","exTrans":"按摩使疼痛立即得到缓解。","ipa":""},{"cat":"Verb","point":"Recommend","cn":"推荐，建议","ex":"I recommend the seafood pasta; it is delicious.","exTrans":"我推荐海鲜意面；它很好吃。","ipa":""},{"cat":"Verb","point":"Avoid","cn":"避免","ex":"Try to avoid coffee late at night.","exTrans":"尽量避免在深夜喝咖啡。","ipa":""},{"cat":"Noun","point":"Instruction","cn":"说明，指示","ex":"Follow the instructions on the label carefully.","exTrans":"仔细遵循标签上的说明。","ipa":""},{"cat":"Noun","point":"Frequency","cn":"频率","ex":"The frequency of the buses increases during rush hour.","exTrans":"高峰时段公交车的频率会增加。","ipa":""},{"cat":"Noun","point":"Medication","cn":"药物","ex":"He takes medication for high blood pressure.","exTrans":"他服用治疗高血压的药物。","ipa":""},{"cat":"Adjective","point":"Drowsy","cn":"昏昏欲睡的","ex":"This medicine might make you feel drowsy.","exTrans":"这种药可能会让你感到昏昏欲睡。","ipa":""},{"cat":"Phrase","point":"It doesn't matter","cn":"没关系，不重要","ex":"It doesn't matter which color you choose.","exTrans":"你选哪个颜色都没关系。","ipa":""},{"cat":"Phrase","point":"Twice a day","cn":"一天两次","ex":"Brush your teeth at least twice a day.","exTrans":"每天至少刷两次牙。","ipa":""},{"cat":"Adjective","point":"Effective","cn":"有效的","ex":"This cleaning spray is very effective against grease.","exTrans":"这种清洁喷雾去油污非常有效。","ipa":""},{"cat":"Noun","point":"Pain","cn":"疼痛","ex":"She felt a sharp pain in her shoulder.","exTrans":"她感到肩膀一阵剧痛。","ipa":""}];
        const cultureData = [{"en":"In many Western countries, pharmacists play a crucial role in healthcare. They do not just dispense medication; they also offer medical advice for minor ailments like colds, headaches, or allergies. Customers often consult the pharmacist to choose the right over-the-counter (OTC) medication. Pharmacists also ensure patients understand how to take prescription drugs safely, checking for potential interactions or side effects.","cn":"在许多西方国家，药剂师在医疗保健中扮演着至关重要的角色。他们不仅分发药物，还为感冒、头痛或过敏等轻微疾病提供医疗建议。顾客经常咨询药剂师以选择合适的非处方药（OTC）。药剂师还确保患者了解如何安全服用处方药，并检查潜在的药物相互作用或副作用。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"Sore (adj.) /sɔːr/","back":"疼痛的，酸痛的"},{"front":"Lozenge (n.) /ˈlɒzɪndʒ/","back":"润喉糖"},{"front":"Prescription (n.) /prɪˈskrɪpʃən/","back":"处方，处方药"},{"front":"Dosage (n.) /ˈdoʊsɪdʒ/","back":"剂量"},{"front":"Pharmacist (n.) /ˈfɑːrməsɪst/","back":"药剂师"},{"front":"Millilitre (n.) /ˈmɪlɪˌliːtər/","back":"毫升"},{"front":"Cashier (n.) /kæˈʃɪər/","back":"收银员"},{"front":"Pill (n.) /pɪl/","back":"药丸，药片"},{"front":"Upset stomach (phr.) /ˌʌpˈsɛt ˈstʌmək/","back":"胃部不适，肠胃难受"},{"front":"Symptom (n.) /ˈsɪmptəm/","back":"症状"},{"front":"Start to work (phr.) /stɑːrt tu wɜːrk/","back":"开始起效"},{"front":"Empty (adj.) /ˈɛmpti/","back":"空的"},{"front":"Headache (n.) /ˈhɛdˌeɪk/","back":"头痛"},{"front":"Consult (v.) /kənˈsʌlt/","back":"咨询"},{"front":"Relief (n.) /rɪˈliːf/","back":"缓解，解脱"},{"front":"Recommend (v.) /ˌrɛkəˈmɛnd/","back":"推荐，建议"},{"front":"Avoid (v.) /əˈvɔɪd/","back":"避免"},{"front":"Instruction (n.) /ɪnˈstrʌkʃən/","back":"说明，指示"},{"front":"Frequency (n.) /ˈfriːkwənsi/","back":"频率"},{"front":"Medication (n.) /ˌmɛdɪˈkeɪʃən/","back":"药物"},{"front":"Drowsy (adj.) /ˈdraʊzi/","back":"昏昏欲睡的"},{"front":"It doesn't matter (phr.) /ɪt ˈdʌzənt ˈmætər/","back":"没关系，不重要"},{"front":"Twice a day (phr.) /twaɪs ə deɪ/","back":"一天两次"},{"front":"Effective (adj.) /ɪˈfɛktɪv/","back":"有效的"},{"front":"Pain (n.) /peɪn/","back":"疼痛"}],"group_2":[{"front":"疼痛的，酸痛的","back":"Sore (adj.) /sɔːr/"},{"front":"润喉糖","back":"Lozenge (n.) /ˈlɒzɪndʒ/"},{"front":"处方，处方药","back":"Prescription (n.) /prɪˈskrɪpʃən/"},{"front":"剂量","back":"Dosage (n.) /ˈdoʊsɪdʒ/"},{"front":"药剂师","back":"Pharmacist (n.) /ˈfɑːrməsɪst/"},{"front":"毫升","back":"Millilitre (n.) /ˈmɪlɪˌliːtər/"},{"front":"收银员","back":"Cashier (n.) /kæˈʃɪər/"},{"front":"药丸，药片","back":"Pill (n.) /pɪl/"},{"front":"胃部不适，肠胃难受","back":"Upset stomach (phr.) /ˌʌpˈsɛt ˈstʌmək/"},{"front":"症状","back":"Symptom (n.) /ˈsɪmptəm/"},{"front":"开始起效","back":"Start to work (phr.) /stɑːrt tu wɜːrk/"},{"front":"空的","back":"Empty (adj.) /ˈɛmpti/"},{"front":"头痛","back":"Headache (n.) /ˈhɛdˌeɪk/"},{"front":"咨询","back":"Consult (v.) /kənˈsʌlt/"},{"front":"缓解，解脱","back":"Relief (n.) /rɪˈliːf/"},{"front":"推荐，建议","back":"Recommend (v.) /ˌrɛkəˈmɛnd/"},{"front":"避免","back":"Avoid (v.) /əˈvɔɪd/"},{"front":"说明，指示","back":"Instruction (n.) /ɪnˈstrʌkʃən/"},{"front":"频率","back":"Frequency (n.) /ˈfriːkwənsi/"},{"front":"药物","back":"Medication (n.) /ˌmɛdɪˈkeɪʃən/"},{"front":"昏昏欲睡的","back":"Drowsy (adj.) /ˈdraʊzi/"},{"front":"没关系，不重要","back":"It doesn't matter (phr.) /ɪt ˈdʌzənt ˈmætər/"},{"front":"一天两次","back":"Twice a day (phr.) /twaɪs ə deɪ/"},{"front":"有效的","back":"Effective (adj.) /ɪˈfɛktɪv/"},{"front":"疼痛","back":"Pain (n.) /peɪn/"}],"group_3":[{"front":"My legs are sore after the long run.","back":"长跑后我的腿很酸痛。"},{"front":"Sucking on a lozenge can soothe a dry throat.","back":"含一颗润喉糖可以缓解喉咙干燥。"},{"front":"You need a doctor's prescription to buy antibiotics.","back":"你需要医生的处方才能买抗生素。"},{"front":"The recommended dosage is one tablet per day.","back":"推荐剂量是每天一片。"},{"front":"The pharmacist explained how to use the inhaler.","back":"药剂师解释了如何使用吸入器。"},{"front":"Please add 200 millilitres of water to the mixture.","back":"请向混合物中加入200毫升水。"},{"front":"The cashier gave me the receipt after I paid.","back":"我付款后收银员给了我收据。"},{"front":"This pill is hard to swallow without water.","back":"没有水这药丸很难吞下去。"},{"front":"Spicy food often gives me an upset stomach.","back":"辛辣食物经常让我胃部不适。"},{"front":"Fever is a common symptom of the flu.","back":"发烧是流感的常见症状。"},{"front":"The painkillers should start to work in about 30 minutes.","back":"止痛药应该在大约30分钟内开始起效。"},{"front":"Do not take this medicine on an empty stomach.","back":"不要空腹服用此药。"},{"front":"Lack of sleep can cause a severe headache.","back":"睡眠不足会导致严重的头痛。"},{"front":"You should consult your doctor before starting a new diet.","back":"在开始新饮食计划前你应该咨询医生。"},{"front":"The massage provided instant relief from the pain.","back":"按摩使疼痛立即得到缓解。"},{"front":"I recommend the seafood pasta; it is delicious.","back":"我推荐海鲜意面；它很好吃。"},{"front":"Try to avoid coffee late at night.","back":"尽量避免在深夜喝咖啡。"},{"front":"Follow the instructions on the label carefully.","back":"仔细遵循标签上的说明。"},{"front":"The frequency of the buses increases during rush hour.","back":"高峰时段公交车的频率会增加。"},{"front":"He takes medication for high blood pressure.","back":"他服用治疗高血压的药物。"},{"front":"This medicine might make you feel drowsy.","back":"这种药可能会让你感到昏昏欲睡。"},{"front":"It doesn't matter which color you choose.","back":"你选哪个颜色都没关系。"},{"front":"Brush your teeth at least twice a day.","back":"每天至少刷两次牙。"},{"front":"This cleaning spray is very effective against grease.","back":"这种清洁喷雾去油污非常有效。"},{"front":"She felt a sharp pain in her shoulder.","back":"她感到肩膀一阵剧痛。"}],"group_4":[{"front":"长跑后我的腿很酸痛。","back":"My legs are sore after the long run."},{"front":"含一颗润喉糖可以缓解喉咙干燥。","back":"Sucking on a lozenge can soothe a dry throat."},{"front":"你需要医生的处方才能买抗生素。","back":"You need a doctor's prescription to buy antibiotics."},{"front":"推荐剂量是每天一片。","back":"The recommended dosage is one tablet per day."},{"front":"药剂师解释了如何使用吸入器。","back":"The pharmacist explained how to use the inhaler."},{"front":"请向混合物中加入200毫升水。","back":"Please add 200 millilitres of water to the mixture."},{"front":"我付款后收银员给了我收据。","back":"The cashier gave me the receipt after I paid."},{"front":"没有水这药丸很难吞下去。","back":"This pill is hard to swallow without water."},{"front":"辛辣食物经常让我胃部不适。","back":"Spicy food often gives me an upset stomach."},{"front":"发烧是流感的常见症状。","back":"Fever is a common symptom of the flu."},{"front":"止痛药应该在大约30分钟内开始起效。","back":"The painkillers should start to work in about 30 minutes."},{"front":"不要空腹服用此药。","back":"Do not take this medicine on an empty stomach."},{"front":"睡眠不足会导致严重的头痛。","back":"Lack of sleep can cause a severe headache."},{"front":"在开始新饮食计划前你应该咨询医生。","back":"You should consult your doctor before starting a new diet."},{"front":"按摩使疼痛立即得到缓解。","back":"The massage provided instant relief from the pain."},{"front":"我推荐海鲜意面；它很好吃。","back":"I recommend the seafood pasta; it is delicious."},{"front":"尽量避免在深夜喝咖啡。","back":"Try to avoid coffee late at night."},{"front":"仔细遵循标签上的说明。","back":"Follow the instructions on the label carefully."},{"front":"高峰时段公交车的频率会增加。","back":"The frequency of the buses increases during rush hour."},{"front":"他服用治疗高血压的药物。","back":"He takes medication for high blood pressure."},{"front":"这种药可能会让你感到昏昏欲睡。","back":"This medicine might make you feel drowsy."},{"front":"你选哪个颜色都没关系。","back":"It doesn't matter which color you choose."},{"front":"每天至少刷两次牙。","back":"Brush your teeth at least twice a day."},{"front":"这种清洁喷雾去油污非常有效。","back":"This cleaning spray is very effective against grease."},{"front":"她感到肩膀一阵剧痛。","back":"She felt a sharp pain in her shoulder."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What symptom does the first customer (Nicolo) complain about?","options":["A. A headache","B. A sore throat","C. An earache"],"ans":"B. A sore throat"},{"type":"tf","q":"The pharmacist suggests Nicolo take the cold medicine immediately.","options":["True","False"],"ans":"False"},{"type":"fill","q":"Nicolo is told to pay for his items at the ______.","options":[],"ans":"cashier"},{"type":"mc","q":"How often should Mr. Amador take his medicine?","options":["A. Once a day","B. Twice a day","C. Three times a day"],"ans":"B. Twice a day"},{"type":"fill","q":"The pharmacist says Mr. Amador's ear will feel better in a ______ hours.","options":[],"ans":"few"},{"type":"dict","q":"Listen and write the sentence about when to take the pills.","options":[],"ans":"The pills may upset your stomach if it is empty.","srcText":"The pills may upset your stomach if it is empty."},{"type":"mc","q":"Why should Jan wait until after lunch to take the pain pills?","options":["A. To help him sleep","B. To avoid an upset stomach","C. Because they cost more"],"ans":"B. To avoid an upset stomach"},{"type":"tf","q":"Resa must take her headache medicine with food.","options":["True","False"],"ans":"False"},{"type":"mc","q":"How long does the headache medicine take to work?","options":["A. About 20 minutes","B. One hour","C. Immediately"],"ans":"A. About 20 minutes"},{"type":"fill","q":"Resa can take the pills up to ______ times a day.","options":[],"ans":"six"}]; 
        let vocabQuestions = [{"type":"mc","q":"If your muscles hurt after exercise, they are ______.","options":["A. Happy","B. Sore","C. Empty"],"ans":"B. Sore"},{"type":"fill","q":"A small candy that contains medicine for a sore throat is a ______.","options":[],"ans":"lozenge"},{"type":"tf","q":"You can buy a 'prescription' medicine off the shelf without a doctor's note.","options":["True","False"],"ans":"False"},{"type":"mc","q":"The amount of medicine you should take is called the...","options":["A. Price","B. Dosage","C. Weight"],"ans":"B. Dosage"},{"type":"fill","q":"The person who prepares your medicine at the drugstore is the ______.","options":[],"ans":"pharmacist"},{"type":"mc","q":"What is the short form for 'millilitre'?","options":["A. mm","B. ml","C. mg"],"ans":"B. ml"},{"type":"fill","q":"You pay for your items at the ______.","options":[],"ans":"cashier"},{"type":"mc","q":"Another word for a tablet of medicine is a...","options":["A. Pill","B. Liquid","C. Shot"],"ans":"A. Pill"},{"type":"tf","q":"If you have an 'upset stomach', your stomach feels good.","options":["True","False"],"ans":"False"},{"type":"fill","q":"A physical sign of an illness, like a cough, is a ______.","options":[],"ans":"symptom"},{"type":"mc","q":"When medicine 'starts to work', it...","options":["A. Expires","B. Takes effect","C. Tastes bad"],"ans":"B. Takes effect"},{"type":"fill","q":"If you haven't eaten anything, your stomach is ______.","options":[],"ans":"empty"},{"type":"mc","q":"A pain in your head is called a...","options":["A. Backache","B. Headache","C. Toothache"],"ans":"B. Headache"},{"type":"mc","q":"To ask a professional for advice is to ______ them.","options":["A. Consult","B. Command","C. Ignore"],"ans":"A. Consult"},{"type":"fill","q":"Taking medicine can provide ______ from pain.","options":[],"ans":"relief"},{"type":"tf","q":"If someone 'recommends' a movie, they think you should see it.","options":["True","False"],"ans":"True"},{"type":"mc","q":"To stay away from something is to...","options":["A. Avoid","B. Accept","C. Attract"],"ans":"A. Avoid"},{"type":"fill","q":"You should read the ______ on the bottle before taking the medicine.","options":[],"ans":"instructions"},{"type":"mc","q":"How often something happens is its...","options":["A. Frequency","B. Size","C. Color"],"ans":"A. Frequency"},{"type":"fill","q":"Another general word for medicine is ______.","options":[],"ans":"medication"},{"type":"mc","q":"If you feel 'drowsy', you feel...","options":["A. Energetic","B. Sleepy","C. Hungry"],"ans":"B. Sleepy"},{"type":"tf","q":"If 'it doesn't matter', it is not important.","options":["True","False"],"ans":"True"},{"type":"mc","q":"Taking a pill in the morning and at night is taking it...","options":["A. Once a day","B. Twice a day","C. Every hour"],"ans":"B. Twice a day"},{"type":"tf","q":"An 'effective' medicine works well.","options":["True","False"],"ans":"True"},{"type":"fill","q":"A feeling of hurt in your body is called ______.","options":[],"ans":"pain"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>