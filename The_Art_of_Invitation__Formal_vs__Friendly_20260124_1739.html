<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Art of Invitation: Formal vs. Friendly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> The Art of Invitation: Formal vs. Friendly</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"Hey Sarah, do you have a moment to help me with some emails?","cn":"嘿，Sarah，你有空帮我看几封邮件吗？"},{"en":"Sure, Mark. What are you working on?","cn":"当然，Mark。你在忙什么？"},{"en":"I need to send out two types of invitations today.","cn":"我今天需要发出两种邀请函。"},{"en":"One is for the company's Grand Opening next month, and the other is for a casual get-together with my department.","cn":"一个是下个月公司的盛大开业典礼，另一个是我们部门的非正式聚会。"},{"en":"Those require very different tones.","cn":"这需要完全不同的语气。"},{"en":"For the Grand Opening, you must strictly follow professional etiquette.","cn":"对于盛大开业典礼，你必须严格遵守职场礼仪。"},{"en":"I started the formal one with 'Dear Mr. Smith'. Is that correct?","cn":"正式的那封我用了“Dear Mr. Smith”开头。这还是对的吗？"},{"en":"Yes, a formal salutation is essential.","cn":"是的，正式的称呼是必不可少的。"},{"en":"You should also use the phrase 'cordially invited' to sound more polite.","cn":"你还应该使用“cordially invited”（诚挚邀请）这个短语，听起来更有礼貌。"},{"en":"Make sure you clearly state the agenda and the dress code.","cn":"确保你清楚地说明了日程安排和着装要求。"},{"en":"Right, I mentioned it is a black-tie event.","cn":"对，我提到了这是一个黑领结（正装）活动。"},{"en":"What about the grammar? I read about using specific tenses.","cn":"语法呢？我读到过要使用特定的时态。"},{"en":"Use the present tense for factual details like time and venue.","cn":"对于时间和地点等事实细节，使用一般现在时。"},{"en":"Use the future tense to express anticipation, like 'We hope you will attend'.","cn":"使用将来时表达期待，比如“我们希望您能出席”。"},{"en":"Got it. And for the casual team lunch?","cn":"明白了。那部门的非正式午餐呢？"},{"en":"Keep it friendly. You can just start with 'Hi team' and mention it's a potluck.","cn":"保持友好。你可以直接用“Hi team”开头，并提到这是百家餐（自带菜肴聚餐）。"},{"en":"I used a compound sentence there: 'I am bringing salad, so please bring a dessert.'","cn":"我在那里用了一个复合句：“我带沙拉，所以请带一份甜点。”"},{"en":"That uses 'so', which is a coordinating conjunction. Good job.","cn":"那里用了“so”，这是一个并列连词。做得好。"},{"en":"Just remember to capitalize proper nouns and checking your punctuation.","cn":"只要记住大写专有名词并检查你的标点符号。"},{"en":"Don't forget to ask for an RSVP by a specific date for both events.","cn":"别忘了要求这两个活动都在特定日期前回复（RSVP）。"},{"en":"Thanks! I will sign off the formal one with 'Sincerely' and the casual one with 'Cheers'.","cn":"谢谢！正式的那封我会用“Sincerely”结尾，非正式的用“Cheers”。"}];
        const knowledgePoints = [{"cat":"Vocabulary","point":"Invitation","ex":"I received an invitation to their wedding.","ipa":""},{"cat":"Vocabulary","point":"Salutation","ex":"Start your formal letter with a proper salutation.","ipa":""},{"cat":"Phrase","point":"Cordially invited","ex":"You are cordially invited to the annual gala.","ipa":""},{"cat":"Vocabulary","point":"Venue","ex":"The hotel is the perfect venue for the conference.","ipa":""},{"cat":"Vocabulary","point":"Agenda","ex":"The agenda includes a keynote speech and dinner.","ipa":""},{"cat":"Phrase","point":"Dress code","ex":"The dress code for the party is casual.","ipa":""},{"cat":"Vocabulary","point":"Professional","ex":"Keep your email tone professional at work.","ipa":""},{"cat":"Vocabulary","point":"Etiquette","ex":"Learning business etiquette is important for your career.","ipa":""},{"cat":"Phrase","point":"Grand Opening","ex":"The store's Grand Opening is next Friday.","ipa":""},{"cat":"Phrase","point":"Get-together","ex":"We are having a small get-together at my house.","ipa":""},{"cat":"Vocabulary","point":"Casual","ex":"It's a casual meeting, so jeans are fine.","ipa":""},{"cat":"Vocabulary","point":"Potluck","ex":"Everyone brought a dish to the office potluck.","ipa":""},{"cat":"Phrase","point":"Look forward to","ex":"I look forward to meeting you soon.","ipa":""},{"cat":"Vocabulary","point":"Anticipation","ex":"We waited in anticipation for the results.","ipa":""},{"cat":"Vocabulary","point":"Confirmation","ex":"Please send a confirmation of your attendance.","ipa":""},{"cat":"Abbreviation","point":"RSVP","ex":"Please RSVP by Monday.","ipa":""},{"cat":"Phrase","point":"Sign off","ex":"How should I sign off this email?","ipa":""},{"cat":"Vocabulary","point":"Sincerely","ex":"Yours sincerely, John Doe.","ipa":""},{"cat":"Grammar","point":"Coordinating conjunction","ex":"Words like 'and', 'but', and 'so' are coordinating conjunctions.","ipa":""},{"cat":"Grammar","point":"Compound sentence","ex":"A compound sentence connects two independent clauses.","ipa":""},{"cat":"Grammar","point":"Proper noun","ex":"'London' is a proper noun.","ipa":""},{"cat":"Grammar","point":"Capitalize","ex":"Always capitalize the first letter of a name.","ipa":""},{"cat":"Vocabulary","point":"Punctuation","ex":"Correct punctuation makes writing easier to read.","ipa":""},{"cat":"Vocabulary","point":"Host","ex":"Who will host the event this year?","ipa":""},{"cat":"Phrase","point":"Make it","ex":"I hope you can make it to my party.","ipa":""},{"cat":"Vocabulary","point":"Theme","ex":"The theme of the party is 'Retro 80s'.","ipa":""},{"cat":"Phrase","point":"Request the presence","ex":"We request the presence of your company at the wedding.","ipa":""},{"cat":"Grammar","point":"Present Tense","ex":"Use present tense for facts.","ipa":""},{"cat":"Grammar","point":"Future Tense","ex":"The event will start at 8 PM.","ipa":""},{"cat":"Phrase","point":"Best regards","ex":"End your email with 'Best regards'.","ipa":""}];
        const cultureData = [{"en":"In Western culture, 'RSVP' stands for the French phrase 'Répondez s'il vous plaît' (Please respond). It is crucial for hosts to know the headcount for food and seating. For formal events, responding by the specified date is a strict social obligation. 'Potluck' is a common informal gathering method in North America where guests contribute a dish to the meal, symbolizing community and sharing.","cn":"在西方文化中，'RSVP'是法语'Répondez s'il vous plaît'（请回复）的缩写。对于主人来说，了解人数以便安排食物和座位至关重要。对于正式活动，在指定日期前回复是严格的社交义务。'Potluck'（百家餐）是北美常见的一种非正式聚会方式，客人各自带一道菜分享，象征着社区精神和分享。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"invitation (n.) /ˌɪnvɪˈteɪʃən/","back":"邀请；请柬"},{"front":"salutation (n.) /ˌsæljʊˈteɪʃən/","back":"称呼；致意"},{"front":"cordially (adv.) /ˈkɔːrdʒəli/","back":"诚挚地"},{"front":"venue (n.) /ˈvɛnjuː/","back":"地点；会场"},{"front":"agenda (n.) /əˈdʒɛndə/","back":"议程"},{"front":"dress code (n. phr.) /drɛs kəʊd/","back":"着装要求"},{"front":"professional (adj.) /prəˈfɛʃənl/","back":"专业的；职业的"},{"front":"etiquette (n.) /ˈɛtɪkɛt/","back":"礼仪；规矩"},{"front":"grand opening (n. phr.) /grænd ˈəʊpnɪŋ/","back":"盛大开业"},{"front":"get-together (n.) /ˈgɛt təˌgɛðər/","back":"聚会（非正式）"},{"front":"casual (adj.) /ˈkæʒjuəl/","back":"非正式的；休闲的"},{"front":"potluck (n.) /ˈpɒtlʌk/","back":"百家餐（自带菜肴的聚餐）"},{"front":"look forward to (v. phr.) /lʊk ˈfɔːrwərd tuː/","back":"期待"},{"front":"anticipation (n.) /ænˌtɪsɪˈpeɪʃən/","back":"期待；预料"},{"front":"confirmation (n.) /ˌkɒnfəˈmeɪʃən/","back":"确认"},{"front":"RSVP (abbr.) /ˌɑːrɛsviːˈpiː/","back":"请回复"},{"front":"sign off (v. phr.) /saɪn ɒf/","back":"结尾；签退"},{"front":"sincerely (adv.) /sɪnˈsɪəli/","back":"真诚地"},{"front":"coordinating conjunction (n. phr.) /kəʊˈɔːrdɪneɪtɪŋ kənˈdʒʌŋkʃən/","back":"并列连词"},{"front":"compound sentence (n. phr.) /ˈkɒmpaʊnd ˈsɛntəns/","back":"复合句"},{"front":"proper noun (n. phr.) /ˈprɒpər naʊn/","back":"专有名词"},{"front":"capitalize (v.) /ˈkæpɪtəlaɪz/","back":"大写"},{"front":"punctuation (n.) /ˌpʌŋktʃuˈeɪʃən/","back":"标点符号"},{"front":"host (v.) /həʊst/","back":"主办；主持"},{"front":"make it (v. phr.) /meɪk ɪt/","back":"赶上；能出席"},{"front":"theme (n.) /θiːm/","back":"主题"},{"front":"request the presence (v. phr.) /rɪˈkwɛst ðə ˈprɛzns/","back":"敬请光临"},{"front":"present tense (n. phr.) /ˈprɛznt tɛns/","back":"现在时"},{"front":"future tense (n. phr.) /ˈfjuːtʃər tɛns/","back":"将来时"},{"front":"best regards (n. phr.) /bɛst rɪˈgɑːdz/","back":"诚挚的问候"}],"group_2":[{"front":"邀请；请柬","back":"invitation (n.) /ˌɪnvɪˈteɪʃən/"},{"front":"称呼；致意","back":"salutation (n.) /ˌsæljʊˈteɪʃən/"},{"front":"诚挚地","back":"cordially (adv.) /ˈkɔːrdʒəli/"},{"front":"地点；会场","back":"venue (n.) /ˈvɛnjuː/"},{"front":"议程","back":"agenda (n.) /əˈdʒɛndə/"},{"front":"着装要求","back":"dress code (n. phr.) /drɛs kəʊd/"},{"front":"专业的；职业的","back":"professional (adj.) /prəˈfɛʃənl/"},{"front":"礼仪；规矩","back":"etiquette (n.) /ˈɛtɪkɛt/"},{"front":"盛大开业","back":"grand opening (n. phr.) /grænd ˈəʊpnɪŋ/"},{"front":"聚会（非正式）","back":"get-together (n.) /ˈgɛt təˌgɛðər/"},{"front":"非正式的；休闲的","back":"casual (adj.) /ˈkæʒjuəl/"},{"front":"百家餐（自带菜肴的聚餐）","back":"potluck (n.) /ˈpɒtlʌk/"},{"front":"期待","back":"look forward to (v. phr.) /lʊk ˈfɔːrwərd tuː/"},{"front":"期待；预料","back":"anticipation (n.) /ænˌtɪsɪˈpeɪʃən/"},{"front":"确认","back":"confirmation (n.) /ˌkɒnfəˈmeɪʃən/"},{"front":"请回复","back":"RSVP (abbr.) /ˌɑːrɛsviːˈpiː/"},{"front":"结尾；签退","back":"sign off (v. phr.) /saɪn ɒf/"},{"front":"真诚地","back":"sincerely (adv.) /sɪnˈsɪəli/"},{"front":"并列连词","back":"coordinating conjunction (n. phr.) /kəʊˈɔːrdɪneɪtɪŋ kənˈdʒʌŋkʃən/"},{"front":"复合句","back":"compound sentence (n. phr.) /ˈkɒmpaʊnd ˈsɛntəns/"},{"front":"专有名词","back":"proper noun (n. phr.) /ˈprɒpər naʊn/"},{"front":"大写","back":"capitalize (v.) /ˈkæpɪtəlaɪz/"},{"front":"标点符号","back":"punctuation (n.) /ˌpʌŋktʃuˈeɪʃən/"},{"front":"主办；主持","back":"host (v.) /həʊst/"},{"front":"赶上；能出席","back":"make it (v. phr.) /meɪk ɪt/"},{"front":"主题","back":"theme (n.) /θiːm/"},{"front":"敬请光临","back":"request the presence (v. phr.) /rɪˈkwɛst ðə ˈprɛzns/"},{"front":"现在时","back":"present tense (n. phr.) /ˈprɛznt tɛns/"},{"front":"将来时","back":"future tense (n. phr.) /ˈfjuːtʃər tɛns/"},{"front":"诚挚的问候","back":"best regards (n. phr.) /bɛst rɪˈgɑːdz/"}],"group_3":[{"front":"I received an invitation to their wedding.","back":"我收到了他们婚礼的请柬。"},{"front":"Start your formal letter with a proper salutation.","back":"用恰当的称呼开始你的正式信函。"},{"front":"You are cordially invited to the annual gala.","back":"诚挚邀请您参加年度晚会。"},{"front":"The hotel is the perfect venue for the conference.","back":"这家酒店是举办会议的理想场所。"},{"front":"The agenda includes a keynote speech and dinner.","back":"议程包括主题演讲和晚餐。"},{"front":"The dress code for the party is casual.","back":"派对的着装要求是休闲。"},{"front":"Keep your email tone professional at work.","back":"工作中邮件语气要保持专业。"},{"front":"Learning business etiquette is important for your career.","back":"学习商务礼仪对你的职业生涯很重要。"},{"front":"The store's Grand Opening is next Friday.","back":"这家店的盛大开业典礼在下周五。"},{"front":"We are having a small get-together at my house.","back":"我们正在我家搞一个小聚会。"},{"front":"It's a casual meeting, so jeans are fine.","back":"这是个非正式会议，所以穿牛仔裤没关系。"},{"front":"Everyone brought a dish to the office potluck.","back":"每个人都给办公室的百家餐带了一道菜。"},{"front":"I look forward to meeting you soon.","back":"我期待很快见到你。"},{"front":"We waited in anticipation for the results.","back":"我们期待着结果。"},{"front":"Please send a confirmation of your attendance.","back":"请发送您出席的确认函。"},{"front":"Please RSVP by Monday.","back":"请在周一前回复。"},{"front":"How should I sign off this email?","back":"这封邮件我该如何结尾？"},{"front":"Yours sincerely, John Doe.","back":"你真诚的，John Doe。"},{"front":"Words like 'and', 'but', and 'so' are coordinating conjunctions.","back":"像'and'、'but'和'so'这样的词是并列连词。"},{"front":"A compound sentence connects two independent clauses.","back":"复合句连接两个独立的子句。"},{"front":"'London' is a proper noun.","back":"‘伦敦’是一个专有名词。"},{"front":"Always capitalize the first letter of a name.","back":"名字的首字母总是要大写。"},{"front":"Correct punctuation makes writing easier to read.","back":"正确的标点符号使文章更易读。"},{"front":"Who will host the event this year?","back":"今年谁将主办这次活动？"},{"front":"I hope you can make it to my party.","back":"我希望你能来参加我的派对。"},{"front":"The theme of the party is 'Retro 80s'.","back":"派对的主题是‘复古80年代’。"},{"front":"We request the presence of your company at the wedding.","back":"敬请光临我们的婚礼。"},{"front":"Use present tense for facts.","back":"事实描述使用现在时。"},{"front":"The event will start at 8 PM.","back":"活动将于晚上8点开始。"},{"front":"End your email with 'Best regards'.","back":"用‘诚挚的问候’结束你的邮件。"}],"group_4":[{"front":"我收到了他们婚礼的请柬。","back":"I received an invitation to their wedding."},{"front":"用恰当的称呼开始你的正式信函。","back":"Start your formal letter with a proper salutation."},{"front":"诚挚邀请您参加年度晚会。","back":"You are cordially invited to the annual gala."},{"front":"这家酒店是举办会议的理想场所。","back":"The hotel is the perfect venue for the conference."},{"front":"议程包括主题演讲和晚餐。","back":"The agenda includes a keynote speech and dinner."},{"front":"派对的着装要求是休闲。","back":"The dress code for the party is casual."},{"front":"工作中邮件语气要保持专业。","back":"Keep your email tone professional at work."},{"front":"学习商务礼仪对你的职业生涯很重要。","back":"Learning business etiquette is important for your career."},{"front":"这家店的盛大开业典礼在下周五。","back":"The store's Grand Opening is next Friday."},{"front":"我们正在我家搞一个小聚会。","back":"We are having a small get-together at my house."},{"front":"这是个非正式会议，所以穿牛仔裤没关系。","back":"It's a casual meeting, so jeans are fine."},{"front":"每个人都给办公室的百家餐带了一道菜。","back":"Everyone brought a dish to the office potluck."},{"front":"我期待很快见到你。","back":"I look forward to meeting you soon."},{"front":"我们期待着结果。","back":"We waited in anticipation for the results."},{"front":"请发送您出席的确认函。","back":"Please send a confirmation of your attendance."},{"front":"请在周一前回复。","back":"Please RSVP by Monday."},{"front":"这封邮件我该如何结尾？","back":"How should I sign off this email?"},{"front":"你真诚的，John Doe。","back":"Yours sincerely, John Doe."},{"front":"像'and'、'but'和'so'这样的词是并列连词。","back":"Words like 'and', 'but', and 'so' are coordinating conjunctions."},{"front":"复合句连接两个独立的子句。","back":"A compound sentence connects two independent clauses."},{"front":"‘伦敦’是一个专有名词。","back":"'London' is a proper noun."},{"front":"名字的首字母总是要大写。","back":"Always capitalize the first letter of a name."},{"front":"正确的标点符号使文章更易读。","back":"Correct punctuation makes writing easier to read."},{"front":"今年谁将主办这次活动？","back":"Who will host the event this year?"},{"front":"我希望你能来参加我的派对。","back":"I hope you can make it to my party."},{"front":"派对的主题是‘复古80年代’。","back":"The theme of the party is 'Retro 80s'."},{"front":"敬请光临我们的婚礼。","back":"We request the presence of your company at the wedding."},{"front":"事实描述使用现在时。","back":"Use present tense for facts."},{"front":"活动将于晚上8点开始。","back":"The event will start at 8 PM."},{"front":"用‘诚挚的问候’结束你的邮件。","back":"End your email with 'Best regards'."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What are the two types of events Mark is planning?","options":["A. A wedding and a birthday party","B. A Grand Opening and a casual get-together","C. A business conference and a client dinner","D. A graduation ceremony and a halloween party"],"ans":"B. A Grand Opening and a casual get-together"},{"type":"tf","q":"Sarah suggests using a friendly tone for the Grand Opening invitation.","options":["True","False"],"ans":"False"},{"type":"fill","q":"For factual details like time and venue, Sarah advises using the ______ tense.","options":["A. Past","B. Future","C. Present","D. Perfect"],"ans":"C. Present"},{"type":"mc","q":"Which phrase does Sarah recommend to make the formal invitation sound more polite?","options":["A. Totally welcome","B. Cordially invited","C. Come over","D. Happy to see you"],"ans":"B. Cordially invited"},{"type":"dict","q":"Listen and select the correct sentence mentioned in the dialogue regarding grammar.","options":["A. I am bringing salad, yet please bring a dessert.","B. I am bringing salad, so please bring a dessert.","C. I am bringing salad, for please bring a dessert.","D. I am bringing salad, nor please bring a dessert."],"ans":"B. I am bringing salad, so please bring a dessert.","srcText":"B. I am bringing salad, so please bring a dessert."},{"type":"tf","q":"Mark plans to sign off the casual email with 'Sincerely'.","options":["True","False"],"ans":"False"},{"type":"mc","q":"What is a 'potluck' as mentioned in the conversation?","options":["A. A formal black-tie dinner","B. A meeting with clients","C. A meal where guests bring food to share","D. A specific type of salad"],"ans":"C. A meal where guests bring food to share"},{"type":"fill","q":"Mark is reminded to capitalize ______ nouns.","options":["A. Common","B. Abstract","C. Proper","D. Collective"],"ans":"C. Proper"},{"type":"mc","q":"What word is used to describe the word 'so' in the dialogue?","options":["A. Preposition","B. Coordinating conjunction","C. Adjective","D. Pronoun"],"ans":"B. Coordinating conjunction"},{"type":"tf","q":"An RSVP is only required for the formal event.","options":["True","False"],"ans":"False"}]; 
        let vocabQuestions = [{"type":"fill","q":"Please send me an ______ to the meeting.","options":["A. etiquette","B. invitation","C. agenda","D. anticipation"],"ans":"B. invitation"},{"type":"mc","q":"Which word is best used for a formal greeting?","options":["A. Hey","B. Hi","C. Salutation","D. Cheers"],"ans":"C. Salutation"},{"type":"fill","q":"You are ______ invited to the wedding ceremony.","options":["A. casually","B. cordially","C. loosely","D. simply"],"ans":"B. cordially"},{"type":"mc","q":"The location where an event is held is called a ______.","options":["A. menu","B. venue","C. theme","D. host"],"ans":"B. venue"},{"type":"tf","q":"The 'agenda' refers to the list of activities planned for a meeting or event.","options":["True","False"],"ans":"True"},{"type":"fill","q":"Please check the ______ to know if you need to wear a suit.","options":["A. dress code","B. address","C. grand opening","D. salutation"],"ans":"A. dress code"},{"type":"mc","q":"Which adjective describes a business-like and respectful manner?","options":["A. casual","B. messy","C. professional","D. potluck"],"ans":"C. professional"},{"type":"fill","q":"It is good ______ to reply to invitations promptly.","options":["A. grammar","B. etiquette","C. theme","D. venue"],"ans":"B. etiquette"},{"type":"fill","q":"We are celebrating the ______ of our new branch next week.","options":["A. get-together","B. grand opening","C. sign off","D. rsvp"],"ans":"B. grand opening"},{"type":"mc","q":"A small, informal meeting of friends can be called a ______.","options":["A. grand opening","B. conference","C. get-together","D. ceremony"],"ans":"C. get-together"},{"type":"tf","q":"A 'casual' event requires formal wear like a tuxedo.","options":["True","False"],"ans":"False"},{"type":"fill","q":"For the office ______, everyone needs to cook something.","options":["A. potluck","B. meeting","C. agenda","D. venue"],"ans":"A. potluck"},{"type":"mc","q":"Which phrase expresses excitement about a future event?","options":["A. look forward to","B. look back on","C. look for","D. look after"],"ans":"A. look forward to"},{"type":"fill","q":"We waited in ______ for the concert to begin.","options":["A. etiquette","B. anticipation","C. punctuation","D. confirmation"],"ans":"B. anticipation"},{"type":"mc","q":"I need ______ that you have received my email.","options":["A. confirmation","B. invitation","C. salutation","D. theme"],"ans":"A. confirmation"},{"type":"fill","q":"Please ______ by Friday so we can order enough food.","options":["A. RSVP","B. host","C. capitalize","D. sign off"],"ans":"A. RSVP"},{"type":"mc","q":"To 'sign off' means to ______.","options":["A. start a letter","B. end a letter","C. write a letter","D. mail a letter"],"ans":"B. end a letter"},{"type":"fill","q":"Yours ______, [Your Name].","options":["A. happily","B. sincerely","C. casually","D. loudly"],"ans":"B. sincerely"},{"type":"mc","q":"Which of these is a coordinating conjunction?","options":["A. because","B. but","C. although","D. if"],"ans":"B. but"},{"type":"tf","q":"A compound sentence contains two independent clauses.","options":["True","False"],"ans":"True"},{"type":"mc","q":"A name like 'Paris' is a ______ noun.","options":["A. common","B. proper","C. plural","D. verb"],"ans":"B. proper"},{"type":"fill","q":"You must ______ the word 'I' when writing about yourself.","options":["A. lower","B. capitalize","C. remove","D. highlight"],"ans":"B. capitalize"},{"type":"fill","q":"Use a comma for correct ______.","options":["A. punctuation","B. spelling","C. sound","D. verb"],"ans":"A. punctuation"},{"type":"mc","q":"Who will ______ the party this weekend?","options":["A. guest","B. host","C. visit","D. invite"],"ans":"B. host"},{"type":"fill","q":"I hope you can ______ to the dinner tonight.","options":["A. make it","B. do it","C. see it","D. take it"],"ans":"A. make it"},{"type":"mc","q":"The ______ of the party was 'Hollywood Stars'.","options":["A. venue","B. theme","C. date","D. time"],"ans":"B. theme"},{"type":"fill","q":"We ______ your presence at our celebration.","options":["A. ask","B. request","C. tell","D. say"],"ans":"B. request"},{"type":"tf","q":"The 'Present Tense' is used to describe things happening now or facts.","options":["True","False"],"ans":"True"},{"type":"mc","q":"Which tense is used in: 'We will meet at 5 PM'?","options":["A. Past Tense","B. Present Tense","C. Future Tense","D. Continuous Tense"],"ans":"C. Future Tense"},{"type":"fill","q":"Please accept my ______.","options":["A. best regards","B. hi","C. see you","D. cheers"],"ans":"A. best regards"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>