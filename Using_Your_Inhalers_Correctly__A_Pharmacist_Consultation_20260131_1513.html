<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using Your Inhalers Correctly: A Pharmacist Consultation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-icon { @apply p-2 rounded-full transition duration-300; }
        .btn-icon:hover { @apply bg-opacity-20 bg-gray-500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-md z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center"><i class="fas fa-graduation-cap mr-2"></i> Using Your Inhalers Correctly: A Pharmacist Consultation</h1>
        <div class="text-xs opacity-70">Generated by English HTML Extension</div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm overflow-x-auto z-10">
        <div class="container mx-auto flex">
            <button onclick="app.switchTab('material')" class="tab-btn active px-6 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-material">英文素材</button>
            <button onclick="app.switchTab('listening')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-listening">听力练习</button>
            <button onclick="app.switchTab('culture')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-culture">文化背景</button>
            <button onclick="app.switchTab('knowledge')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-knowledge">知识点</button>
            <button onclick="app.switchTab('flashcards')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-flashcards">单词卡片</button>
            <button onclick="app.switchTab('vocabtest')" class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-indigo-600 hover:bg-gray-50 transition whitespace-nowrap" id="btn-vocabtest">词汇测试</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gray-100 p-4 md:p-6 relative">
        <div class="container mx-auto max-w-5xl bg-white rounded-xl shadow-lg min-h-full p-6">

            <!-- 1. English Material Tab -->
            <div id="material" class="tab-content active">
                <div class="flex flex-wrap gap-2 mb-6 sticky top-0 bg-white py-2 z-10 border-b">
                    <button onclick="app.toggleCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold ${data.dialogue.some(d => d.cn) ? '' : 'hidden'}"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.toggleDictation()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-semibold"><i class="fas fa-pen-nib mr-1"></i> 听写模式</button>
                    <button onclick="app.playFullAudio('dialogue')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="dialogue-container" class="space-y-4"></div>
            </div>

            <!-- 2. Listening Exercises Tab -->
            <div id="listening" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">听力理解测试</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('listening')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('listening')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="listening-container" class="space-y-6"></div>
            </div>

            <!-- 3. Culture Tab -->
            <div id="culture" class="tab-content">
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="app.toggleCultureCN()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-semibold"><i class="fas fa-language mr-1"></i> 显示/隐藏中文</button>
                    <button onclick="app.toggleCultureEN()" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-semibold"><i class="fas fa-eye-slash mr-1"></i> 显示/隐藏英文</button>
                    <button onclick="app.playFullAudio('culture')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-semibold"><i class="fas fa-headphones mr-1"></i> 朗读整段</button>
                </div>
                <div id="culture-container" class="space-y-6 text-lg leading-relaxed"></div>
            </div>

            <!-- 4. Knowledge Points Tab -->
            <div id="knowledge" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">核心词汇与句型</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-4 text-left">类别</th>
                                <th class="py-3 px-4 text-left">知识点</th>
                                <th class="py-3 px-4 text-left">中文释义</th>
                                <th class="py-3 px-4 text-left">例句 & 翻译</th>
                            </tr>
                        </thead>
                        <tbody id="knowledge-table-body" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Flashcards Tab -->
            <div id="flashcards" class="tab-content">
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <div class="flex space-x-2 mb-6">
                        <button onclick="app.setCardMode(0)" class="mode-btn px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-mode="0">英 -> 中</button>
                        <button onclick="app.setCardMode(1)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="1">中 -> 英</button>
                        <button onclick="app.setCardMode(2)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="2">例句 -> 译文</button>
                        <button onclick="app.setCardMode(3)" class="mode-btn px-3 py-1 rounded bg-gray-200 text-gray-700 text-sm" data-mode="3">译文 -> 例句</button>
                    </div>

                    <div class="perspective-1000 w-full max-w-md h-80 cursor-pointer group" onclick="app.flipCard()">
                        <div id="flashcard-inner" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                            <!-- Front -->
                            <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex flex-col justify-center items-center p-6">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'front')" class="text-white hover:text-yellow-300 transition text-2xl p-2 rounded-full hover:bg-white/20"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-front-text" class="text-3xl font-bold mb-2">Front</h3>
                                <p id="card-front-sub" class="text-indigo-200 italic">type/IPA</p>
                                <p class="mt-8 text-sm opacity-70 absolute bottom-4">点击翻转</p>
                            </div>
                            <!-- Back -->
                            <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white text-gray-800 rounded-2xl flex flex-col justify-center items-center p-6 border-2 border-indigo-100">
                                <div class="absolute top-4 right-4 z-20">
                                    <button onclick="app.playCardAudio(event, 'back')" class="text-indigo-600 hover:text-indigo-800 transition text-2xl p-2 rounded-full hover:bg-indigo-50"><i class="fas fa-volume-up"></i></button>
                                </div>
                                <h3 id="card-back-text" class="text-2xl font-bold mb-2">Back</h3>
                                <p id="card-back-sub" class="text-gray-500">Details</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-8 mt-8">
                        <button onclick="app.prevCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-left"></i></button>
                        <span id="card-counter" class="font-mono text-gray-500">1 / 20</span>
                        <button onclick="app.nextCard()" class="p-4 bg-white rounded-full shadow hover:bg-gray-50 text-indigo-600 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Vocab Test Tab -->
            <div id="vocabtest" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">词汇强化训练</h2>
                    <div class="space-x-2">
                        <button onclick="app.checkAnswers('vocab')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow"><i class="fas fa-check-circle mr-1"></i> 检查答案</button>
                        <button onclick="app.generateNewQuestions('vocab')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow"><i class="fas fa-magic mr-1"></i> AI生成新题</button>
                    </div>
                </div>
                <div id="vocab-test-container" class="space-y-6"></div>
            </div>

        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader mb-4 border-t-indigo-600"></div>
            <p class="text-gray-700 font-medium">AI 正在生成内容，请稍候...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <div id="error-content" class="text-gray-800"></div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            console.error(msg, error);
            document.body.innerHTML += '<div style="color:red; background:white; padding:10px; border:1px solid red; margin:10px;">Javascript Error: ' + msg + ' (Line ' + line + ')</div>'; 
        };

        // --- 1. CONFIG & DATA ---
        // Separate Keys for better security/management
        // If Secure Mode was used, these will be empty strings.
        let GOOGLE_TTS_KEY = ""; 
        let GOOGLE_LLM_KEY = "";
        const OPENROUTER_KEY = "";
        
        // Settings
        const TTS_VOICE_NAME = "en-US-Journey-D";
        const TTS_LANG_CODE = "en-US";
        const LLM_MODEL = "gemini-2.5-flash";
        
        // Data injected from JSON
        const dialogueData = [{"en":"So I just picked up the blue and the orange puffer yesterday.","cn":"所以我昨天刚拿了蓝色和橙色的吸入器。"},{"en":"But I'm not quite clear how to use them.","cn":"但我不太清楚怎么使用它们。"},{"en":"Sure, I can try to take you through that.","cn":"当然，我可以尝试带你了解一下。"},{"en":"First of all, thank you for giving me the opportunity to help you.","cn":"首先，谢谢你给我这个机会帮助你。"},{"en":"So you have got a blue puffer and an orange puffer.","cn":"所以你有一个蓝色吸入器和一个橙色吸入器。"},{"en":"A few things you need to know just for your information.","cn":"有几件事你需要知道，仅供参考。"},{"en":"The blue puffer is a reliever inhaler.","cn":"蓝色吸入器是缓解吸入器。"},{"en":"You use it when you feel short of breath or wheezy.","cn":"当你感到呼吸急促或喘息时使用它。"},{"en":"Basically for quick relief.","cn":"基本上是为了快速缓解症状。"},{"en":"The orange puffer is a preventer inhaler.","cn":"橙色吸入器是预防吸入器。"},{"en":"You use it every day even if you feel fine.","cn":"即使你感觉良好，也要每天使用它。"},{"en":"Because it reduces inflammation in your lungs and helps prevent asthma attacks.","cn":"因为它能减少肺部炎症并有助于预防哮喘发作。"},{"en":"Now the steps to use both are pretty similar.","cn":"现在，两者的使用步骤非常相似。"},{"en":"Always keep your face upright.","cn":"始终保持面部直立。"},{"en":"Open the mouthpiece and shake the inhaler well.","cn":"打开咬嘴并充分摇晃吸入器。"},{"en":"Seal your mouth around it.","cn":"用嘴紧紧包住它。"},{"en":"Spray and inhale deeply at the same time.","cn":"喷药的同时深吸气。"},{"en":"For the blue puffer usually one puff is enough when you need it.","cn":"对于蓝色吸入器，通常在你需要时喷一下就足够了。"},{"en":"For the orange puffer you might need two puffs with a short pause in between.","cn":"对于橙色吸入器，你可能需要喷两下，中间稍微停顿一下。"},{"en":"This helps it work better.","cn":"这有助于它更好地发挥作用。"},{"en":"Always remember when you inhale deeply keep your mouth shut around the mouthpiece for at least ten seconds.","cn":"永远记住，深吸气后，闭嘴含住咬嘴至少十秒钟。"},{"en":"Also if you haven't used either inhaler for more than fourteen days.","cn":"另外，如果你超过十四天没有使用任何一个吸入器。"},{"en":"Or if it is your first time using it spray a few puffs into the air first to prime it.","cn":"或者如果是第一次使用，先向空气中喷几下以进行预灌注。"},{"en":"That way the correct dose comes out when you use it.","cn":"这样当你使用时，出来的剂量才是正确的。"},{"en":"When you use both inhalers together I suggest using the blue puffer first.","cn":"当你同时使用两个吸入器时，我建议先使用蓝色吸入器。"},{"en":"Use it at least five minutes before the orange puffer.","cn":"至少在橙色吸入器之前五分钟使用它。"},{"en":"That opens your airways so the orange puffer medicine can reach your lungs better.","cn":"那样可以打开你的气道，使橙色吸入器的药物能更好地到达肺部。"},{"en":"Have you noticed any papery feeling in your mouth or a burning sensation?","cn":"你有没有注意到嘴里有纸一样的感觉或灼烧感？"},{"en":"So after using the orange puffer it is a good idea to rinse your mouth.","cn":"所以在使用橙色吸入器后，漱口是个好主意。"},{"en":"This helps prevent a fungal infection called oral thrush.","cn":"这有助于预防一种叫做口腔鹅口疮的真菌感染。"},{"en":"Just as a service can we try to call you within a week or so?","cn":"作为一项服务，我们可以尝试在一周左右给你打电话吗？"},{"en":"To make sure the inhalers are working fine for you.","cn":"以确保吸入器对你有效。"}];
        const knowledgePoints = [{"cat":"Medical Device","exTrans":"去徒步旅行前别忘了带上你的吸入器。","ipa":""},{"cat":"Medical Device","exTrans":"这种药可以作为缓解头痛的止痛药。","ipa":""},{"cat":"Symptom","exTrans":"跑上楼梯后，他感到呼吸急促。","ipa":""},{"cat":"Symptom","exTrans":"当花粉浓度高时，我的胸部感觉有点喘。","ipa":""},{"cat":"Medical Term","exTrans":"冰袋立刻缓解了肿胀。","ipa":""},{"cat":"Medical Device","exTrans":"你必须每天服用预防药物以避免病情发作。","ipa":""},{"cat":"Medical Condition","exTrans":"医生给了我一些药丸来减轻我膝盖的炎症。","ipa":""},{"cat":"Medical Condition","exTrans":"儿童哮喘通常随着孩子长大而好转。","ipa":""},{"cat":"Action/Posture","exTrans":"降落时请保持座椅直立。","ipa":""},{"cat":"Device Part","exTrans":"每次练习后都要清洁乐器的吹嘴。","ipa":""},{"cat":"Action","exTrans":"确保把袋子封紧以保持食物新鲜。","ipa":""},{"cat":"Action","exTrans":"吸入化学烟雾是危险的。","ipa":""},{"cat":"Adverb","exTrans":"她深呼吸以平复情绪。","ipa":""},{"cat":"Noun","exTrans":"一股烟从烟囱里冒了出来。","ipa":""},{"cat":"Action","exTrans":"他在回答问题前停顿了很长时间。","ipa":""},{"cat":"Action","exTrans":"你需要先给泵注水，它才能工作。","ipa":""},{"cat":"Medical Term","exTrans":"不要超过这种药物的推荐剂量。","ipa":""},{"cat":"Body Part","exTrans":"烟雾会刺激你的气道并引起咳嗽。","ipa":""},{"cat":"Noun","exTrans":"因为寒冷，我的脚趾失去了所有知觉。","ipa":""},{"cat":"Action","exTrans":"用冷水彻底冲洗蔬菜。","ipa":""},{"cat":"Medical Condition","exTrans":"脚气是一种常见的真菌感染。","ipa":""},{"cat":"Medical Condition","exTrans":"保持伤口清洁以防止感染。","ipa":""},{"cat":"Medical Condition","exTrans":"婴儿有时会患口腔鹅口疮。","ipa":""},{"cat":"General","exTrans":"这份工作对你的职业生涯来说是一个很好的机会。","ipa":""},{"cat":"Adverb","exTrans":"确保门已正确关闭。","ipa":""}];
        const cultureData = [{"en":"In Canada and many Western countries, pharmacists do more than just dispense medication. They are key healthcare providers who offer detailed consultations on how to use devices like inhalers properly. They often perform 'medication reviews' to ensure patients understand their treatment, check for side effects, and improve adherence. It is common for them to follow up with patients, as seen in the dialogue, to ensure the treatment is effective.","cn":"在加拿大和许多西方国家，药剂师不仅仅是分发药物。他们是关键的医疗保健提供者，提供关于如何正确使用吸入器等设备的详细咨询。他们经常进行“药物审查”，以确保患者了解他们的治疗方案，检查副作用并提高依从性。正如对话中所示，他们对患者进行回访以确保治疗有效是很常见的。"}]; // Fallback handled in logic
        
        const flashcardsData = {"group_1":[{"front":"puffer (n.) /'pʌfər/","back":"吸入器（口语）"},{"front":"reliever (n.) /rɪ'liːvər/","back":"缓解剂"},{"front":"short of breath (phr.) /ʃɔːrt əv brɛθ/","back":"呼吸急促"},{"front":"wheezy (adj.) /'wiːzi/","back":"喘息的"},{"front":"relief (n.) /rɪ'liːf/","back":"缓解"},{"front":"preventer (n.) /prɪ'vɛntər/","back":"预防剂"},{"front":"inflammation (n.) /ˌɪnflə'meɪʃən/","back":"炎症"},{"front":"asthma (n.) /'æzmə/","back":"哮喘"},{"front":"upright (adj.) /'ʌpraɪt/","back":"直立的"},{"front":"mouthpiece (n.) /'maʊθpiːs/","back":"咬嘴"},{"front":"seal (v.) /siːl/","back":"封闭；紧闭"},{"front":"inhale (v.) /ɪn'heɪl/","back":"吸气"},{"front":"deeply (adv.) /'diːpli/","back":"深深地"},{"front":"puff (n.) /pʌf/","back":"喷；吸（一口）"},{"front":"pause (n.) /pɔːz/","back":"停顿"},{"front":"prime (v.) /praɪm/","back":"预灌（使准备好）"},{"front":"dose (n.) /doʊs/","back":"剂量"},{"front":"airways (n.) /'ɛrweɪz/","back":"气道"},{"front":"sensation (n.) /sɛn'seɪʃən/","back":"感觉"},{"front":"rinse (v.) /rɪns/","back":"冲洗；漱口"},{"front":"fungal (adj.) /'fʌŋɡəl/","back":"真菌的"},{"front":"infection (n.) /ɪn'fɛkʃən/","back":"感染"},{"front":"oral thrush (n. phr.) /'ɔːrəl θrʌʃ/","back":"口腔鹅口疮"},{"front":"opportunity (n.) /ˌɒpər'tuːnɪti/","back":"机会"},{"front":"properly (adv.) /'prɒpərli/","back":"正确地"}],"group_2":[{"front":"吸入器（口语）","back":"puffer (n.) /'pʌfər/"},{"front":"缓解剂","back":"reliever (n.) /rɪ'liːvər/"},{"front":"呼吸急促","back":"short of breath (phr.) /ʃɔːrt əv brɛθ/"},{"front":"喘息的","back":"wheezy (adj.) /'wiːzi/"},{"front":"缓解","back":"relief (n.) /rɪ'liːf/"},{"front":"预防剂","back":"preventer (n.) /prɪ'vɛntər/"},{"front":"炎症","back":"inflammation (n.) /ˌɪnflə'meɪʃən/"},{"front":"哮喘","back":"asthma (n.) /'æzmə/"},{"front":"直立的","back":"upright (adj.) /'ʌpraɪt/"},{"front":"咬嘴","back":"mouthpiece (n.) /'maʊθpiːs/"},{"front":"封闭；紧闭","back":"seal (v.) /siːl/"},{"front":"吸气","back":"inhale (v.) /ɪn'heɪl/"},{"front":"深深地","back":"deeply (adv.) /'diːpli/"},{"front":"喷；吸（一口）","back":"puff (n.) /pʌf/"},{"front":"停顿","back":"pause (n.) /pɔːz/"},{"front":"预灌（使准备好）","back":"prime (v.) /praɪm/"},{"front":"剂量","back":"dose (n.) /doʊs/"},{"front":"气道","back":"airways (n.) /'ɛrweɪz/"},{"front":"感觉","back":"sensation (n.) /sɛn'seɪʃən/"},{"front":"冲洗；漱口","back":"rinse (v.) /rɪns/"},{"front":"真菌的","back":"fungal (adj.) /'fʌŋɡəl/"},{"front":"感染","back":"infection (n.) /ɪn'fɛkʃən/"},{"front":"口腔鹅口疮","back":"oral thrush (n. phr.) /'ɔːrəl θrʌʃ/"},{"front":"机会","back":"opportunity (n.) /ˌɒpər'tuːnɪti/"},{"front":"正确地","back":"properly (adv.) /'prɒpərli/"}],"group_3":[{"front":"Don't forget to pack your puffer before we go hiking.","back":"去徒步旅行前别忘了带上你的吸入器。"},{"front":"This medicine acts as a pain reliever for headaches.","back":"这种药可以作为缓解头痛的止痛药。"},{"front":"He felt short of breath after running up the stairs.","back":"跑上楼梯后，他感到呼吸急促。"},{"front":"My chest feels a bit wheezy when the pollen count is high.","back":"当花粉浓度高时，我的胸部感觉有点喘。"},{"front":"The ice pack provided immediate relief from the swelling.","back":"冰袋立刻缓解了肿胀。"},{"front":"You must take the preventer medication daily to avoid flare-ups.","back":"你必须每天服用预防药物以避免病情发作。"},{"front":"The doctor gave me pills to reduce the inflammation in my knee.","back":"医生给了我一些药丸来减轻我膝盖的炎症。"},{"front":"Childhood asthma often improves as kids get older.","back":"儿童哮喘通常随着孩子长大而好转。"},{"front":"Please keep your seat in an upright position for landing.","back":"降落时请保持座椅直立。"},{"front":"Clean the mouthpiece of your instrument after every practice.","back":"每次练习后都要清洁乐器的吹嘴。"},{"front":"Make sure to seal the bag tightly to keep the food fresh.","back":"确保把袋子封紧以保持食物新鲜。"},{"front":"It is dangerous to inhale chemical fumes.","back":"吸入化学烟雾是危险的。"},{"front":"She breathed deeply to calm her nerves.","back":"她深呼吸以平复情绪。"},{"front":"A puff of smoke came out of the chimney.","back":"一股烟从烟囱里冒了出来。"},{"front":"There was a long pause before he answered the question.","back":"他在回答问题前停顿了很长时间。"},{"front":"You need to prime the pump with water before it will work.","back":"你需要先给泵注水，它才能工作。"},{"front":"Do not exceed the recommended dose of this medicine.","back":"不要超过这种药物的推荐剂量。"},{"front":"Smoke can irritate your airways and cause coughing.","back":"烟雾会刺激你的气道并引起咳嗽。"},{"front":"I lost all sensation in my toes because of the cold.","back":"因为寒冷，我的脚趾失去了所有知觉。"},{"front":"Rinse the vegetables thoroughly under cold water.","back":"用冷水彻底冲洗蔬菜。"},{"front":"Athletes foot is a common fungal infection.","back":"脚气是一种常见的真菌感染。"},{"front":"Keep the wound clean to prevent infection.","back":"保持伤口清洁以防止感染。"},{"front":"Babies sometimes develop oral thrush.","back":"婴儿有时会患口腔鹅口疮。"},{"front":"This job is a great opportunity for your career.","back":"这份工作对你的职业生涯来说是一个很好的机会。"},{"front":"Make sure the door is closed properly.","back":"确保门已正确关闭。"}],"group_4":[{"front":"去徒步旅行前别忘了带上你的吸入器。","back":"Don't forget to pack your puffer before we go hiking."},{"front":"这种药可以作为缓解头痛的止痛药。","back":"This medicine acts as a pain reliever for headaches."},{"front":"跑上楼梯后，他感到呼吸急促。","back":"He felt short of breath after running up the stairs."},{"front":"当花粉浓度高时，我的胸部感觉有点喘。","back":"My chest feels a bit wheezy when the pollen count is high."},{"front":"冰袋立刻缓解了肿胀。","back":"The ice pack provided immediate relief from the swelling."},{"front":"你必须每天服用预防药物以避免病情发作。","back":"You must take the preventer medication daily to avoid flare-ups."},{"front":"医生给了我一些药丸来减轻我膝盖的炎症。","back":"The doctor gave me pills to reduce the inflammation in my knee."},{"front":"儿童哮喘通常随着孩子长大而好转。","back":"Childhood asthma often improves as kids get older."},{"front":"降落时请保持座椅直立。","back":"Please keep your seat in an upright position for landing."},{"front":"每次练习后都要清洁乐器的吹嘴。","back":"Clean the mouthpiece of your instrument after every practice."},{"front":"确保把袋子封紧以保持食物新鲜。","back":"Make sure to seal the bag tightly to keep the food fresh."},{"front":"吸入化学烟雾是危险的。","back":"It is dangerous to inhale chemical fumes."},{"front":"她深呼吸以平复情绪。","back":"She breathed deeply to calm her nerves."},{"front":"一股烟从烟囱里冒了出来。","back":"A puff of smoke came out of the chimney."},{"front":"他在回答问题前停顿了很长时间。","back":"There was a long pause before he answered the question."},{"front":"你需要先给泵注水，它才能工作。","back":"You need to prime the pump with water before it will work."},{"front":"不要超过这种药物的推荐剂量。","back":"Do not exceed the recommended dose of this medicine."},{"front":"烟雾会刺激你的气道并引起咳嗽。","back":"Smoke can irritate your airways and cause coughing."},{"front":"因为寒冷，我的脚趾失去了所有知觉。","back":"因为寒冷，我的脚趾失去了所有知觉。"},{"front":"用冷水彻底冲洗蔬菜。","back":"Rinse the vegetables thoroughly under cold water."},{"front":"脚气是一种常见的真菌感染。","back":"Athletes foot is a common fungal infection."},{"front":"保持伤口清洁以防止感染。","back":"Keep the wound clean to prevent infection."},{"front":"婴儿有时会患口腔鹅口疮。","back":"Babies sometimes develop oral thrush."},{"front":"这份工作对你的职业生涯来说是一个很好的机会。","back":"This job is a great opportunity for your career."},{"front":"确保门已正确关闭。","back":"Make sure the door is closed properly."}]}; // Explicit Flashcards
        
        let listeningQuestions = [{"type":"mc","q":"What is the primary function of the blue puffer?","options":["A. To prevent asthma attacks daily","B. To reduce inflammation over time","C. To provide quick relief when short of breath","D. To clean the lungs"],"ans":"C. To provide quick relief when short of breath"},{"type":"tf","q":"You should use the orange puffer only when you feel sick.","options":["A. True","B. False"],"ans":"B. False"},{"type":"fill","q":"The orange puffer acts as a _____ inhaler to reduce inflammation.","options":[],"ans":"preventer"},{"type":"mc","q":"How long should you hold your breath after inhaling the medicine?","options":["A. 5 seconds","B. At least 10 seconds","C. 30 seconds","D. 2 minutes"],"ans":"B. At least 10 seconds"},{"type":"mc","q":"Why should you use the blue puffer before the orange one?","options":["A. To prime the inhaler","B. To open the airways so the medicine reaches the lungs better","C. To prevent oral thrush","D. Because the orange one tastes bad"],"ans":"B. To open the airways so the medicine reaches the lungs better"},{"type":"tf","q":"You need to rinse your mouth after using the blue puffer to prevent infection.","options":["A. True","B. False"],"ans":"B. False"},{"type":"fill","q":"If you haven't used the inhaler for 14 days, you should spray it into the air to _____ it.","options":[],"ans":"prime"},{"type":"mc","q":"What is 'oral thrush' mentioned in the text?","options":["A. A type of asthma attack","B. A fungal infection in the mouth","C. A broken mouthpiece","D. A side effect of the blue puffer"],"ans":"B. A fungal infection in the mouth"},{"type":"dict","q":"Listen and write down the sentence about priming.","options":[],"ans":"Spray a few puffs into the air first to prime it.","srcText":"Spray a few puffs into the air first to prime it."},{"type":"mc","q":"How many puffs might you need for the orange puffer?","options":["A. Always one","B. Two puffs with a pause in between","C. Five puffs rapidly","D. None if you feel fine"],"ans":"B. Two puffs with a pause in between"}]; 
        let vocabQuestions = [{"type":"fill","q":"You should _____ the inhaler to ensure the mechanism is ready for the first use.","options":[],"ans":"prime"},{"type":"mc","q":"Which word describes a feeling or physical awareness?","options":["A. Sensation","B. Puffer","C. Dose","D. Prevention"],"ans":"A. Sensation"},{"type":"mc","q":"What is the opposite of 'exhale'?","options":["A. Rinse","B. Inhale","C. Seal","D. Prime"],"ans":"B. Inhale"},{"type":"fill","q":"Please keep your seat _____ during takeoff and landing.","options":[],"ans":"upright"},{"type":"mc","q":"If something causes 'oral thrush', what type of issue is it?","options":["A. A viral issue","B. A fungal infection","C. A bacterial problem","D. An injury"],"ans":"B. A fungal infection"},{"type":"fill","q":"The doctor prescribed a daily _____ to stop the asthma attacks before they start.","options":[],"ans":"preventer"},{"type":"tf","q":"A 'dose' refers to the specific amount of medicine taken at one time.","options":["A. True","B. False"],"ans":"A. True"},{"type":"mc","q":"Which part of the device do you put in your mouth?","options":["A. Canister","B. Mouthpiece","C. Seal","D. Dial"],"ans":"B. Mouthpiece"},{"type":"fill","q":"After brushing your teeth, you should _____ your mouth with water.","options":[],"ans":"rinse"},{"type":"mc","q":"If you are 'short of breath', you are having trouble doing what?","options":["A. Walking","B. Breathing","C. Sleeping","D. Eating"],"ans":"B. Breathing"},{"type":"fill","q":"The swelling was caused by _____ in the joint.","options":[],"ans":"inflammation"},{"type":"mc","q":"Which word means 'correctly' or 'in the right way'?","options":["A. Deeply","B. Properly","C. Wheezy","D. Rarely"],"ans":"B. Properly"},{"type":"fill","q":"He took a deep _____ on his cigarette.","options":[],"ans":"puff"},{"type":"mc","q":"What is a common slang term for an inhaler?","options":["A. Blower","B. Puffer","C. Breather","D. Sprayer"],"ans":"B. Puffer"},{"type":"fill","q":"We need to _____ the envelope so the letter doesn't fall out.","options":[],"ans":"seal"},{"type":"tf","q":"'Wheezy' describes a clear and quiet breathing sound.","options":["A. True","B. False"],"ans":"B. False"},{"type":"fill","q":"This medication brings fast _____ from pain.","options":[],"ans":"relief"},{"type":"mc","q":"What are the tubes that carry air into your lungs called?","options":["A. Veins","B. Airways","C. Esophagus","D. Nerves"],"ans":"B. Airways"},{"type":"fill","q":"Thank you for the _____ to interview for this position.","options":[],"ans":"opportunity"},{"type":"mc","q":"Which of these is a respiratory condition?","options":["A. Asthma","B. Diabetes","C. Arthritis","D. Migraine"],"ans":"A. Asthma"},{"type":"fill","q":"Take a short _____ between exercises to catch your breath.","options":[],"ans":"pause"},{"type":"mc","q":"If something is 'fungal', what causes it?","options":["A. A virus","B. A fungus","C. Bacteria","D. Dust"],"ans":"B. A fungus"},{"type":"fill","q":"She inhaled _____ to smell the fresh flowers.","options":[],"ans":"deeply"},{"type":"tf","q":"A 'reliever' medication is designed to stop symptoms quickly.","options":["A. True","B. False"],"ans":"A. True"},{"type":"fill","q":"Clean the wound to stop any _____ from spreading.","options":[],"ans":"infection"}];

        // --- RUNTIME KEY CHECK (Secure Mode) ---
        function checkRuntimeKeys() {
            if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                // Try LocalStorage
                // Load separately
                if (!GOOGLE_LLM_KEY) GOOGLE_LLM_KEY = localStorage.getItem('user_gemini_key') || '';
                if (!GOOGLE_TTS_KEY) GOOGLE_TTS_KEY = localStorage.getItem('user_tts_key') || '';
                
                // If still missing either, prompt
                if (!GOOGLE_TTS_KEY || !GOOGLE_LLM_KEY) {
                    showSettingsModal();
                }
            }
        }

        function showSettingsModal() {
            // Create Modal if not exists
            if (!document.getElementById('settings-modal')) {
                const modal = document.createElement('div');
                modal.id = 'settings-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800"><i class="fas fa-shield-alt text-indigo-600 mr-2"></i>Secure Mode</h2>
                        <p class="text-gray-600 mb-6 text-sm">This page is in Secure Mode. Please enter your own API Keys to enable AI and Voice features.</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Gemini API Key (AI):</label>
                            <input type="password" id="runtime-gemini-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Cloud TTS API Key (Voice):</label>
                            <input type="password" id="runtime-tts-key" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                            <div class="mt-2 flex items-center gap-2">
                                <input type="checkbox" id="use-same-key" onchange="toggleSameKey()" class="cursor-pointer">
                                <label for="use-same-key" class="text-xs text-gray-600 cursor-pointer">Use Gemini Key for both (if enabled)</label>
                            </div>
                        </div>
                        
                        <button onclick="saveRuntimeKey()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Save & Continue</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Pre-fill if we have partial keys
                if(localStorage.getItem('user_gemini_key')) document.getElementById('runtime-gemini-key').value = localStorage.getItem('user_gemini_key');
                if(localStorage.getItem('user_tts_key')) document.getElementById('runtime-tts-key').value = localStorage.getItem('user_tts_key');

            } else {
                document.getElementById('settings-modal').classList.remove('hidden');
            }
        }
        
        window.toggleSameKey = function() {
            const same = document.getElementById('use-same-key').checked;
            const ttsInput = document.getElementById('runtime-tts-key');
            const geminiInput = document.getElementById('runtime-gemini-key');
            
            if (same) {
                ttsInput.value = geminiInput.value;
                ttsInput.disabled = true;
                ttsInput.classList.add('bg-gray-100');
            } else {
                ttsInput.disabled = false;
                ttsInput.classList.remove('bg-gray-100');
            }
        };

        window.saveRuntimeKey = function() {
            const geminiInput = document.getElementById('runtime-gemini-key');
            const ttsInput = document.getElementById('runtime-tts-key');
            const same = document.getElementById('use-same-key').checked;
            
            let geminiKey = geminiInput.value.trim();
            // If checking same key, ensure we copy it
            let ttsKey = same ? geminiKey : ttsInput.value.trim();
            
            if (!geminiKey && !ttsKey) {
                alert('Please enter at least one API Key.');
                return;
            }
            
            if (geminiKey) {
                localStorage.setItem('user_gemini_key', geminiKey);
                GOOGLE_LLM_KEY = geminiKey;
            }
            if (ttsKey) {
                localStorage.setItem('user_tts_key', ttsKey);
                GOOGLE_TTS_KEY = ttsKey;
            }
            
            document.getElementById('settings-modal').classList.add('hidden');
            alert('Keys saved successfully!');
        };

        // --- 2. APP CLASS ---
        class EnglishApp {
            constructor() {
                // Check Keys on Init
                checkRuntimeKeys();

                this.state = {
                    showCN: true,
                    showEN: true,
                    dictationMode: false,
                    cultureShowCN: false,
                    cultureShowEN: true,
                    cardIndex: 0,
                    cardMode: 0,
                    audioCache: new Map() // Runtime cache
                };
                
                this.init();
            }

            init() {
                this.renderDialogue();
                this.renderCulture();
                this.renderKnowledge();
                this.updateCard();
                
                // Initial Questions Generation if empty (async)
                if (listeningQuestions.length > 0) {
                    this.renderQuestions('listening-container', listeningQuestions, 'list');
                } else {
                     document.getElementById('listening-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始练习</div>';
                }
                
                if (vocabQuestions.length > 0) {
                     this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                } else {
                     document.getElementById('vocab-test-container').innerHTML = '<div class="text-center p-8 text-gray-500">点击右上角 "AI生成新题" 开始词汇测试</div>';
                }
            }
            
            // --- TAB LOGIC ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                    el.classList.add('text-gray-500');
                });
                document.getElementById(tabId).classList.add('active');
                const btn = document.getElementById('btn-' + tabId);
                btn.classList.add('active', 'border-indigo-600', 'text-indigo-600', 'border-b-2');
                btn.classList.remove('text-gray-500');
            }

            // --- MATERIAL TAB ---
            toggleCN() { this.state.showCN = !this.state.showCN; this.renderDialogue(); }
            toggleEN() { this.state.showEN = !this.state.showEN; this.renderDialogue(); }
            toggleDictation() { this.state.dictationMode = !this.state.dictationMode; this.renderDialogue(); }
            
            renderDialogue() {
                const container = document.getElementById('dialogue-container');
                container.innerHTML = '';
                dialogueData.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-white border rounded-lg p-4 hover:shadow-md transition";
                    let html = `<div class="flex items-start gap-3">
                        <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 transition flex-shrink-0">
                            <i class="fas fa-volume-up text-lg"></i>
                        </button>
                        <div class="flex-1 w-full">`;

                    if (this.state.dictationMode) {
                        html += `
                        <div class="flex flex-col gap-2 w-full">
                            <div class="flex items-center gap-2">
                                <button onclick="app.playAudio('${line.en.replace(/'/g, "\\'")}')" class="text-indigo-600 mr-2"><i class="fas fa-play"></i></button>
                                <input type="text" id="dict-input-${index}" class="w-full border-2 border-gray-200 rounded p-2 focus:border-indigo-500 outline-none" placeholder="听录音并输入...">
                                <button onclick="app.checkDictationLine(${index})" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded font-bold hover:bg-indigo-200">检查</button>
                            </div>
                            <div id="dict-res-${index}" class="hidden mt-2">
                                <p class="text-indigo-700 font-medium">${line.en}</p>
                                <p class="text-gray-500 text-sm mt-1">${line.cn}</p>
                            </div>
                        </div>`;
                    } else {
                        html += `<p class="text-lg font-medium text-gray-800 en-text leading-relaxed ${this.state.showEN ? '' : 'hidden'}" id="en-line-${index}">${line.en}</p>`;
                        
                        if (this.state.showCN) {
                            html += `<div class="flex items-center mt-2">
                                <p class="text-gray-600 cn-text flex-1">${line.cn}</p>
                                <button onclick="document.getElementById('en-line-${index}').classList.toggle('hidden')" class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">EN</button>
                            </div>`;
                        } else {
                            html += `<div class="flex items-center mt-2 hidden cn-text"><p class="text-gray-600 flex-1">${line.cn}</p></div>`;
                        }
                    }
                    html += `</div></div>`;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }

            checkDictationLine(index) {
                const input = document.getElementById(`dict-input-${index}`);
                const resDiv = document.getElementById(`dict-res-${index}`);
                const target = dialogueData[index].en.trim().replace(/[.,!?;:]/g, "").toLowerCase();
                const userVal = input.value.trim().replace(/[.,!?;:]/g, "").toLowerCase();

                resDiv.classList.remove('hidden');
                if (userVal === target) {
                    input.classList.add('border-green-500', 'bg-green-50');
                    input.classList.remove('border-red-500', 'bg-red-50');
                } else {
                    input.classList.add('border-red-500', 'bg-red-50');
                    input.classList.remove('border-green-500', 'bg-green-50');
                }
            }

            // --- CULTURE TAB ---
            toggleCultureCN() { this.state.cultureShowCN = !this.state.cultureShowCN; this.renderCulture(); }
            toggleCultureEN() { this.state.cultureShowEN = !this.state.cultureShowEN; this.renderCulture(); }
            
            renderCulture() {
                const container = document.getElementById('culture-container');
                container.innerHTML = '';
                if(cultureData.length === 0) container.innerHTML = "<p>暂无文化背景内容</p>";
                
                cultureData.forEach((item) => {
                    const pEn = document.createElement('p');
                    pEn.className = `text-gray-800 mb-2 ${this.state.cultureShowEN ? '' : 'hidden'}`;
                    pEn.textContent = item.en;
                    const pCn = document.createElement('p');
                    pCn.className = `text-gray-500 mb-6 text-sm ${this.state.cultureShowCN ? '' : 'hidden'}`;
                    pCn.textContent = item.cn;
                    container.appendChild(pEn);
                    container.appendChild(pCn);
                });
            }

            // --- KNOWLEDGE TAB ---
            renderKnowledge() {
                const tbody = document.getElementById('knowledge-table-body');
                tbody.innerHTML = '';
                knowledgePoints.forEach(k => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-200 hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${k.cat}</td>
                        <td class="py-3 px-4 font-bold text-indigo-700">
                            <div class="flex items-center gap-2">${k.point}
                                <button onclick="app.playAudio('${k.point.replace(/'/g, "\\'")}')" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="text-xs text-gray-400 font-normal mt-1">${k.ipa || ''}</div>
                        </td>
                        <td class="py-3 px-4">${k.cn}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-start gap-2">
                                <button onclick="app.playAudio('${(k.ex || '').replace(/'/g, "\\'")}')" class="mt-1 text-gray-400 hover:text-indigo-600 flex-shrink-0 text-xs"><i class="fas fa-volume-up"></i></button>
                                <div><p>${k.ex || ''}</p><p class="text-gray-400 text-xs mt-1">${k.exTrans || ''}</p></div>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            // --- FLASHCARDS ---
            // --- FLASHCARDS ---
            setCardMode(mode) {
                this.state.cardMode = mode;
                // Reset card index when switching modes
                this.state.cardIndex = 0;
                
                document.querySelectorAll('.mode-btn').forEach(b => {
                    // Match integer or string comparison safely
                    if(parseInt(b.dataset.mode) === mode) {
                        b.classList.remove('bg-gray-200', 'text-gray-700');
                        b.classList.add('bg-indigo-600', 'text-white');
                    } else {
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-indigo-600', 'text-white');
                    }
                });
                this.updateCard();
            }
            
            getFlashcardData() {
                // Return Current List based on Mode
                // Mode 0: group_1 (EN -> CN)
                // Mode 1: group_2 (CN -> EN)
                // Mode 2: group_3 (Sent -> Trans)
                // Mode 3: group_4 (Trans -> Sent)
                if (flashcardsData) {
                    if (this.state.cardMode === 0) return flashcardsData.group_1 || [];
                    if (this.state.cardMode === 1) return flashcardsData.group_2 || [];
                    if (this.state.cardMode === 2) return flashcardsData.group_3 || [];
                    if (this.state.cardMode === 3) return flashcardsData.group_4 || [];
                    return [];
                }
                
                // Fallback: Generate from Knowledge Points (Legacy logic)
                return knowledgePoints.map(item => {
                   if (this.state.cardMode === 0) return { front: item.point, frontSub: item.cat, back: item.cn, backSub: item.ex };
                   if (this.state.cardMode === 1) return { front: item.cn, frontSub: item.cat, back: item.point, backSub: item.ipa }; 
                   if (this.state.cardMode === 2) return { front: item.ex, frontSub: "例句", back: item.exTrans, backSub: item.point };
                   if (this.state.cardMode === 3) return { front: item.exTrans, frontSub: "翻译", back: item.ex, backSub: item.point };
                   return {};
                });
            }
            
            updateCard() {
                const currentList = this.getFlashcardData();
                const item = currentList[this.state.cardIndex];
                
                if (!item) {
                     // Empty state
                     document.getElementById('card-counter').innerText = "0 / 0";
                     return;
                }
                
                document.getElementById('card-counter').innerText = `${this.state.cardIndex + 1} / ${currentList.length}`;
                
                // Front / Back Data
                // If using explicit flashcardsData, item has {front, back} keys.
                // We need to support "sub" text if available or auto-detect IPA? 
                // The example JSON puts IPA in the string: "skillet (n.) /.../"
                
                const front = document.getElementById('card-front-text');
                const frontSub = document.getElementById('card-front-sub');
                const back = document.getElementById('card-back-text');
                const backSub = document.getElementById('card-back-sub');
                
                // Reset flip
                document.querySelector('.card-container').classList.remove('flipped');
                
                // Render Logic
                if (flashcardsData) {
                     // Explicit JSON data
                     // Try to format: "Word (type) /ipa/" -> Word <br> (type) <br> /ipa/
                     // Matches: (Any text) followed by ( (..)) followed by ( /../)
                     const raw = item.front;
                     // Regex to split: Group 1: Word, Group 2: (type), Group 3: /ipa/
                     // This assumes the format "word (pos) /ipa/"
                     const match = raw.match(/^(.*?)\s+(\(.*\))\s+(\/.*\/)$/);
                     
                     if (match) {
                         front.innerHTML = `<div class="text-4xl mb-2">${match[1]}</div><div class="text-xl text-indigo-200">${match[2]}</div><div class="text-lg opacity-75 font-mono">${match[3]}</div>`;
                     } else {
                         // Try simplified: just word and type?
                         const match2 = raw.match(/^(.*?)\s+(\(.*\))$/);
                         if (match2) {
                             front.innerHTML = `<div class="text-4xl mb-2">${match2[1]}</div><div class="text-xl text-indigo-200">${match2[2]}</div>`;
                         } else {
                             // Fallback
                             front.innerText = raw;
                         }
                     }

                     frontSub.innerText = ""; // Cleared because we handled it above
                     
                     back.innerText = item.back;
                     backSub.innerText = ""; 
                } else {
                     // Legacy mapped data
                     front.innerText = item.front;
                     frontSub.innerText = item.frontSub;
                     back.innerText = item.back;
                     backSub.innerText = item.backSub;
                }
            }
            
            flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
            nextCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex < list.length - 1) { this.state.cardIndex++; this.updateCard(); } 
                else { this.state.cardIndex = 0; this.updateCard(); } 
            }
            prevCard() { 
                const list = this.getFlashcardData();
                if (this.state.cardIndex > 0) { this.state.cardIndex--; this.updateCard(); } 
                else { this.state.cardIndex = list.length - 1; this.updateCard(); } 
            }
            
            playCardAudio(e, side) {
                e.stopPropagation();
                const list = this.getFlashcardData();
                const item = list[this.state.cardIndex];
                
                // Logic: Try to play simple text. 
                // If explicit data, we might need to extract the "word" from "word (n.) /ipa/"
                // Simple regex to take the first word or the whole thing?
                // Let's try whole string first. Smart TTS often handles mixed text okay, 
                // but "skillet (n.) /skɪlɪt/" might be read weirdly.
                // Better heuristic: Extract text before " (" or "/"
                
                let textToPlay = (side === 'front' ? item.front : item.back);
                
                // Clean up for TTS: remove (...) and /.../
                // Double escape backslashes for template literal generation
                textToPlay = textToPlay.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                
                // Requirement: "Don't pronounce Chinese"
                // Detect Chinese char? 
                if (/[\u4e00-\u9fa5]/.test(textToPlay)) {
                    // Try the other side? Or just don't play?
                    // "Corresponding English pronunciation"
                    // If side is Chinese, we want the English.
                    // In group_2 (CN->EN), Front is CN, Back is EN. If clicked Front (CN), play Back (EN).
                    const otherText = (side === 'front' ? item.back : item.front);
                    const cleanOther = otherText.replace(/\(.*\)/g, '').replace(/\/[^/]*\//g, '').trim();
                     if (!/[\u4e00-\u9fa5]/.test(cleanOther)) {
                         textToPlay = cleanOther;
                     } else {
                         return; // Both might be Chinese? Unlikely in this app.
                     }
                }

                this.playAudio(textToPlay);
            }

            // --- AUDIO & AI ---
            async playAudio(text) {
                if(!text) return;
               
                if (this.state.audioCache.has(text)) {
                    this.playBlob(this.state.audioCache.get(text));
                    return;
                }

                if(!GOOGLE_TTS_KEY) { 
                     // Fallback to browser TTS if no key
                     console.warn("No Google TTS Key. Using Browser Fallback.");
                     const uttr = new SpeechSynthesisUtterance(text);
                     uttr.lang = TTS_LANG_CODE;
                     window.speechSynthesis.speak(uttr);
                     return; 
                }

                try {
                    const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`;
                    const payload = {
                        input: { text: text },
                        voice: { languageCode: TTS_LANG_CODE, name: TTS_VOICE_NAME },
                        audioConfig: { audioEncoding: "MP3" }
                    };
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if(!response.ok) throw new Error("TTS API Error");
                    
                    const data = await response.json();
                    if(data.audioContent) {
                        const blob = this.base64ToBlob(data.audioContent, 'audio/mp3');
                        const blobUrl = URL.createObjectURL(blob);
                        this.state.audioCache.set(text, blobUrl);
                        this.playBlob(blobUrl);
                    }
                } catch(e) { console.error(e); alert("TTS Error: " + e.message); }
            }
            
            playBlob(url) {
                const p = document.getElementById('audio-player');
                p.src = url;
                p.play();
            }

            async playFullAudio(source) {
                let text = "";
                if (source === 'dialogue') text = dialogueData.map(d => d.en).join(" ");
                else if (source === 'culture') text = cultureData.map(d => d.en).join(" ");
                
                await this.playAudio(text);
            }

            base64ToBlob(base64, type) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for(let i=0; i<byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
                return new Blob([new Uint8Array(byteNumbers)], {type: type});
            }

            // --- AI GENERATION ---
            async generateNewQuestions(type) {
                if(!GOOGLE_LLM_KEY) { this.showError("Gemini API Key missing. Please check your extension settings and regenerate the page."); return; }
                const loader = document.getElementById('loading-modal');
                loader.classList.remove('hidden');

                try {
                    let prompt = "";
                    if (type === 'listening') {
                        prompt = `Based on this text: "${dialogueData.map(d => d.en).join(' ')}".Generate 10 NEW English listening questions in strictly valid JSON format. `;
                        prompt += `Types: "mc"(multiple choice), "tf"(true / false), "fill"(fill in blank), "dict"(dictation).Key names: type, q, options(for mc), ans(answer), srcText(for dictation target).Format: [{ "type": "mc", "q": "..", "options": ["A", "B"], "ans": "A" }]`;
                    } else {
                        const words = knowledgePoints.map(k => k.point).join(", ");
                        prompt = `Based on words: ${ words }. Generate 15 NEW vocab questions in strictly valid JSON.Types: mc, tf, fill.Format: [{ "type": "mc", "q": "Meaning of X?", "options": ["A", "B"], "ans": "A" }]`;
                    }

                    const jsonRes = await this.callLLM(prompt);
                    if (jsonRes && Array.isArray(jsonRes)) {
                        if (type === 'listening') {
                            listeningQuestions = jsonRes;
                            this.renderQuestions('listening-container', listeningQuestions, 'list');
                        } else {
                            vocabQuestions = jsonRes;
                            this.renderQuestions('vocab-test-container', vocabQuestions, 'vocab');
                        }
                        alert('New questions generated!');
                    } else {
                        throw new Error('Invalid JSON from AI');
                    }

                } catch(e) {
                    console.error(e);
                    this.showError(e.message);
                } finally {
                    loader.classList.add('hidden');
                }
            }

            showError(msg) {
                const modal = document.getElementById('error-modal');
                const content = document.getElementById('error-content');
                
                if (msg.includes("API has not been used") || msg.includes("is disabled")) {
                    content.innerHTML = `<p class="mb-4 text-red-600 font-bold">API Not Enabled</p>
                    <p class="mb-4">The Gemini API is not enabled for your project.</p>
                    <a href="https://console.developers.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 block text-center">Enable Gemini API (Google Cloud)</a>
                    <p class="mt-4 text-xs text-gray-500">Enable it, wait 1-2 minutes, and try again.</p>`;
                } else {
                    content.textContent = "Error: " + msg;
                }
                modal.classList.remove('hidden');
            }

            async callLLM(prompt) {
                // Use configured Model
                if (GOOGLE_LLM_KEY) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${GOOGLE_LLM_KEY}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error?.message || "Gemini API Error");
}

const data = await res.json();
let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
if (!text) throw new Error("No response from Gemini");
return this.parseJSON(text);
                }
throw new Error("No valid API Key");
            }

parseJSON(text) {
    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
    return JSON.parse(text);
}

renderQuestions(containerId, questions, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    questions.forEach((q, i) => {
        const div = document.createElement('div');
        div.className = "bg-white p-6 rounded-lg border border-gray-200 shadow-sm question-block mb-4";

        let html = `<div class="mb-3 font-semibold text-lg flex items-start gap-2"><span class="bg-indigo-100 text-indigo-700 py-1 px-2 rounded-md text-sm mt-1">Q${i + 1}</span> <span>${q.q}</span></div>`;

                    if (q.type === 'dict' && q.srcText) {
                        html += `<button onclick="app.playAudio('${q.srcText.replace(/'/g, "\\'")}')" class="mb-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full hover:bg-yellow-200 transition flex items-center w-fit"><i class="fas fa-play mr-2"></i> 播放句子</button>`;
                    }
                    
                    html += '<div class="space-y-2 mt-2">';
                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            html += `<div onclick="app.selectOption(this)" class="block p-3 rounded border hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition select-option">${opt}</div>`;
                        });
                    } else if (q.type === 'tf') {
                        html += `<div class="flex gap-4"><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">True</button><button onclick="app.selectOption(this)" class="px-6 py-2 border rounded hover:bg-indigo-50 select-option">False</button></div>`;
                    } else {
                        html += `<input type="text" placeholder="Your Answer..." class="w-full p-2 border rounded focus:border-indigo-500 outline-none user-ans-input">`;
                    }
                    html += `</div>
                    <div class="hidden mt-4 p-3 bg-gray-50 rounded text-sm text-green-700 font-bold answer-box">Answer: ${q.ans}</div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });
            }
            
            selectOption(el) {
                // Find siblings and remove active state
                const parent = el.parentElement;
                parent.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                     opt.classList.add('hover:bg-indigo-50');
                });
                // Add active state
                el.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-900', 'selected');
                el.classList.remove('hover:bg-indigo-50');
                
                // Add basic validation visual (optional, or wait for check)
                // For now just select.
                
                // We also need to set the value for checking? 
                // Currently user-ans-input is for text. For MC/TF, we check class 'selected'?
                el.classList.add('user-selected');
            }

            checkAnswers(type) {
                const container = document.getElementById(type === 'listening' ? 'listening-container' : 'vocab-test-container');
                const blocks = container.querySelectorAll('.question-block');
                
                blocks.forEach(block => {
                     const ansBox = block.querySelector('.answer-box');
                     ansBox.classList.remove('hidden');
                     const correctAns = ansBox.textContent.split('Answer: ')[1].trim().toLowerCase();
                     
                     // Text input
                     const input = block.querySelector('input');
                     if(input) {
                         const val = input.value.trim().toLowerCase();
                         if(val === correctAns) { input.classList.add('border-green-500', 'bg-green-50'); }
                         else { input.classList.add('border-red-500', 'bg-red-50'); }
                     }
                     
                     // MC / TF Buttons
                     const selected = block.querySelector('.selected');
                     if(selected) {
                         const val = selected.textContent.trim().toLowerCase();
                         // Check if selected starts with "A. " or similar? Example options: "A. Word"
                         // Or "True"
                         // Usually answer key is "A" or "True".
                         
                         let match = false;
                         if (val === correctAns) match = true;
                         // Handle "A. Option" vs "A"
                         else if (val.startsWith(correctAns + ".") || val.startsWith(correctAns + " ")) match = true;
                         
                         if(match) {
                             selected.classList.add('bg-green-200', 'border-green-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         } else {
                             selected.classList.add('bg-red-200', 'border-red-600');
                             selected.classList.remove('bg-indigo-100', 'border-indigo-500');
                         }
                     }
                });
            }

        }

        const app = new EnglishApp();
    </script>
</body>
</html>